# 设计目标文档

## 当前理解

### 核心概念
- **ASR输入员（后台输入员）**：通过语音识别输入文本，通过前端按钮控制
- **前端输入员（键盘输入）**：通过键盘输入和编辑文本，随时可用
- **两个输入员平等协作**：可以同时工作，通过操作转换系统协调

### 当前实现状态
- ✅ ASR控制独立（启动/暂停/停止）
- ✅ 键盘输入随时可用
- ✅ 保存按钮独立（只有前端输入员可以操作）
- ✅ 操作转换系统（OT）协调两个输入源

## 需要确认的设计目标

### 1. 工作模式

#### 1.1 ASR输入员的工作模式
- [ ] **问题**：ASR启动后，是否立即开始输入？还是需要用户说话才开始？
- [ ] **问题**：ASR暂停时，已输入的文本如何处理？是否保留？
- [ ] **问题**：ASR停止时，是否清空ASR缓冲区？还是保留已输入的内容？

#### 1.2 前端输入员的工作模式
- [x] **已确认**：键盘输入随时可用，不需要"开始记录"
- [ ] **问题**：清空按钮的行为？是否清空所有内容（包括ASR输入）？
- [ ] **问题**：前端输入员编辑时，ASR输入如何处理？（当前：延迟应用）

### 2. 保存机制

#### 2.1 保存时机
- [x] **已确认**：只有前端输入员可以点击保存按钮
- [ ] **问题**：保存时，ASR如果正在运行，是否自动停止？
- [ ] **问题**：保存后，是否清空当前编辑区？还是保留内容？
- [ ] **问题**：保存后，ASR状态如何处理？（保持运行/停止/重置）

#### 2.2 保存内容
- [ ] **问题**：保存的内容是什么？
  - 选项A：合并后的最终文本（ASR + 键盘输入）
  - 选项B：分别保存ASR文本和键盘输入文本
  - 选项C：保存时用户编辑的版本（可能包含ASR输入）

### 3. 状态管理

#### 3.1 状态定义
- [x] **已确认**：ASR状态独立管理（idle/recording/paused/processing）
- [ ] **问题**：是否需要"记录会话"状态？
  - 如果需要：什么情况下开始/结束会话？
  - 如果不需要：如何区分"正在编辑"和"空闲"状态？

#### 3.2 状态显示
- [ ] **问题**：状态栏应该显示什么？
  - ASR状态（后台输入员）
  - 编辑状态（前端输入员）
  - 两者都显示？

### 4. 用户体验

#### 4.1 输入体验
- [x] **已确认**：用户正在输入时，ASR输入延迟应用（不打断用户）
- [ ] **问题**：延迟时间是否可配置？（当前：1.5秒）
- [ ] **问题**：是否有视觉提示显示"有ASR输入待应用"？（当前：有）

#### 4.2 编辑体验
- [ ] **问题**：ASR输入和键盘输入是否有视觉区分？
  - 选项A：无区分，统一显示
  - 选项B：用不同颜色/样式区分
  - 选项C：显示输入来源标记

#### 4.3 冲突处理
- [x] **已确认**：使用操作转换系统协调冲突
- [ ] **问题**：冲突解决策略是否需要调整？
  - 当前：用户操作优先
  - 是否需要其他策略？

### 5. 功能边界

#### 5.1 ASR功能
- [x] **已确认**：ASR可以独立启动/暂停/停止
- [ ] **问题**：ASR停止后，是否可以重新启动？（当前：可以）
- [ ] **问题**：ASR是否可以多次启动/停止？（创建多个会话？）

#### 5.2 编辑功能
- [x] **已确认**：键盘输入随时可用
- [ ] **问题**：是否需要"撤销/重做"功能？
- [ ] **问题**：是否需要"格式化"功能？（当前：有工具栏但未实现）

#### 5.3 保存功能
- [x] **已确认**：保存按钮只有前端输入员可以操作
- [ ] **问题**：保存是否需要确认对话框？
- [ ] **问题**：保存失败时的处理策略？

### 6. 数据流

#### 6.1 ASR数据流
```
ASR Provider → FastAPI Server → WebSocket → App.tsx → BlockEditor → Block
```
- [x] **已确认**：ASR数据通过WebSocket实时推送
- [ ] **问题**：ASR数据是否需要缓存？（当前：有缓冲区）

#### 6.2 键盘数据流
```
Block → BlockEditor → App.tsx → (同步到后端，如果ASR运行)
```
- [x] **已确认**：键盘输入实时更新
- [ ] **问题**：键盘输入是否需要实时同步到后端？（当前：只在ASR运行时同步）

### 7. 错误处理

#### 7.1 ASR错误
- [ ] **问题**：ASR启动失败时的处理？
- [ ] **问题**：ASR运行时出错的处理？
- [ ] **问题**：网络断开时的处理？

#### 7.2 保存错误
- [ ] **问题**：保存失败时的处理？
- [ ] **问题**：是否需要重试机制？

## 建议的设计目标

### 核心原则
1. **两个输入员平等**：ASR和键盘输入地位平等，可以同时工作
2. **用户优先**：用户正在输入时，ASR输入不打断
3. **简单直观**：操作流程清晰，状态明确
4. **数据安全**：保存机制可靠，数据不丢失

### 推荐方案

#### 方案A：简单模式（推荐）
- ASR：启动后立即开始输入，暂停保留内容，停止保留内容
- 键盘：随时可用，无状态
- 保存：保存合并后的最终文本，保存后不清空，ASR状态保持
- 状态：只显示ASR状态

#### 方案B：会话模式
- 引入"记录会话"概念
- 会话开始后，两个输入员开始工作
- 保存时结束会话，清空内容
- 状态：显示会话状态和ASR状态

#### 方案C：完全独立模式
- ASR和键盘完全独立
- 保存时可以选择保存哪个输入源的内容
- 状态：分别显示两个输入源的状态

## 下一步

请确认：
1. 选择哪个方案？或提出新的方案？
2. 回答上述关键问题
3. 确定优先级和边界

