# 语音笔记翻译功能测试指南

## 功能概述

语音笔记现在支持多语言互译功能，可以将笔记内容在不同语言之间进行翻译。

## 支持的语言对

- 中文 → 英文 (zh-en)
- 中文 → 日文 (zh-ja)
- 中文 → 韩文 (zh-ko)
- 英文 → 中文 (en-zh)
- 日文 → 中文 (ja-zh)
- 韩文 → 中文 (ko-zh)

## 测试步骤

### 1. 启动服务

```bash
# 确保在项目根目录
cd /Users/wangjunhui/playcode/语音桌面助手

# 启动后端和前端
./quick_start.sh
```

### 2. 创建测试笔记

1. 打开语音笔记应用
2. 点击"开始工作"
3. 输入一些测试文本，例如：
   ```
   今天和团队讨论了新功能的开发计划。
   决定使用React框架重构前端。
   张三负责设计，李四负责开发。
   预计下周一完成第一版。
   ```

### 3. 测试翻译功能

#### 测试场景 1：中文翻译成英文

1. 在顶部工具栏找到语言选择器（📄 原文）
2. 点击打开下拉菜单
3. 选择"中文→英文"
4. 等待翻译完成（会显示 loading 状态）
5. 翻译完成后，编辑器中会显示英文翻译

**预期结果**：
- 原文被翻译成流畅的英文
- 专业术语（如 React）保持不变
- 人名使用拼音（Zhang San, Li Si）

#### 测试场景 2：切换回原文

1. 点击语言选择器
2. 选择"原文"
3. **预期结果**：立即显示原始中文文本（不需要重新翻译）

#### 测试场景 3：切换到其他语言

1. 点击语言选择器
2. 选择"中文→日文"
3. 等待翻译完成
4. **预期结果**：显示日文翻译

#### 测试场景 4：修改原文后重新翻译

1. 切换到"原文"模式
2. 修改某个段落的内容
3. 点击编辑器外部（失焦）
4. 切换到"中文→英文"
5. **预期结果**：
   - 已翻译的段落显示缓存的翻译
   - 修改后的段落显示原文（因为翻译缓存失效）
   - 可以重新选择语言触发批量翻译

### 4. 测试边界情况

#### 测试空内容
1. 创建新笔记（内容为空）
2. 尝试切换语言
3. **预期结果**：语言选择器处于禁用状态

#### 测试 ASR 写入中
1. 启动语音识别
2. 在识别过程中尝试切换语言
3. **预期结果**：可以切换语言，新识别的文本显示原文

#### 测试图片块
1. 在笔记中粘贴图片
2. 切换到翻译语言
3. **预期结果**：图片正常显示，不受翻译影响

#### 测试小结块
1. 生成小结
2. 切换到翻译语言
3. **预期结果**：小结块不被翻译（被过滤掉）

### 5. 测试数据持久化

1. 创建笔记并翻译
2. 点击"EXIT"退出笔记会话
3. 从历史记录中恢复笔记
4. **预期结果**：
   - 原文正确恢复
   - 翻译缓存也被保存，切换语言时立即显示

### 6. 检查 API 调用

打开浏览器开发者工具，检查网络请求：

#### 批量翻译请求
```
POST http://127.0.0.1:8765/api/translate/batch
Request Body:
{
  "texts": ["今天和团队讨论了...", "决定使用React..."],
  "source_lang": "zh",
  "target_lang": "en"
}

Response:
{
  "success": true,
  "translations": ["Today we discussed...", "Decided to use React..."]
}
```

### 7. 检查控制台日志

后端日志应该显示：
```
[TranslationAgent] 开始翻译: zh -> en, 长度=XX
[TranslationAgent] 批量翻译完成: X 条
```

前端控制台应该显示：
```
[VoiceNote] 批量翻译完成
```

## 已知限制

1. **翻译缓存策略**：
   - 翻译结果缓存在 Block 的 `translations` 字段中
   - 修改原文后，翻译缓存不会自动更新
   - 需要重新选择语言触发批量翻译

2. **翻译范围**：
   - 仅翻译普通文本块
   - 不翻译笔记信息块（note-info）
   - 不翻译小结块（summary）
   - 不翻译缓冲块（buffer）

3. **性能考虑**：
   - 批量翻译会依次翻译每个 block
   - 大量文本可能需要较长时间
   - 翻译过程中会显示 loading 状态

## 故障排查

### 问题 1：点击语言选择器没有反应
- **检查**：是否有内容？空笔记的语言选择器是禁用的
- **解决**：输入一些文本后再试

### 问题 2：翻译失败
- **检查**：后端日志是否有错误
- **可能原因**：
  - LLM 服务未启动或配置错误
  - API Key 无效或过期
  - 网络连接问题
- **解决**：检查 `config.yml` 中的 LLM 配置

### 问题 3：翻译结果不准确
- **检查**：使用的 LLM 模型是否支持多语言
- **建议**：使用 40B+ 参数的大模型以获得更好的翻译质量

### 问题 4：翻译后切换回原文显示错误
- **可能原因**：`getBlockDisplayContent` 逻辑问题
- **检查**：浏览器控制台是否有错误
- **解决**：确保 `selectedLanguage` 状态正确传递

## 测试清单

- [ ] 中文翻译成英文
- [ ] 中文翻译成日文
- [ ] 中文翻译成韩文
- [ ] 英文翻译成中文
- [ ] 日文翻译成中文
- [ ] 韩文翻译成中文
- [ ] 切换回原文
- [ ] 翻译缓存有效
- [ ] 空内容时语言选择器禁用
- [ ] ASR 过程中可切换语言
- [ ] 图片块不受翻译影响
- [ ] 小结块不被翻译
- [ ] 数据持久化正确
- [ ] API 请求格式正确
- [ ] 后端日志正常
- [ ] 前端控制台无错误

## 反馈建议

如果测试过程中发现问题，请记录：
1. 操作步骤
2. 预期结果
3. 实际结果
4. 错误信息（控制台 + 后端日志）
5. 截图（如果适用）

---

**创建时间**: 2026-01-04  
**功能版本**: v1.0.0  
**测试人员**: 请在测试后填写

