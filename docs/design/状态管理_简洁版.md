# è¯­éŸ³ç¬”è®° - çŠ¶æ€ç®¡ç†æ ¸å¿ƒé€»è¾‘

## ğŸ¯ æ ¸å¿ƒè®¾è®¡åŸåˆ™

**ä»¥ `currentWorkingRecordId` ä¸ºä¸­å¿ƒçš„çŠ¶æ€ç®¡ç†**

```typescript
currentWorkingRecordId: string | null

// null = æ²¡æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼ˆæ˜¾ç¤ºæ¬¢è¿ç•Œé¢ï¼‰
// string = æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡ï¼ˆå¯ä»¥æ¢å¤ï¼‰
```

---

## ğŸ“Š ä¸‰ç§å·¥ä½œçŠ¶æ€

### 1. Idleï¼ˆç©ºé—²ï¼‰
```typescript
currentWorkingRecordId: null
workSessionState: 'idle'
activeView: 'voice-note'
```
- **æ˜¾ç¤º**: æ¬¢è¿ç•Œé¢
- **æ“ä½œ**: ç‚¹å‡»"å¼€å§‹å·¥ä½œ"æˆ–ç›´æ¥è¾“å…¥

### 2. Workingï¼ˆå·¥ä½œä¸­ï¼‰
```typescript
currentWorkingRecordId: "uuid-xxx"
workSessionState: 'working'
activeView: 'voice-note'
asrState: 'idle' | 'recording' | 'stopping'
```
- **æ˜¾ç¤º**: BlockEditor ç¼–è¾‘å™¨
- **è‡ªåŠ¨ä¿å­˜**: æŒç»­ä¿å­˜åˆ°è¿™ä¸ª recordId

### 3. Pausedï¼ˆæš‚åœï¼‰
```typescript
currentWorkingRecordId: "uuid-xxx"  // â† å…³é”®ï¼šä¿ç•™ä»»åŠ¡ID
workSessionState: 'paused'
activeView: 'history' | 'settings' | ...
```
- **æ˜¾ç¤º**: å…¶ä»–è§†å›¾
- **ä»»åŠ¡IDä¸æ¸…ç©º**: è¡¨ç¤ºè¿˜åœ¨è¿™ä¸ªä»»åŠ¡ä¸Š
- **è¿”å›æ—¶**: è‡ªåŠ¨æ¢å¤

---

## ğŸ”„ çŠ¶æ€è½¬æ¢

### å¼€å§‹å·¥ä½œ
```
ç”¨æˆ·è¾“å…¥ / ç‚¹å‡»"å¼€å§‹å·¥ä½œ"
  â†“
currentWorkingRecordId: null
workSessionState: 'idle'
  â†“
é¦–æ¬¡ä¿å­˜æ—¶ï¼Œåç«¯è¿”å› recordId
  â†“
currentWorkingRecordId: "uuid-xxx"
workSessionState: 'working'
```

### åˆ‡æ¢è§†å›¾ï¼ˆæš‚åœï¼‰
```
ç”¨æˆ·åˆ‡æ¢åˆ°å…¶ä»–è§†å›¾
  â†“
ä¿å­˜å½“å‰å†…å®¹ (trigger='view_switch')
  â†“
currentWorkingRecordId: ä¿æŒä¸å˜ â† å…³é”®ï¼
workSessionState: 'working' â†’ 'paused'
activeView: 'voice-note' â†’ 'history'
```

### è¿”å›è¯­éŸ³ç¬”è®°ï¼ˆæ¢å¤ï¼‰
```
ç”¨æˆ·è¿”å›è¯­éŸ³ç¬”è®°
  â†“
æ£€æŸ¥ currentWorkingRecordId
  â†“
if (currentWorkingRecordId !== null) {
  // æœ‰æ­£åœ¨è¿›è¡Œçš„ä»»åŠ¡
  è°ƒç”¨ autoSave.recover(currentWorkingRecordId)
  æ¢å¤ blocks å’Œ noteInfo
  workSessionState: 'paused' â†’ 'working'
} else {
  // æ²¡æœ‰ä»»åŠ¡
  æ˜¾ç¤ºæ¬¢è¿ç•Œé¢
}
```

### EXITï¼ˆå®Œæˆä»»åŠ¡ï¼‰
```
ç”¨æˆ·ç‚¹å‡» EXIT
  â†“
ä¿å­˜æœ€ç»ˆç»“æœ
  â†“
currentWorkingRecordId: "uuid-xxx" â†’ null  â† æ¸…ç©ºï¼
workSessionState: 'working' â†’ 'idle'
initialBlocks: undefined
  â†“
æ˜¾ç¤ºæ¬¢è¿ç•Œé¢ï¼ˆå…¨æ–°å¼€å§‹ï¼‰
```

---

## ğŸ”‘ å…³é”®åˆ¤æ–­é€»è¾‘

### æ˜¯å¦çœŸæ­£åœ¨å·¥ä½œï¼Ÿ
```typescript
const isReallyWorking = 
  workSessionState === 'working' || 
  asrState === 'recording' || 
  asrState === 'stopping' ||
  currentWorkingRecordId !== null;
```

### æ˜¯å¦å¯ä»¥åˆ‡æ¢è§†å›¾ï¼Ÿ
```typescript
if (asrState === 'recording') {
  // âŒ ASR æ­£åœ¨å½•éŸ³ï¼Œä¸èƒ½åˆ‡æ¢
  return;
}
// âœ… å…¶ä»–æƒ…å†µéƒ½å¯ä»¥åˆ‡æ¢
```

### æ˜¯å¦æ˜¾ç¤ºæ¬¢è¿ç•Œé¢ï¼Ÿ
```typescript
const showWelcome = 
  !isWorkSessionActive || 
  currentWorkingRecordId === null;
```

---

## ğŸ’¾ è‡ªåŠ¨ä¿å­˜é€»è¾‘

### é¦–æ¬¡ä¿å­˜ï¼ˆåˆ›å»ºè®°å½•ï¼‰
```typescript
POST /api/text/save
{
  text: "...",
  app_type: "voice-note",
  metadata: { blocks, noteInfo, ... }
}

å“åº”: { record_id: "uuid-xxx" }

// å›è°ƒè§¦å‘
onRecordIdCreated("uuid-xxx")
  â†“
setCurrentWorkingRecordId("uuid-xxx")
```

### åç»­ä¿å­˜ï¼ˆæ›´æ–°è®°å½•ï¼‰
```typescript
PUT /api/records/{currentWorkingRecordId}
{
  text: "...",
  app_type: "voice-note",
  metadata: { blocks, noteInfo, ... }
}

// currentWorkingRecordId ä¿æŒä¸å˜
```

---

## ğŸ”„ æ¢å¤é€»è¾‘

### recover() æ–¹æ³•ç­¾å
```typescript
async recover(recordId: string): Promise<any | null>
```

**å‚æ•°**: `recordId` å¿…éœ€ï¼Œæ˜ç¡®æŒ‡å®šè¦æ¢å¤çš„è®°å½•

**ä¸å†éœ€è¦**:
- âŒ `recoverTimeLimit`ï¼ˆæ—¶é—´é™åˆ¶ï¼‰
- âŒ æŸ¥æ‰¾"æœ€è¿‘çš„è®°å½•"
- âŒ æ—¶é—´åˆ¤æ–­é€»è¾‘

**åŸå› **: 
- `currentWorkingRecordId` å·²ç»æ˜ç¡®äº†è¦æ¢å¤å“ªä¸ªä»»åŠ¡
- ä¸é™æ—¶é—´ï¼Œå³ä½¿å‡ å¤©å‰çš„ä»»åŠ¡ä¹Ÿå¯ä»¥æ¢å¤
- çŠ¶æ€ç®¡ç†ç”± App å±‚æ§åˆ¶ï¼Œä¸åœ¨ AutoSave å±‚åˆ¤æ–­

### æ¢å¤ä¼˜å…ˆçº§
```typescript
1. localStorage ä¸´æ—¶æ•°æ®ï¼ˆ5åˆ†é’Ÿå†… && æ¯”æ•°æ®åº“æ›´æ–°ï¼‰
   â†“
2. æ•°æ®åº“è®°å½•ï¼ˆæŒ‡å®šçš„ recordIdï¼‰
```

---

## ğŸ“ ç”¨æˆ·åœºæ™¯

### åœºæ™¯ 1: ä¸´æ—¶åˆ‡æ¢è§†å›¾
```
[Working] æ­£åœ¨ç¼–è¾‘ï¼š"ä¼šè®®è®°å½•..."
  â†“
åˆ‡æ¢åˆ° Historyï¼ˆæŸ¥çœ‹æ—§ç¬”è®°ï¼‰
  â†“
[Paused] currentWorkingRecordId ä¿ç•™
  â†“
è¿”å› Voice Note
  â†“
[Working] è‡ªåŠ¨æ¢å¤ï¼š"ä¼šè®®è®°å½•..."
```

### åœºæ™¯ 2: EXIT åé‡æ–°å¼€å§‹
```
[Working] æ­£åœ¨ç¼–è¾‘ï¼š"ä»Šå¤©çš„ç¬”è®°"
  â†“
ç‚¹å‡» EXIT
  â†“
[Idle] currentWorkingRecordId = null
  â†“
æ˜¾ç¤ºæ¬¢è¿ç•Œé¢
  â†“
å¼€å§‹æ–°ä»»åŠ¡
  â†“
[Working] å…¨æ–°çš„ recordId
```

### åœºæ™¯ 3: ä»å†å²è®°å½•æ¢å¤
```
[Idle] æ˜¾ç¤ºæ¬¢è¿ç•Œé¢
  â†“
å» Historyï¼Œç‚¹å‡»"æ¢å¤"
  â†“
loadRecord(recordId)
  â†“
setCurrentWorkingRecordId(recordId)
startWorkSession('voice-note', recordId)
  â†“
[Working] æ¢å¤æ—§ä»»åŠ¡
```

---

## ğŸ¤ ASR çŠ¶æ€çš„ä½œç”¨

### ASR å¯åŠ¨æ—¶è‡ªåŠ¨å¼€å§‹å·¥ä½œ
```typescript
handleAsrStart() {
  if (!isWorkSessionActive) {
    // å¦‚æœè¿˜æ²¡å¼€å§‹å·¥ä½œï¼Œè‡ªåŠ¨å¯åŠ¨å·¥ä½œä¼šè¯
    startWorkSession('voice-note');
  }
  // å¯åŠ¨ ASR
}
```

### ASR å½•éŸ³ä¸­é˜»æ­¢åˆ‡æ¢è§†å›¾
```typescript
if (asrState === 'recording') {
  // âŒ ä¸èƒ½åˆ‡æ¢è§†å›¾
  toast('æ­£åœ¨å½•éŸ³ä¸­ï¼Œè¯·å…ˆåœæ­¢å½•éŸ³');
  return;
}
```

---

## âš™ï¸ é…ç½®å‚æ•°ï¼ˆç®€åŒ–åï¼‰

```typescript
const DEFAULT_CONFIG = {
  localStorageInterval: 1000,      // 1ç§’
  dbSaveDebounce: 3000,            // 3ç§’
  longEditThreshold: 30000,        // 30ç§’
  periodicSaveInterval: 60000,     // 60ç§’
  volatileDataPriority: 300000,    // 5åˆ†é’Ÿ
  
  // âŒ å·²åˆ é™¤ï¼šrecoverTimeLimit
};
```

---

## ğŸ” è°ƒè¯•è¦ç‚¹

### å…³é”®æ—¥å¿—
```typescript
console.log('[çŠ¶æ€]', {
  currentWorkingRecordId,
  workSessionState,
  asrState,
  isReallyWorking,
  activeView
});
```

### çŠ¶æ€ä¸€è‡´æ€§æ£€æŸ¥
```typescript
// âœ… æ­£ç¡®
currentWorkingRecordId: "uuid-xxx"
workSessionState: 'working' | 'paused'

// âŒ é”™è¯¯
currentWorkingRecordId: null
workSessionState: 'working'  // ä¸åº”è¯¥æœ‰è¿™ç§çŠ¶æ€
```

---

## âœ¨ è®¾è®¡ä¼˜åŠ¿

1. **çŠ¶æ€æ˜ç¡®**: `currentWorkingRecordId` æ˜¯å”¯ä¸€çœŸç›¸æ¥æº
2. **ä¸é™æ—¶é—´**: ä¸ä¾èµ–æ—¶é—´åˆ¤æ–­ï¼Œä»»ä½•æ—¶å€™éƒ½å¯ä»¥æ¢å¤æŒ‡å®šä»»åŠ¡
3. **é€»è¾‘ç®€å•**: æœ‰IDå°±æ¢å¤ï¼Œæ²¡IDå°±æ–°å»º
4. **ç”¨æˆ·å‹å¥½**: 
   - åˆ‡æ¢è§†å›¾è‡ªåŠ¨ä¿ç•™çŠ¶æ€
   - EXIT æ˜ç¡®ç»“æŸä»»åŠ¡
   - ä»å†å²è®°å½•å¯ä»¥æ¢å¤ä»»ä½•ä»»åŠ¡

---

## ğŸš€ å®ç°çŠ¶æ€

- âœ… `currentWorkingRecordId` çŠ¶æ€ç®¡ç†
- âœ… `workSessionState` (idle/working/paused)
- âœ… ASR çŠ¶æ€é›†æˆ
- âœ… è‡ªåŠ¨ä¿å­˜ä¸ recordId åŒæ­¥
- âœ… åˆ‡æ¢è§†å›¾ä¿ç•™çŠ¶æ€
- âœ… è¿”å›æ—¶è‡ªåŠ¨æ¢å¤
- âœ… EXIT æ¸…ç©ºçŠ¶æ€
- âœ… åˆ é™¤ `recoverTimeLimit` å‚æ•°
- âœ… ç®€åŒ– `recover()` æ–¹æ³•ç­¾å

