# 语音笔记状态管理 - 集成检查清单

## 📋 功能完成状态

### ✅ 1. Idle 状态（显示欢迎界面）
**状态**: ⚠️ 部分完成，需要修复

**当前实现**:
```typescript
const showWelcome = !isWorkSessionActive;
```

**问题**:
- ❌ 没有使用 `currentWorkingRecordId` 判断
- ❌ 没有使用 `workSessionState` 判断

**应该改为**:
```typescript
const showWelcome = 
  workSessionState === 'idle' && 
  currentWorkingRecordId === null;
```

**测试场景**:
- [x] EXIT 后显示欢迎界面
- [ ] 首次打开应用显示欢迎界面
- [ ] 下次启动时显示欢迎界面（没有 paused 任务）

---

### ⚠️ 2. EXIT 退出
**状态**: ✅ 已实现，但需要确认 `currentWorkingRecordId` 清空

**当前实现**:
```typescript
const exitWithSave = async () => {
  // ... 保存逻辑 ...
  endWorkSession();
}

const endWorkSession = () => {
  setCurrentWorkingRecordId(null);  // ✅ 已实现
  setWorkSessionState('idle');       // ✅ 已实现
  // ... 其他清理 ...
}
```

**需要验证**:
- [ ] EXIT 后 `currentWorkingRecordId` 确实为 null
- [ ] EXIT 后 `workSessionState` 确实为 'idle'
- [ ] 下次启动不会恢复

---

### ❌ 3. 创建新笔记
**状态**: ❌ 未集成新状态管理

**当前实现**:
```typescript
const createNewNote = async () => {
  // 保存当前笔记
  await save();
  
  // 清空内容
  setText('');
  setInitialBlocks([]);
  
  // ❌ 问题：没有处理 currentWorkingRecordId
  // ❌ 问题：没有重置 workSessionState
}
```

**应该改为**:
```typescript
const createNewNote = async () => {
  // 1. 如果有当前任务，先保存
  if (currentWorkingRecordId) {
    await voiceNoteAutoSave.saveToDatabase('manual', true);
  }
  
  // 2. 清空状态，开始新任务
  setCurrentWorkingRecordId(null);      // 清空任务ID
  voiceNoteAutoSave.reset();             // 重置 AutoSave
  setInitialBlocks(undefined);           // 清空 blocks
  setText('');
  
  // 3. 保持工作会话（用户可以继续输入）
  setWorkSessionState('working');
  
  setToast({ message: '已开始新笔记', type: 'success' });
}
```

---

### ✅ 4. 数据库保存
**状态**: ✅ 已完成

**实现**:
```typescript
// 首次保存时创建 recordId
new AutoSaveService('voice-note', adapter, undefined, {
  onRecordIdCreated: (recordId) => {
    setCurrentWorkingRecordId(recordId);  // ✅
  }
});

// 后续保存使用同一个 recordId
voiceNoteAutoSave.saveToDatabase('edit_complete', false);
```

**验证**:
- [x] 首次保存创建 recordId
- [x] `currentWorkingRecordId` 自动更新
- [x] 后续保存使用同一个 recordId
- [x] metadata 包含完整的 blocks 和 noteInfo

---

### ⚠️ 5. 历史记录恢复
**状态**: ⚠️ 部分完成，需要更新

**当前实现**:
```typescript
const loadRecord = async (recordId: string) => {
  const response = await fetch(`${API_BASE_URL}/api/records/${recordId}`);
  const data = await response.json();
  
  if (data.metadata?.blocks) {
    setInitialBlocks(data.metadata.blocks);
  }
  
  setActiveView('voice-note');
  startWorkSession('voice-note');  // ❌ 没有传递 recordId
}
```

**应该改为**:
```typescript
const loadRecord = async (recordId: string) => {
  console.log('[历史记录] 恢复记录:', recordId);
  
  try {
    // 使用 AutoSave 恢复
    const recoveredData = await voiceNoteAutoSave.recover(recordId);
    
    if (recoveredData && recoveredData.blocks) {
      // 设置当前工作ID
      setCurrentWorkingRecordId(recordId);
      
      // 恢复 blocks
      setInitialBlocks(recoveredData.blocks);
      
      // 切换到语音笔记并启动工作会话
      setActiveView('voice-note');
      startWorkSession('voice-note', recordId);  // ✅ 传递 recordId
      
      setToast({ message: '已恢复笔记', type: 'success' });
    }
  } catch (e) {
    console.error('[历史记录] 恢复失败:', e);
    setToast({ message: '恢复失败', type: 'error' });
  }
}
```

---

### ⚠️ 6. 切换视图（暂停/恢复）
**状态**: ✅ 已实现

**实现**:
```typescript
// 离开语音笔记
if (activeView === 'voice-note' && newView !== 'voice-note') {
  if (isWorkSessionActive && currentWorkingRecordId) {
    await voiceNoteAutoSave.saveToDatabase('view_switch', true);
    pauseWorkSession();  // ✅ 保留 currentWorkingRecordId
  }
}

// 返回语音笔记
if (activeView !== 'voice-note' && newView === 'voice-note') {
  if (workSessionState === 'paused' && currentWorkingRecordId) {
    // ✅ 自动恢复
    const data = await voiceNoteAutoSave.recover(currentWorkingRecordId);
    setInitialBlocks(data.blocks);
    startWorkSession('voice-note', currentWorkingRecordId);
  }
}
```

**验证**:
- [x] 切换视图时保存
- [x] `currentWorkingRecordId` 保留
- [x] 返回时自动恢复
- [ ] 如果没有 paused 任务，显示欢迎界面

---

### ❌ 7. 应用启动时的状态恢复
**状态**: ❌ 未实现

**需要实现**:
```typescript
useEffect(() => {
  // 应用启动时检查是否有未完成的任务
  const savedWorkingRecordId = localStorage.getItem('currentWorkingRecordId');
  const savedWorkSessionState = localStorage.getItem('workSessionState');
  
  if (savedWorkingRecordId && savedWorkSessionState === 'paused') {
    // 有暂停的任务，询问用户是否恢复
    const shouldRecover = window.confirm('检测到未完成的笔记，是否恢复？');
    
    if (shouldRecover) {
      setCurrentWorkingRecordId(savedWorkingRecordId);
      setWorkSessionState('paused');
      // 用户返回语音笔记时会自动恢复
    } else {
      // 用户选择不恢复，清空状态
      localStorage.removeItem('currentWorkingRecordId');
      localStorage.removeItem('workSessionState');
    }
  }
}, []);
```

---

### ❌ 8. 状态持久化
**状态**: ❌ 未实现

**需要实现**:
```typescript
// 保存状态到 localStorage
useEffect(() => {
  if (currentWorkingRecordId) {
    localStorage.setItem('currentWorkingRecordId', currentWorkingRecordId);
    localStorage.setItem('workSessionState', workSessionState);
  } else {
    localStorage.removeItem('currentWorkingRecordId');
    localStorage.removeItem('workSessionState');
  }
}, [currentWorkingRecordId, workSessionState]);
```

---

## 🔧 需要修复的问题

### 优先级 P0（必须修复）

1. **❌ VoiceNote.tsx 的 showWelcome 判断**
   ```typescript
   // 当前
   const showWelcome = !isWorkSessionActive;
   
   // 应该改为
   const showWelcome = 
     !isWorkSessionActive && 
     currentWorkingRecordId === null;
   ```

2. **❌ createNewNote 函数**
   - 清空 `currentWorkingRecordId`
   - 重置 `voiceNoteAutoSave`
   - 设置 `workSessionState`

3. **❌ loadRecord 函数**
   - 设置 `currentWorkingRecordId`
   - 传递 `recordId` 给 `startWorkSession`

---

### 优先级 P1（建议修复）

4. **状态持久化**
   - 保存到 localStorage
   - 应用启动时恢复

5. **返回语音笔记时的逻辑**
   - 如果没有 paused 任务，显示欢迎界面
   - 不要尝试恢复不存在的记录

---

## 🧪 测试场景

### 场景 1: 首次使用
```
1. 打开应用
2. 进入语音笔记
期望: 显示欢迎界面 ✅
```

### 场景 2: 正常工作流程
```
1. 点击"开始工作"
2. 输入内容 → 自动保存
3. 切换到历史记录 → 保存并暂停
4. 返回语音笔记 → 自动恢复
期望: 内容完整恢复 ✅
```

### 场景 3: EXIT 退出
```
1. 正在编辑笔记
2. 点击 EXIT → 保存并清空状态
3. 返回语音笔记
期望: 显示欢迎界面（不恢复旧笔记）⚠️
```

### 场景 4: 创建新笔记
```
1. 正在编辑笔记
2. 点击"创建新笔记" → 保存当前笔记
3. 清空界面
期望: 可以开始全新的笔记 ❌
```

### 场景 5: 从历史记录恢复
```
1. 在历史记录中选择一条记录
2. 点击"恢复"
3. 自动切换到语音笔记
期望: 加载选中的记录，可以继续编辑 ⚠️
```

### 场景 6: 应用重启
```
1. 正在编辑笔记（有 currentWorkingRecordId）
2. 关闭应用
3. 重新打开应用
期望: 询问是否恢复未完成的笔记 ❌
```

---

## 📝 修复计划

### 第一步：修复 showWelcome 判断
- [ ] 更新 VoiceNote.tsx
- [ ] 传递 `currentWorkingRecordId` prop

### 第二步：修复 createNewNote
- [ ] 清空 `currentWorkingRecordId`
- [ ] 重置 AutoSave
- [ ] 更新状态

### 第三步：修复 loadRecord
- [ ] 设置 `currentWorkingRecordId`
- [ ] 使用 AutoSave.recover()
- [ ] 传递 recordId

### 第四步：状态持久化
- [ ] 保存到 localStorage
- [ ] 应用启动时恢复

### 第五步：完整测试
- [ ] 测试所有场景
- [ ] 修复发现的问题

