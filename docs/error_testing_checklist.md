# 错误处理系统 - 测试检查清单

## 测试准备
- [ ] 后端服务运行正常 (`python src/api/server.py`)
- [ ] 前端应用运行正常 (`cd electron-app && npm run dev`)
- [ ] 查看日志目录: `logs/` (应该有 app.log, errors.log, app.json)

## 高优先级测试 ✅

### 1. 音频设备错误 (测试 5 分钟)

#### 测试 1.1: 设备不存在
- [ ] 打开应用，进入语音记录
- [ ] (可选) 断开所有麦克风设备
- [ ] 点击"开始录音"
- [ ] **预期**: 显示错误 Banner: "未找到可用的音频设备" + 建议
- [ ] 检查日志: `logs/errors.log` 应包含 `AUDIO_DEVICE_NOT_FOUND` (1010)

#### 测试 1.2: 设备权限拒绝
- [ ] 系统设置 → 隐私 → 麦克风 → 关闭应用权限
- [ ] 点击"开始录音"
- [ ] **预期**: 显示错误 Toast: "麦克风权限被拒绝" + "请在系统设置中允许应用访问麦克风"
- [ ] 检查日志: 应包含 `AUDIO_DEVICE_PERMISSION_DENIED` (1012)

### 2. 网络连接错误 (测试 3 分钟)

#### 测试 2.1: API 服务不可用
- [ ] 停止后端服务
- [ ] 打开前端应用
- [ ] **预期**: 显示红色 Banner: "无法连接到 API 服务器" + 重试建议
- [ ] 检查控制台: 应显示 `API_SERVER_UNAVAILABLE` (1004)
- [ ] 重启后端服务
- [ ] **预期**: Banner 自动消失，连接恢复

#### 测试 2.2: WebSocket 断开重连
- [ ] 应用正常运行
- [ ] 停止后端服务
- [ ] 等待 3-5 秒
- [ ] **预期**: 显示 "WebSocket 连接已断开" 相关提示
- [ ] 重启后端服务
- [ ] **预期**: 自动重连成功

### 3. 数据存储错误 (测试 5 分钟)

#### 测试 3.1: 保存空内容
- [ ] 在语音记录界面，不录音直接点击"保存"
- [ ] **预期**: 显示错误 Toast: "内容为空，无法保存"
- [ ] 检查日志: 应包含 `STORAGE_INVALID_CONTENT` (2002)

#### 测试 3.2: 保存正常内容
- [ ] 录制一段语音或输入文本
- [ ] 点击"保存"
- [ ] **预期**: 显示成功 Toast: "保存成功"
- [ ] 切换到"历史记录"标签
- [ ] **预期**: 能看到刚才保存的记录

#### 测试 3.3: 加载历史记录
- [ ] 点击"历史记录"标签
- [ ] **预期**: 显示记录列表
- [ ] 停止后端服务
- [ ] 刷新页面或重新进入历史记录
- [ ] **预期**: 显示 "存储服务不可用" 错误

#### 测试 3.4: 删除记录
- [ ] 确保后端运行
- [ ] 在历史记录中选择一条记录
- [ ] 点击"删除"
- [ ] **预期**: 记录被删除，显示成功提示
- [ ] 尝试删除不存在的记录
- [ ] **预期**: 显示适当的错误提示

### 4. LLM 服务错误 (测试 10 分钟)

#### 测试 4.1: LLM 服务不可用
- [ ] 修改 `config.yml`，设置无效的 LLM provider
- [ ] 重启后端服务
- [ ] 在语音记录中录制内容
- [ ] 点击"生成小结"
- [ ] **预期**: 显示错误: "LLM 服务不可用"
- [ ] 检查日志: 应包含 `LLM_SERVICE_UNAVAILABLE` (1200)

#### 测试 4.2: LLM 认证失败
- [ ] 修改 `config.yml`，使用无效的 API Key
- [ ] 重启后端服务
- [ ] 点击"生成小结"
- [ ] **预期**: 显示错误: "LLM 认证失败" + "请检查 API 密钥"
- [ ] 检查日志: 应包含 `LLM_AUTH_FAILED` (1202)

#### 测试 4.3: 小结生成成功（流式）
- [ ] 恢复正确的 LLM 配置
- [ ] 重启后端服务
- [ ] 录制一段语音（至少 30 秒）
- [ ] 点击"生成小结"
- [ ] **预期**: 
  - 显示"生成中"状态
  - 文本逐字流式显示
  - 完成后显示完整小结
  - 小结块可以保存

#### 测试 4.4: 频率限制（如果可测试）
- [ ] 快速连续多次点击"生成小结"
- [ ] **预期**: 可能触发 `LLM_RATE_LIMIT` (1203)
- [ ] 显示: "请求频率超限" + "请稍后再试"

## 中优先级测试 (可选) 🚧

### 5. ASR 服务错误 (测试 5 分钟)

#### 测试 5.1: ASR 认证失败
- [ ] 修改 `config.yml` 中的 ASR access_key 为无效值
- [ ] 重启后端服务
- [ ] 点击"开始录音"
- [ ] **预期**: 显示 "ASR 认证失败"
- [ ] 检查日志: `ASR_AUTH_FAILED` (1100)

#### 测试 5.2: ASR 连接超时
- [ ] 断开网络连接
- [ ] 点击"开始录音"
- [ ] **预期**: 显示 "ASR 连接超时"
- [ ] 检查日志: `ASR_CONNECTION_TIMEOUT` (1102)

### 6. 配置相关 (测试 3 分钟)

#### 测试 6.1: 配置文件缺失
- [ ] 重命名 `config.yml` 为 `config.yml.backup`
- [ ] 重启后端服务
- [ ] **预期**: 启动失败或使用默认配置，日志中显示警告
- [ ] 恢复配置文件

#### 测试 6.2: 配置格式错误
- [ ] 在 `config.yml` 中添加语法错误（如缺少冒号）
- [ ] 重启后端服务
- [ ] **预期**: 启动失败，日志显示配置解析错误
- [ ] 修复配置文件

## 边缘情况测试 (可选) 🔍

### 7. 长时间运行稳定性
- [ ] 启动应用，保持运行 1 小时
- [ ] 每 10 分钟录制一次语音
- [ ] **预期**: 
  - 无内存泄漏
  - WebSocket 保持连接
  - 日志文件正常轮转

### 8. 并发操作
- [ ] 同时：
  - 录制语音
  - 生成小结
  - 加载历史记录
- [ ] **预期**: 所有操作正常，无冲突或错误

### 9. 错误恢复
- [ ] 触发一个错误（如断网）
- [ ] 修复问题（如连网）
- [ ] **预期**: 
  - 系统自动恢复
  - 错误提示消失
  - 功能正常工作

## 日志验证 📋

### 检查日志文件
```bash
# 查看所有日志
ls -lh logs/

# 查看错误日志（应该包含结构化错误）
tail -f logs/errors.log

# 查看 JSON 日志（便于分析）
tail -f logs/app.json | jq .

# 搜索特定错误码
grep "1004" logs/app.json  # API_SERVER_UNAVAILABLE
grep "AUDIO_DEVICE" logs/errors.log
```

### 日志应包含的信息
- [ ] 时间戳
- [ ] 日志级别 (INFO, WARNING, ERROR)
- [ ] 组件名称 (ASR, LLM, Storage, etc.)
- [ ] 错误码 (如果是错误)
- [ ] 用户消息
- [ ] 技术信息
- [ ] 建议

## 用户体验验证 ✨

### 错误消息质量
对于每个错误，检查：
- [ ] **清晰性**: 用户能理解发生了什么？
- [ ] **可操作性**: 用户知道如何解决？
- [ ] **友好性**: 语言是否友好、不吓人？
- [ ] **准确性**: 错误描述是否准确？

### 界面表现
- [ ] 错误 Banner 显示在正确位置
- [ ] Toast 消息不遮挡重要内容
- [ ] 错误信息可读性好（字体、颜色、对比度）
- [ ] 可以关闭错误提示
- [ ] 错误不会导致界面卡死

## 性能验证 ⚡

### 响应时间
- [ ] 错误显示延迟 < 100ms
- [ ] 日志写入不阻塞主线程
- [ ] 错误恢复快速（< 3 秒）

### 资源使用
- [ ] 日志文件大小受控（< 100MB）
- [ ] 日志轮转正常工作
- [ ] 错误处理不占用过多 CPU/内存

## 回归测试 🔄

### 确保现有功能不受影响
- [ ] 正常录音功能
- [ ] WebSocket 实时更新
- [ ] 历史记录加载
- [ ] 小结生成（正常情况）
- [ ] 设置保存和加载

## 测试总结

### 完成情况
- 测试用例总数: ___
- 通过: ___
- 失败: ___
- 跳过: ___

### 发现的问题
1. ________________________________________________
2. ________________________________________________
3. ________________________________________________

### 需要改进的地方
1. ________________________________________________
2. ________________________________________________
3. ________________________________________________

### 测试结论
- [ ] ✅ 所有关键功能正常
- [ ] ✅ 错误处理符合预期
- [ ] ✅ 用户体验良好
- [ ] ✅ 日志系统工作正常
- [ ] ✅ 性能表现良好

---

**测试人**: _________________  
**测试日期**: _________________  
**测试版本**: _________________  
**备注**: _________________

