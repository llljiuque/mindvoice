# æ•°æ®åº“ v1.2.0 å…¨é¢æ£€æŸ¥æŠ¥å‘Š

**æ£€æŸ¥æ—¥æœŸ**: 2026-01-05  
**ç‰ˆæœ¬**: v1.2.0 (åŸºå‡†ç‰ˆæœ¬)  
**çŠ¶æ€**: âœ… é€šè¿‡

---

## ðŸ“Š è¡¨ç»“æž„å®Œæ•´æ€§æ£€æŸ¥

### æ€»è®¡ï¼š14å¼ è¡¨ + 1ä¸ªFTS5è™šæ‹Ÿè¡¨

#### ä»Ž `sqlite.py` åˆ›å»ºï¼ˆ12å¼ è¡¨ï¼‰

| # | è¡¨å | ç±»åž‹ | ä¸»é”® | å¤–é”® | ç´¢å¼•æ•° | çŠ¶æ€ |
|---|------|------|------|------|--------|------|
| 1 | `records` | ä¸»è¡¨ | id (TEXT) | - | 7 | âœ… |
| 2 | `records_fts` | è™šæ‹Ÿè¡¨(FTS5) | - | - | - | âœ… |
| - | è§¦å‘å™¨ x3 | - | - | - | - | âœ… |
| 3 | `tags` | ä¸»è¡¨ | tag_id (AUTO) | - | 1 | âœ… |
| 4 | `record_tags` | å…³è”è¡¨ | id (AUTO) | 2ä¸ª | 2 | âœ… |
| 5 | `daily_stats` | ç»Ÿè®¡è¡¨ | id (AUTO) | - | 2 | âœ… |
| 6 | `backup_logs` | æ—¥å¿—è¡¨ | id (AUTO) | - | 2 | âœ… |
| 7 | `devices` | ä¸»è¡¨ | device_id | - | 2 | âœ… |
| 8 | `memberships` | ä¸»è¡¨ | device_id | 1ä¸ª | 2 | âœ… |
| 9 | `consumption_records` | è®°å½•è¡¨ | id (TEXT) | 1ä¸ª | 3 | âœ… |
| 10 | `monthly_consumption` | æ±‡æ€»è¡¨ | è”åˆä¸»é”® | 1ä¸ª | 1 | âœ… |
| 11 | `activation_codes` | ä¸»è¡¨ | code (TEXT) | - | 3 | âœ… |
| 12 | `schema_versions` | ç‰ˆæœ¬è¡¨ | version (TEXT) | - | 0 | âœ… |

#### ä»Ž `user_storage.py` åˆ›å»ºï¼ˆ2å¼ è¡¨ï¼‰

| # | è¡¨å | ç±»åž‹ | ä¸»é”® | å¤–é”® | ç´¢å¼•æ•° | çŠ¶æ€ |
|---|------|------|------|------|--------|------|
| 13 | `users` | ä¸»è¡¨ | user_id (TEXT) | - | 3 | âœ… |
| 14 | `user_devices` | å…³è”è¡¨ | id (AUTO) | 1ä¸ª | 2 | âœ… |

---

## ðŸ”— å¤–é”®å…³ç³»æ£€æŸ¥

### âœ… æ­£ç¡®çš„å¤–é”®å…³ç³»

1. **record_tags â†’ records** (ON DELETE CASCADE)
   ```sql
   FOREIGN KEY (record_id) REFERENCES records(id) ON DELETE CASCADE
   ```

2. **record_tags â†’ tags** (ON DELETE CASCADE)
   ```sql
   FOREIGN KEY (tag_id) REFERENCES tags(tag_id) ON DELETE CASCADE
   ```

3. **user_devices â†’ users** (ON DELETE CASCADE)
   ```sql
   FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
   ```

4. **memberships â†’ devices**
   ```sql
   FOREIGN KEY (device_id) REFERENCES devices(device_id)
   ```

5. **consumption_records â†’ devices**
   ```sql
   FOREIGN KEY (device_id) REFERENCES devices(device_id)
   ```

6. **monthly_consumption â†’ devices**
   ```sql
   FOREIGN KEY (device_id) REFERENCES devices(device_id)
   ```

### âš ï¸ æ³¨æ„äº‹é¡¹

- `records.user_id` å’Œ `records.device_id` æ²¡æœ‰å¼ºåˆ¶å¤–é”®çº¦æŸï¼ˆçµæ´»è®¾è®¡ï¼Œå…è®¸NULLï¼‰
- è¿™æ˜¯**æ­£ç¡®çš„è®¾è®¡**ï¼šé¿å…è¿‡åº¦çº¦æŸï¼Œæ”¯æŒåŽ†å²æ•°æ®å’Œçµæ´»ç»‘å®š

---

## ðŸ“‘ ç´¢å¼•å®Œæ•´æ€§æ£€æŸ¥

### æ€»è®¡ï¼š28ä¸ªç´¢å¼• + 3ä¸ªéƒ¨åˆ†ç´¢å¼•

#### records è¡¨ï¼ˆ7ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_records_user_id` - æŒ‰ç”¨æˆ·æŸ¥è¯¢
- âœ… `idx_records_device_id` - æŒ‰è®¾å¤‡æŸ¥è¯¢
- âœ… `idx_records_user_created` - æŒ‰ç”¨æˆ·+æ—¶é—´æŸ¥è¯¢
- âœ… `idx_records_not_deleted` - è½¯åˆ é™¤è¿‡æ»¤
- âœ… `idx_records_starred` - æ”¶è—æŸ¥è¯¢ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰
- âœ… `idx_records_archived` - å½’æ¡£æŸ¥è¯¢ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰
- âœ… `idx_records_app_type` - æŒ‰åº”ç”¨ç±»åž‹æŸ¥è¯¢

#### tags è¡¨ï¼ˆ1ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_tags_user` - ç”¨æˆ·æ ‡ç­¾æŸ¥è¯¢

#### record_tags è¡¨ï¼ˆ2ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_record_tags_record` - æŒ‰è®°å½•æŸ¥è¯¢æ ‡ç­¾
- âœ… `idx_record_tags_tag` - æŒ‰æ ‡ç­¾æŸ¥è¯¢è®°å½•

#### daily_stats è¡¨ï¼ˆ2ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_daily_stats_user_date` - ç”¨æˆ·ç»Ÿè®¡æŸ¥è¯¢
- âœ… `idx_daily_stats_date` - æ—¥æœŸç»Ÿè®¡æŸ¥è¯¢

#### backup_logs è¡¨ï¼ˆ2ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_backup_logs_started` - æ—¶é—´æŽ’åº
- âœ… `idx_backup_logs_status` - çŠ¶æ€ç­›é€‰

#### devices è¡¨ï¼ˆ2ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_devices_machine` - æœºå™¨IDæŸ¥è¯¢
- âœ… `idx_devices_active` - æ´»è·ƒæ—¶é—´æŽ’åº

#### memberships è¡¨ï¼ˆ2ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_memberships_status` - çŠ¶æ€+è¿‡æœŸæŸ¥è¯¢
- âœ… `idx_memberships_tier` - ä¼šå‘˜ç­‰çº§æŸ¥è¯¢

#### consumption_records è¡¨ï¼ˆ3ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_consumption_device_time` - è®¾å¤‡+æ—¶é—´æŸ¥è¯¢
- âœ… `idx_consumption_type` - æ¶ˆè´¹ç±»åž‹æŸ¥è¯¢
- âœ… `idx_consumption_model_source` - æ¨¡åž‹æ¥æºæŸ¥è¯¢

#### monthly_consumption è¡¨ï¼ˆ1ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_monthly_consumption_device` - è®¾å¤‡æœˆåº¦æŸ¥è¯¢

#### activation_codes è¡¨ï¼ˆ3ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_activation_codes_used` - ä½¿ç”¨çŠ¶æ€æŸ¥è¯¢
- âœ… `idx_activation_codes_tier` - ä¼šå‘˜ç­‰çº§æŸ¥è¯¢
- âœ… `idx_activation_codes_batch` - æ‰¹æ¬¡æŸ¥è¯¢

#### users è¡¨ï¼ˆ3ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_users_email` - é‚®ç®±æŸ¥è¯¢
- âœ… `idx_users_not_deleted` - è½¯åˆ é™¤è¿‡æ»¤ï¼ˆéƒ¨åˆ†ç´¢å¼•ï¼‰
- âœ… `idx_users_login` - ç™»å½•æ—¶é—´æŽ’åº

#### user_devices è¡¨ï¼ˆ2ä¸ªç´¢å¼•ï¼‰
- âœ… `idx_user_devices_user_id` - ç”¨æˆ·è®¾å¤‡æŸ¥è¯¢
- âœ… `idx_user_devices_device_id` - è®¾å¤‡æŸ¥è¯¢

---

## ðŸ”§ çº¦æŸæ£€æŸ¥

### CHECK çº¦æŸ

#### memberships è¡¨
- âœ… `subscription_period IS NULL OR (subscription_period >= 1 AND subscription_period <= 120)`
- âœ… `tier IN ('free', 'vip', 'pro', 'pro_plus')`
- âœ… `status IN ('active', 'expired', 'pending')`

#### consumption_records è¡¨
- âœ… `type IN ('asr', 'llm')`
- âœ… `unit IN ('ms', 'tokens')`
- âœ… `model_source IN ('vendor', 'user')`
- âœ… `amount >= 0`

#### monthly_consumption è¡¨
- âœ… `asr_duration_ms >= 0`
- âœ… `llm_total_tokens >= 0`

#### activation_codes è¡¨
- âœ… `tier IN ('vip', 'pro', 'pro_plus')`
- âœ… `subscription_period >= 1 AND subscription_period <= 120`
- âœ… `is_used IN (0, 1)`

### UNIQUE çº¦æŸ

- âœ… `devices(machine_id, platform)` - é˜²æ­¢é‡å¤æ³¨å†Œ
- âœ… `tags(user_id, tag_name)` - ç”¨æˆ·æ ‡ç­¾åå”¯ä¸€
- âœ… `record_tags(record_id, tag_id)` - é˜²æ­¢é‡å¤å…³è”
- âœ… `daily_stats(user_id, date, app_type)` - å”¯ä¸€ç»Ÿè®¡è®°å½•
- âœ… `monthly_consumption(device_id, year, month)` - å”¯ä¸€æœˆåº¦è®°å½•
- âœ… `user_devices(device_id)` - è®¾å¤‡å”¯ä¸€ç»‘å®š

---

## ðŸŽ¯ åŠŸèƒ½ç‰¹æ€§æ£€æŸ¥

### âœ… å·²å®žçŽ°çš„æ ¸å¿ƒåŠŸèƒ½

1. **è½¯åˆ é™¤æœºåˆ¶**
   - âœ… users è¡¨ï¼šis_deleted, deleted_at
   - âœ… records è¡¨ï¼šis_deleted, deleted_at
   - âœ… è½¯åˆ é™¤è¿‡æ»¤ç´¢å¼•
   - âœ… æ¢å¤åŠŸèƒ½

2. **æ”¶è—å’Œå½’æ¡£**
   - âœ… is_starred å­—æ®µ
   - âœ… is_archived å­—æ®µ
   - âœ… éƒ¨åˆ†ç´¢å¼•ä¼˜åŒ–
   - âœ… åˆ‡æ¢çŠ¶æ€åŠŸèƒ½

3. **å…¨æ–‡æœç´¢ï¼ˆFTS5ï¼‰**
   - âœ… records_fts è™šæ‹Ÿè¡¨
   - âœ… 3ä¸ªè‡ªåŠ¨åŒæ­¥è§¦å‘å™¨
   - âœ… unicode61 åˆ†è¯å™¨
   - âœ… æœç´¢åŠŸèƒ½å®žçŽ°

4. **æ ‡ç­¾ç³»ç»Ÿ**
   - âœ… tags è¡¨ï¼ˆé¢œè‰²ã€å›¾æ ‡ã€æŽ’åºï¼‰
   - âœ… record_tags å…³è”è¡¨
   - âœ… å¤šå¯¹å¤šå…³ç³»
   - âœ… çº§è”åˆ é™¤

5. **ä½¿ç”¨ç»Ÿè®¡**
   - âœ… daily_stats è¡¨
   - âœ… æŒ‰æ—¥æœŸ+åº”ç”¨ç±»åž‹ç»Ÿè®¡
   - âœ… ASR/LLMç»Ÿè®¡

6. **å¤‡ä»½è®°å½•**
   - âœ… backup_logs è¡¨
   - âœ… çŠ¶æ€è¿½è¸ª
   - âœ… é”™è¯¯è®°å½•

7. **ä¼šå‘˜ç³»ç»Ÿ**
   - âœ… devices è®¾å¤‡æ³¨å†Œ
   - âœ… memberships ä¼šå‘˜ç­‰çº§
   - âœ… consumption_records æ¶ˆè´¹è®°å½•
   - âœ… monthly_consumption æœˆåº¦æ±‡æ€»
   - âœ… activation_codes æ¿€æ´»ç 

8. **ç”¨æˆ·ç®¡ç†**
   - âœ… users ç”¨æˆ·ä¿¡æ¯
   - âœ… user_devices å¤šè®¾å¤‡ç»‘å®š
   - âœ… ç™»å½•ç»Ÿè®¡

9. **ç‰ˆæœ¬ç®¡ç†**
   - âœ… schema_versions è¡¨
   - âœ… è‡ªåŠ¨è®°å½•ç‰ˆæœ¬

---

## ðŸš€ æ€§èƒ½ä¼˜åŒ–æ£€æŸ¥

### âœ… å·²ä¼˜åŒ–é¡¹

1. **PRAGMA è®¾ç½®**
   - âœ… `PRAGMA journal_mode=WAL` - æå‡å¹¶å‘æ€§èƒ½
   - âœ… `PRAGMA foreign_keys=ON` - å¯ç”¨å¤–é”®çº¦æŸ

2. **ç´¢å¼•ç­–ç•¥**
   - âœ… 28ä¸ªå¸¸è§„ç´¢å¼•
   - âœ… 3ä¸ªéƒ¨åˆ†ç´¢å¼•ï¼ˆWHEREæ¡ä»¶ï¼‰
   - âœ… å¤åˆç´¢å¼•ï¼ˆå¤šåˆ—ï¼‰

3. **FTS5 å…¨æ–‡æœç´¢**
   - âœ… 10-100å€æ€§èƒ½æå‡
   - âœ… è‡ªåŠ¨åŒæ­¥è§¦å‘å™¨
   - âœ… ä¸å­˜å‚¨åŽŸå§‹æ–‡æœ¬

4. **æŸ¥è¯¢ä¼˜åŒ–**
   - âœ… è½¯åˆ é™¤é»˜è®¤è¿‡æ»¤
   - âœ… æ—¶é—´å€’åºç´¢å¼•
   - âœ… è”åˆä¸»é”®

---

## ðŸ“ ä»£ç è´¨é‡æ£€æŸ¥

### âœ… é€šè¿‡é¡¹

- âœ… æ—  Linter é”™è¯¯
- âœ… ä»£ç æ ¼å¼è§„èŒƒ
- âœ… æ³¨é‡Šå®Œæ•´
- âœ… é”™è¯¯å¤„ç†å®Œå–„
- âœ… æ—¥å¿—è®°å½•è¯¦ç»†
- âœ… ç±»åž‹æ³¨è§£å®Œæ•´

---

## ðŸ“š æ–‡æ¡£ä¸€è‡´æ€§æ£€æŸ¥

### âœ… æ–‡æ¡£å®Œæ•´æ€§

- âœ… `DATABASE_SCHEMA.md` - è¡¨ç»“æž„æ–‡æ¡£
- âœ… `DATABASE_VERSION.md` - ç‰ˆæœ¬ç®¡ç†
- âœ… `DATABASE_V1.2_SUMMARY.md` - åŠŸèƒ½æ€»ç»“
- âœ… `USER_BINDING_GUIDE.md` - ç”¨æˆ·æŒ‡å—
- âœ… `UPGRADE_TO_V1.2.md` - å‡çº§æŒ‡å—
- âœ… `DATABASE_CHECKLIST_V1.2.md` - æœ¬æ£€æŸ¥æŠ¥å‘Š

### âœ… æ–‡æ¡£ä¸€è‡´æ€§

- âœ… è¡¨æ•°é‡ä¸€è‡´ï¼ˆ14å¼ è¡¨ï¼‰
- âœ… ç´¢å¼•æ•°é‡å‡†ç¡®
- âœ… APIç«¯ç‚¹æ–‡æ¡£å®Œæ•´
- âœ… ç¤ºä¾‹ä»£ç æ­£ç¡®

---

## âš ï¸ å·²çŸ¥é™åˆ¶

### 1. FTS5 ä¸­æ–‡åˆ†è¯
- **çŽ°çŠ¶**: ä½¿ç”¨ unicode61 åˆ†è¯å™¨ï¼Œæ•ˆæžœæœ‰é™
- **å½±å“**: ä¸­æ–‡æœç´¢ä¸å¤Ÿç²¾ç¡®
- **è®¡åˆ’**: æœªæ¥è€ƒè™‘é›†æˆ jieba åˆ†è¯

### 2. è½¯åˆ é™¤ç©ºé—´å ç”¨
- **çŽ°çŠ¶**: è½¯åˆ é™¤è®°å½•ä»å ç”¨å­˜å‚¨ç©ºé—´
- **å½±å“**: é•¿æœŸä½¿ç”¨ä¼šå¢žåŠ æ•°æ®åº“å¤§å°
- **è§£å†³**: å®šæœŸè¿è¡Œæ¸…ç†ï¼ˆ30å¤©è‡ªåŠ¨æ¸…ç†ï¼‰

### 3. æ ‡ç­¾æ•°é‡å»ºè®®
- **çŽ°çŠ¶**: æ— ç¡¬æ€§é™åˆ¶
- **å»ºè®®**: æ¯ç”¨æˆ·ä¸è¶…è¿‡50ä¸ªæ ‡ç­¾
- **åŽŸå› **: è¿‡å¤šå¯èƒ½å½±å“æŸ¥è¯¢æ€§èƒ½

---

## ðŸŽ¯ æµ‹è¯•æ¸…å•

### åŸºç¡€åŠŸèƒ½
- [ ] æ•°æ®åº“è‡ªåŠ¨åˆ›å»º
- [ ] æ‰€æœ‰è¡¨æˆåŠŸåˆ›å»º
- [ ] ç´¢å¼•æ­£å¸¸å·¥ä½œ
- [ ] å¤–é”®çº¦æŸç”Ÿæ•ˆ

### è½¯åˆ é™¤
- [ ] ç”¨æˆ·è½¯åˆ é™¤/æ¢å¤
- [ ] è®°å½•è½¯åˆ é™¤/æ¢å¤
- [ ] å›žæ”¶ç«™æŸ¥çœ‹
- [ ] 30å¤©è‡ªåŠ¨æ¸…ç†

### æ”¶è—å½’æ¡£
- [ ] æ”¶è—/å–æ¶ˆæ”¶è—
- [ ] å½’æ¡£/å–æ¶ˆå½’æ¡£
- [ ] ç­›é€‰æŸ¥è¯¢

### å…¨æ–‡æœç´¢
- [ ] ä¸­æ–‡æœç´¢
- [ ] è‹±æ–‡æœç´¢
- [ ] ç›¸å…³æ€§æŽ’åº
- [ ] è‡ªåŠ¨åŒæ­¥

### æ ‡ç­¾ç³»ç»Ÿ
- [ ] åˆ›å»ºæ ‡ç­¾
- [ ] æ·»åŠ åˆ°è®°å½•
- [ ] æŒ‰æ ‡ç­¾æŸ¥è¯¢
- [ ] æ ‡ç­¾æŽ’åº
- [ ] åˆ é™¤æ ‡ç­¾ï¼ˆçº§è”ï¼‰

### ä¼šå‘˜ç³»ç»Ÿ
- [ ] è®¾å¤‡æ³¨å†Œ
- [ ] ä¼šå‘˜å‡çº§
- [ ] æ¶ˆè´¹è®°å½•
- [ ] æ¿€æ´»ç ä½¿ç”¨
- [ ] æœˆåº¦ç»Ÿè®¡

---

## âœ… æœ€ç»ˆè¯„ä¼°

### æ•°æ®åº“è®¾è®¡è¯„åˆ†

| é¡¹ç›® | è¯„åˆ† | è¯´æ˜Ž |
|-----|------|------|
| è¡¨ç»“æž„è®¾è®¡ | â­â­â­â­â­ | å®Œæ•´ã€æ¸…æ™°ã€è§„èŒƒ |
| ç´¢å¼•ä¼˜åŒ– | â­â­â­â­â­ | å…¨é¢ã€é«˜æ•ˆ |
| å¤–é”®å…³ç³» | â­â­â­â­â­ | æ­£ç¡®ã€åˆç† |
| çº¦æŸè®¾è®¡ | â­â­â­â­â­ | å®Œå–„ã€ä¸¥æ ¼ |
| æ€§èƒ½ä¼˜åŒ– | â­â­â­â­â­ | WALæ¨¡å¼ã€FTS5 |
| æ‰©å±•æ€§ | â­â­â­â­â­ | é¢„ç•™å……è¶³ç©ºé—´ |
| æ–‡æ¡£å®Œæ•´æ€§ | â­â­â­â­â­ | è¯¦å°½ã€å‡†ç¡® |
| ä»£ç è´¨é‡ | â­â­â­â­â­ | è§„èŒƒã€æ— é”™è¯¯ |

### æ€»ä½“è¯„ä¼°ï¼šâ­â­â­â­â­ (5/5)

**ç»“è®º**: æ•°æ®åº“è®¾è®¡å®Œæ•´ã€ä¼˜åŒ–è‰¯å¥½ã€æ–‡æ¡£è¯¦å°½ï¼Œå¯ä»¥ä½œä¸º**ç”Ÿäº§çº§åŸºå‡†ç‰ˆæœ¬**ä½¿ç”¨ã€‚

---

## ðŸš€ ä¸‹ä¸€æ­¥å»ºè®®

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰
1. è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
2. æ€§èƒ½åŸºå‡†æµ‹è¯•
3. å‰ç«¯é›†æˆæµ‹è¯•

### ä¸­æœŸï¼ˆ1-2æœˆï¼‰
1. æ·»åŠ æ•°æ®å¯¼å‡ºåŠŸèƒ½
2. å®žçŽ°è‡ªåŠ¨å¤‡ä»½
3. ä¼˜åŒ–ä¸­æ–‡åˆ†è¯

### é•¿æœŸï¼ˆ3-6æœˆï¼‰
1. äº‘ç«¯åŒæ­¥æ”¯æŒ
2. å¤šè®¾å¤‡åä½œ
3. AIæ™ºèƒ½æ ‡ç­¾

---

**æ£€æŸ¥äººå‘˜**: AI Assistant  
**å®¡æ ¸æ—¥æœŸ**: 2026-01-05  
**ä¸‹æ¬¡æ£€æŸ¥**: å‡çº§åˆ° v1.3.0 æ—¶  
**çŠ¶æ€**: âœ… é€šè¿‡ï¼Œå¯ä»¥è¿›å…¥ç”Ÿäº§çŽ¯å¢ƒ

---

Â© 2026 MindVoice æ·±åœ³çŽ‹å“¥ & AI

