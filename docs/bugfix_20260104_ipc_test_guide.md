# IPC 监听器修复 - 测试指南

## 修复日期
2026-01-04

## 修复内容

修复了 IPC 监听器累积导致的状态失控问题。

### 核心修改

1. **preload.ts**: 
   - 移除了有问题的 `removeAsrMessageListener` 方法
   - 添加了 `removeAllAsrMessageListeners` 方法
   - 在注册新监听器时自动移除旧监听器

2. **App.tsx**:
   - 修改 IPC 监听器清理逻辑，使用 `removeAllAsrMessageListeners`
   - 添加 `activeView` 依赖，确保视图切换时正确处理消息
   - 添加视图切换时的状态同步机制
   - 增强日志记录，便于调试

3. **vite-env.d.ts**:
   - 更新 TypeScript 类型定义

## 测试场景

### 场景 1：正常录音和停止

**步骤**：
1. 启动应用
2. 进入语音笔记
3. 点击开始录音
4. 说话 10 秒
5. 点击停止录音

**预期结果**：
- ✅ 录音按钮状态正确切换（绿色 → 红色 → 绿色）
- ✅ 文字正常更新到界面
- ✅ 控制台日志显示正常的 IPC 消息流
- ✅ 麦克风权限正常释放

**检查点**：
```
[IPC] 设置消息监听器 (修复版：防止监听器累积)
[Preload] 移除所有旧的 asr-message 监听器
[Preload] 注册新的 asr-message 监听器
[IPC] 监听器已设置（旧监听器已自动移除）
[IPC] 收到消息: type=state_change, activeView=voice-note
[IPC] 状态变更: idle -> recording
[IPC] 收到消息: type=text_update, activeView=voice-note
[IPC] 收到消息: type=text_final, activeView=voice-note
[IPC] 收到消息: type=state_change, activeView=voice-note
[IPC] 状态变更: recording -> idle
```

---

### 场景 2：录音期间切换视图

**步骤**：
1. 启动应用
2. 进入语音笔记
3. 点击开始录音
4. 说话 5 秒
5. **切换到"历史记录"视图**
6. 等待 5 秒
7. **切换回"语音笔记"视图**
8. 点击停止录音

**预期结果**：
- ✅ 切换到历史记录时，收到的 ASR 消息会有警告日志，但不会崩溃
- ✅ 切换回语音笔记时，状态自动同步
- ✅ 录音按钮状态与后端一致
- ✅ 可以正常停止录音
- ✅ 不会出现"日志显示录音中，但按钮是绿色"的情况

**检查点**：
```
# 切换到 history 时
[IPC] 收到消息: type=text_update, activeView=history
[IPC] 收到 text_update 但当前不在 voice-note 视图或 blockEditorRef 不可用

# 切换回 voice-note 时
[IPC] 设置消息监听器 (修复版：防止监听器累积)
[状态同步] 切换到 voice-note 视图，同步后端 ASR 状态
[状态同步] 后端状态: recording, 前端状态: recording
[状态同步] 状态一致，无需同步

# 如果状态不一致，会强制同步
[状态同步] 检测到状态不一致，强制同步: idle -> recording
```

---

### 场景 3：多次视图切换

**步骤**：
1. 启动应用
2. 依次切换视图：语音笔记 → 语音聊天 → 语音禅 → 历史记录 → 设置 → 关于 → 语音笔记
3. 在语音笔记中开始录音
4. 再次切换一圈：语音聊天 → 语音禅 → ... → 语音笔记
5. 停止录音

**预期结果**：
- ✅ 每次切换视图，IPC 监听器都会重新设置（旧的被自动移除）
- ✅ 不会累积监听器
- ✅ 状态始终保持同步
- ✅ 录音功能正常

**检查点**：
```
# 每次切换到 voice-note 都会看到
[Preload] 移除所有旧的 asr-message 监听器
[Preload] 注册新的 asr-message 监听器
[状态同步] 切换到 voice-note 视图，同步后端 ASR 状态
```

---

### 场景 4：热重载测试（开发环境）

**步骤**：
1. 启动开发服务器
2. 进入语音笔记并开始录音
3. 修改任意代码（触发热重载）
4. 观察界面和日志

**预期结果**：
- ✅ 热重载后，状态自动同步
- ✅ 不会出现多个监听器累积
- ✅ 录音状态正确恢复

**检查点**：
```
# 热重载后
[IPC] 设置消息监听器 (修复版：防止监听器累积)
[Preload] 移除所有旧的 asr-message 监听器
[Preload] 注册新的 asr-message 监听器
[状态同步] 切换到 voice-note 视图，同步后端 ASR 状态
```

---

### 场景 5：长时间运行测试

**步骤**：
1. 启动应用
2. 进入语音笔记
3. 执行以下循环 10 次：
   - 开始录音
   - 说话 30 秒
   - 停止录音
   - 等待 5 秒
4. 观察状态是否一致

**预期结果**：
- ✅ 10 次录音都能正常工作
- ✅ 状态始终同步
- ✅ 不会出现"录音中但按钮是绿色"的问题
- ✅ 内存不会持续增长（监听器不累积）

---

### 场景 6：状态不一致恢复测试

**模拟步骤**（需要手动干预）：
1. 启动应用
2. 进入语音笔记并开始录音
3. 使用开发者工具手动修改前端状态：
   ```javascript
   // 在控制台执行
   // 假设有方法可以访问状态
   ```
4. 切换到其他视图再切换回来

**预期结果**：
- ✅ 切换回语音笔记时，状态自动从后端同步
- ✅ UI 状态与后端保持一致

---

## 回归测试检查清单

在修复后，需要确认以下功能未受影响：

### 语音笔记功能
- [ ] 基本录音和停止
- [ ] 文字实时更新
- [ ] 创建新笔记
- [ ] 保存笔记到历史记录
- [ ] 生成小结
- [ ] 图片上传
- [ ] 笔记信息编辑

### 其他应用
- [ ] 语音聊天功能正常
- [ ] 语音禅功能正常

### 系统功能
- [ ] 历史记录查看和加载
- [ ] 设置页面功能
- [ ] 关于页面显示
- [ ] 窗口切换（竖屏/横屏/最大化）

---

## 性能测试

### 内存监控

使用 Chrome DevTools 监控内存：

1. 打开开发者工具 → Performance → Memory
2. 执行场景 3（多次视图切换）
3. 观察内存使用情况

**预期结果**：
- ✅ 内存使用稳定，不持续增长
- ✅ 监听器数量不累积

### 日志分析

检查控制台日志：

```bash
# 搜索监听器注册日志
grep "注册新的 asr-message 监听器" logs/*.log

# 搜索监听器移除日志
grep "移除所有 asr-message 监听器" logs/*.log

# 这两个数量应该相等或相近
```

---

## 已知问题

### 依赖 activeView 的副作用

- **问题**: 将 `activeView` 添加到 IPC 监听器的依赖数组会导致每次切换视图都重新注册监听器
- **影响**: 在视图切换频繁时可能有轻微性能影响
- **缓解措施**: 在 `onAsrMessage` 中已经自动移除旧监听器，所以不会累积
- **是否需要优化**: 取决于实际使用中的性能表现

### 状态同步的时机

- **问题**: 状态同步是在视图切换后触发，可能有短暂延迟
- **影响**: 用户可能会看到短暂的状态不一致（几十毫秒）
- **是否可接受**: 是，因为状态会自动纠正

---

## 成功标准

修复被认为是成功的，如果：

1. ✅ 所有测试场景通过
2. ✅ 不再出现"日志显示录音中，但 UI 显示等待"的问题
3. ✅ 视图切换不影响录音功能
4. ✅ 热重载不导致状态错乱
5. ✅ 内存使用稳定
6. ✅ 所有回归测试通过

---

## 测试报告模板

```markdown
## IPC 修复测试报告

**测试人员**: 
**测试日期**: 
**测试版本**: 

### 场景测试结果

| 场景 | 状态 | 备注 |
|------|------|------|
| 场景1: 正常录音 | ✅/❌ | |
| 场景2: 录音期间切换视图 | ✅/❌ | |
| 场景3: 多次视图切换 | ✅/❌ | |
| 场景4: 热重载 | ✅/❌ | |
| 场景5: 长时间运行 | ✅/❌ | |
| 场景6: 状态恢复 | ✅/❌ | |

### 回归测试结果

- 语音笔记: ✅/❌
- 语音聊天: ✅/❌
- 语音禅: ✅/❌
- 其他功能: ✅/❌

### 性能测试结果

- 内存使用: 稳定/不稳定
- 监听器累积: 有/无

### 问题记录

| 问题描述 | 严重程度 | 是否阻塞 |
|---------|---------|---------|
| | | |

### 总体评价

- [ ] 修复成功，可以发布
- [ ] 需要进一步修复
- [ ] 需要重新设计

**备注**:
```

---

## 附录：调试技巧

### 监控监听器数量

在控制台执行（需要在主进程）：

```javascript
// 查看当前监听器数量
console.log('asr-message 监听器数量:', 
  ipcRenderer.listenerCount('asr-message'));
```

### 查看详细的 IPC 消息

在 App.tsx 的 `handleAsrMessage` 中添加：

```typescript
console.log('[IPC] 完整消息:', JSON.stringify(data, null, 2));
```

### 模拟状态不一致

在控制台执行：

```javascript
// 假设你有访问状态的方法
// 这只是示例，实际方法可能不同
setAsrState('idle'); // 手动设置前端状态为 idle
// 但后端可能仍在 recording
```

然后切换视图观察是否能自动恢复。

