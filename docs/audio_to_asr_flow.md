# éŸ³é¢‘åˆ°ASRæµç¨‹è¯¦è§£

æœ¬æ–‡æ¡£è¯¦ç»†è¯´æ˜ MindVoice é¡¹ç›®ä¸­ä»éŸ³é¢‘é‡‡é›†åˆ°è¯­éŸ³è¯†åˆ«ï¼ˆASRï¼‰çš„å®Œæ•´æµç¨‹ã€‚

## ğŸ“‹ ç›®å½•

- [æµç¨‹æ¦‚è§ˆ](#æµç¨‹æ¦‚è§ˆ)
- [ASR Client å®Œæ•´å·¥ä½œæµç¨‹](#asr-client-å®Œæ•´å·¥ä½œæµç¨‹)
- [è¯¦ç»†æµç¨‹](#è¯¦ç»†æµç¨‹)
- [å…³é”®æŠ€æœ¯ç‚¹](#å…³é”®æŠ€æœ¯ç‚¹)
- [æ•°æ®æµå›¾](#æ•°æ®æµå›¾)
- [ä»£ç ä½ç½®](#ä»£ç ä½ç½®)
- [æ•…éšœæ’æŸ¥](#æ•…éšœæ’æŸ¥)

---

## æµç¨‹æ¦‚è§ˆ

éŸ³é¢‘åˆ°ASRçš„å®Œæ•´æµç¨‹åŒ…å«ä»¥ä¸‹æ­¥éª¤ï¼š

```
å‰ç«¯è§¦å‘ â†’ APIæ¥æ”¶ â†’ VoiceServiceå¯åŠ¨ â†’ Audioå…ˆå¯åŠ¨ï¼ˆä¿è¯ç¼“å†²ï¼‰
â†’ AudioASRGatewayï¼ˆç»Ÿä¸€ç½‘å…³ï¼Œæ§åˆ¶ASRå¯åœï¼‰
    â”œâ”€ VAD enabled:  æ£€æµ‹è¯­éŸ³ â†’ åŠ¨æ€å¯åœASR
    â””â”€ VAD disabled: æŒç»­æœ‰æ•ˆä¿¡å· â†’ ASRæŒç»­è¿è¡Œ
â†’ ASRæä¾›è€…æ¥æ”¶ â†’ WebSocketå‘é€ â†’ ASRæœåŠ¡è¯†åˆ« â†’ ç»“æœæ¥æ”¶ 
â†’ ç»“æœå¤„ç† â†’ APIå¹¿æ’­ â†’ å‰ç«¯æ˜¾ç¤º
```

**å…³é”®ç‰¹æ€§**:
- **Audioå…ˆè¡Œå¯åŠ¨**ï¼šä¿è¯éŸ³é¢‘é‡‡é›†ç¼“å†²åŠæ—¶
- **AudioASRGatewayç»Ÿä¸€ç½‘å…³**ï¼šAudio å’Œ ASR ä¹‹é—´çš„ç»Ÿä¸€æ§åˆ¶å±‚
- **VADæ§åˆ¶ASRå¯åœ**ï¼š
  - `enabled=True`: æ£€æµ‹è¯­éŸ³åŠ¨æ€å¯åœASRï¼ˆèŠ‚çº¦40-60%æˆæœ¬ï¼‰
  - `enabled=False`: æŒç»­æœ‰æ•ˆä¿¡å·ï¼ŒASRæŒç»­è¿è¡Œ
- å®æ—¶æµå¼å¤„ç†ï¼šéŸ³é¢‘é‡‡é›†åç«‹å³å¤„ç†ï¼Œä½å»¶è¿Ÿ
- å¤šçº¿ç¨‹+å¼‚æ­¥æ¶æ„ï¼šéŸ³é¢‘é‡‡é›†çº¿ç¨‹ã€æ¶ˆè´¹çº¿ç¨‹ã€å¼‚æ­¥WebSocketä»»åŠ¡
- ç¼“å†²åŒºç®¡ç†ï¼šè‡ªåŠ¨æ¸…ç†é•¿æ—¶é—´å½•éŸ³çš„æ—§æ•°æ®ï¼ˆé»˜è®¤60ç§’é™åˆ¶ï¼‰

**æ¶æ„è®¾è®¡**:
```
Audio â†’ AudioASRGateway â†’ ASR â†’ Text
        â†‘
    ç»Ÿä¸€ç½‘å…³å±‚ï¼š
    - æ§åˆ¶ASRå¯åœ
    - è¯­éŸ³æ´»åŠ¨æ£€æµ‹ï¼ˆå¯é€‰ï¼‰
    - éŸ³é¢‘æµè¿‡æ»¤å’Œè½¬å‘
```

---

## ASR Client å®Œæ•´å·¥ä½œæµç¨‹

### ğŸ”„ æ¦‚è¿°

ASR Client æ˜¯ä¸€ä¸ª**æœ‰çŠ¶æ€çš„ã€åŒå‘é€šä¿¡çš„ WebSocket å®¢æˆ·ç«¯**ï¼Œè´Ÿè´£ä¸ ASR æœåŠ¡å™¨è¿›è¡Œå®æ—¶æµå¼è¯­éŸ³è¯†åˆ«äº¤äº’ã€‚ç†è§£å…¶å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸå¯¹äºæ­£ç¡®è®¾è®¡ç³»ç»Ÿæ¶æ„è‡³å…³é‡è¦ã€‚

### ğŸ“¡ é€šä¿¡åè®®

ASR Client ä½¿ç”¨åŸºäº WebSocket çš„äºŒè¿›åˆ¶åè®®è¿›è¡Œé€šä¿¡ï¼š

#### è¯·æ±‚åŒ…æ ¼å¼

```
[Header(4å­—èŠ‚)] [Sequence(4å­—èŠ‚)] [Payload]
```

- **Header**: åŒ…å«æ¶ˆæ¯ç±»å‹ã€æ ‡å¿—ä½ã€åºåˆ—åŒ–ç±»å‹ã€å‹ç¼©ç±»å‹
- **Sequence**: 
  - æ­£æ•° (1, 2, 3...): æ™®é€šéŸ³é¢‘åŒ…
  - **è´Ÿæ•° (-N)**: æœ€åä¸€ä¸ªéŸ³é¢‘åŒ…ï¼ˆç»“æŸæ ‡è®°ï¼‰
- **Payload**: éŸ³é¢‘æ•°æ®ï¼ˆGZIPå‹ç¼©ï¼‰

#### å“åº”åŒ…æ ¼å¼

```
[Header(4å­—èŠ‚)] [Optional Fields] [Payload]
```

- **is_last_package æ ‡å¿—**: æœåŠ¡å™¨è¿”å›çš„æœ€åä¸€ä¸ªåŒ…
- **Payload**: JSON æ ¼å¼çš„è¯†åˆ«ç»“æœ

---

### ğŸ” å®Œæ•´ç”Ÿå‘½å‘¨æœŸ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   ASR Client ç”Ÿå‘½å‘¨æœŸ                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

1. è¿æ¥å»ºç«‹ (Connect)
   â”œâ”€ åˆ›å»º WebSocket è¿æ¥
   â”œâ”€ å‘é€å®Œæ•´è¯·æ±‚ (Full Request, seq=1)
   â””â”€ å¯åŠ¨å‘é€å™¨å’Œæ¥æ”¶å™¨ä»»åŠ¡ï¼ˆå¹¶å‘è¿è¡Œï¼‰

2. æ•°æ®ä¼ è¾“é˜¶æ®µ (Streaming)
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Audio Sender    â”‚              â”‚ Result Receiver  â”‚
   â”‚   (ç‹¬ç«‹ä»»åŠ¡)      â”‚              â”‚   (ç‹¬ç«‹ä»»åŠ¡)      â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                    â”‚
        â”œâ”€ ä»éŸ³é¢‘é˜Ÿåˆ—è·å–æ•°æ®                 â”œâ”€ æŒç»­ç›‘å¬æœåŠ¡å™¨æ¶ˆæ¯
        â”œâ”€ seq=2, 3, 4...                   â”œâ”€ è§£æè¯†åˆ«ç»“æœ
        â”œâ”€ å‘é€éŸ³é¢‘åŒ…                        â”œâ”€ text_update (ä¸­é—´ç»“æœ)
        â”‚  (is_last=False)                  â”œâ”€ text_final (ç¡®å®šç»“æœ)
        â”‚                                   â””â”€ è§¦å‘å›è°ƒå‡½æ•°
        â””â”€ é‡å¤...

3. åœæ­¢ä¿¡å·è§¦å‘ (Stop Signal)
   â”œâ”€ VoiceService å‘é€ None åˆ°éŸ³é¢‘é˜Ÿåˆ—
   â”‚  (è§¦å‘æ¡ä»¶: VADæ£€æµ‹åˆ°é™éŸ³ / ç”¨æˆ·æ‰‹åŠ¨åœæ­¢)
   â””â”€ Audio Sender æ”¶åˆ° None

4. ğŸ”´ å‘é€æœ€ååŒ… (Send Final Packet)
   â”œâ”€ Audio Sender å‘é€è´ŸåŒ…
   â”‚  â””â”€ seq=-N, is_last=True
   â”‚  â””â”€ åŒ…å«æœ€åçš„éŸ³é¢‘æ•°æ®ï¼ˆå¦‚æœæœ‰ï¼‰
   â””â”€ Audio Sender ä»»åŠ¡é€€å‡º

5. â³ ç­‰å¾…æœåŠ¡å™¨å“åº” (Wait for Server)
   â”œâ”€ Result Receiver ç»§ç»­è¿è¡Œ
   â”œâ”€ æœåŠ¡å™¨å¤„ç†æœ€åçš„éŸ³é¢‘
   â”œâ”€ å¯èƒ½è¿”å›å¤šä¸ªä¸­é—´ç»“æœ
   â”œâ”€ å¯èƒ½è¿”å›ç¡®å®šç»“æœ (definite=true)
   â””â”€ æœ€ç»ˆè¿”å› is_last_package=True

6. âœ… æ­£å¸¸æ–­å¼€ (Graceful Disconnect)
   â”œâ”€ Result Receiver æ£€æµ‹åˆ° is_last_package
   â”œâ”€ é€€å‡ºæ¥æ”¶å¾ªç¯
   â”œâ”€ è°ƒç”¨ _disconnect()
   â”‚  â”œâ”€ å…³é—­ WebSocket
   â”‚  â”œâ”€ å…³é—­ HTTP Session
   â”‚  â””â”€ finally: é‡ç½® _streaming_active = False
   â””â”€ è¿æ¥å®Œå…¨å…³é—­

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš ï¸  å…³é”®æ—¶åºçº¦æŸ                                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â€¢ å‘é€å™¨å’Œæ¥æ”¶å™¨æ˜¯å®Œå…¨å¹¶å‘çš„ç‹¬ç«‹ä»»åŠ¡                          â”‚
â”‚  â€¢ å‘é€æœ€ååŒ…åï¼Œæ¥æ”¶å™¨ä»éœ€ç»§ç»­è¿è¡Œ                            â”‚
â”‚  â€¢ åªæœ‰æ”¶åˆ° is_last_package=True æ‰èƒ½æ–­å¼€                     â”‚
â”‚  â€¢ è¿‡æ—©æ–­å¼€ä¼šå¯¼è‡´æœ€åçš„è¯†åˆ«ç»“æœä¸¢å¤±                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

### âš¡ å…³é”®æ—¶åºé—®é¢˜

#### é—®é¢˜åœºæ™¯ï¼šVAD è§¦å‘çš„å¿«é€Ÿå¯åœ

```
æ—¶åˆ» T0: VAD æ£€æµ‹åˆ°è¯­éŸ³ â†’ å¯åŠ¨ ASR
æ—¶åˆ» T1: ç”¨æˆ·è¯´è¯ï¼š"è¿™æ˜¯ä¸€æ®µæ–‡å­—"
æ—¶åˆ» T2: VAD æ£€æµ‹åˆ° 1.5 ç§’é™éŸ³ â†’ _on_speech_end() è¢«è°ƒç”¨
         â”œâ”€ å‘é€ None åˆ°é˜Ÿåˆ—
         â”œâ”€ ASR å‘é€è´ŸåŒ… (seq=-10)
         â””â”€ âŒ é”™è¯¯åšæ³•ï¼šç«‹å³è®¾ç½® _streaming_active = False
         
æ—¶åˆ» T3: VAD å†æ¬¡æ£€æµ‹åˆ°è¯­éŸ³ â†’ _on_speech_start() è¢«è°ƒç”¨
         â””â”€ âŒ æ­¤æ—¶æ—§ ASR è¿˜åœ¨ç­‰å¾…æœåŠ¡å™¨çš„æœ€åå“åº”ï¼
         â””â”€ âœ… æ­£ç¡®è¡Œä¸ºï¼šåº”è¯¥ç­‰å¾…æ—§ ASR å®Œå…¨å…³é—­

æ—¶åˆ» T4: æœåŠ¡å™¨è¿”å›æ—§ ASR çš„æœ€åç»“æœ (is_last_package=True)
         â””â”€ åŒ…å« "è¿™æ˜¯ä¸€æ®µæ–‡å­—" çš„å®Œæ•´è¯†åˆ«ç»“æœ
         â””â”€ âŒ å¦‚æœå·²ç»å¯åŠ¨æ–° ASRï¼Œè¿™ä¸ªç»“æœå¯èƒ½ä¸¢å¤±ï¼
```

#### âœ… æ­£ç¡®çš„å®ç°

**åœ¨ `_on_speech_end()` ä¸­**ï¼š

```python
def _on_speech_end(self):
    """
    VAD æ£€æµ‹åˆ°é™éŸ³ï¼Œè§¦å‘ ASR åœæ­¢æµç¨‹
    
    âš ï¸ æ³¨æ„ï¼šè¿™é‡Œåªæ˜¯"è§¦å‘åœæ­¢"ï¼Œä¸æ˜¯"ç«‹å³åœæ­¢"ï¼
    """
    # 1. å‘é€ç»“æŸæ ‡è®°åˆ°éŸ³é¢‘é˜Ÿåˆ—
    self.asr_provider._audio_queue.put_nowait(None)
    logger.info("å·²å‘é€ç»“æŸæ ‡è®°ï¼Œç­‰å¾…ASRè¿”å›æœ€åç»“æœ...")
    
    # 2. âŒ ä¸è¦ç«‹å³è®¾ç½® _streaming_active = False
    #    è®© ASR æ¥æ”¶å™¨åœ¨æ”¶åˆ° is_last_package åè‡ªç„¶ç»“æŸ
    
    # 3. âœ… ASR çš„ _disconnect() ä¼šåœ¨ finally å—ä¸­é‡ç½®çŠ¶æ€
```

**åœ¨ `_on_speech_start()` ä¸­**ï¼š

```python
def _on_speech_start(self):
    """
    VAD æ£€æµ‹åˆ°è¯­éŸ³ï¼Œå°è¯•å¯åŠ¨ ASR
    
    âš ï¸ å¿…é¡»æ£€æŸ¥æ—§ ASR æ˜¯å¦å®Œå…¨å…³é—­
    """
    # æ£€æŸ¥ ASR provider çš„å®é™…çŠ¶æ€
    if self._streaming_active or self.asr_provider._streaming_active:
        logger.debug("ASRè¿˜åœ¨è¿è¡Œæˆ–æ­£åœ¨å…³é—­ï¼Œè·³è¿‡é‡å¤å¯åŠ¨")
        return
    
    # å¯åŠ¨æ–°çš„ ASR ä¼šè¯
    await self.asr_provider.start_streaming_recognition(language)
```

**åœ¨ ASR Provider çš„ `_audio_receiver()` ä¸­**ï¼š

```python
async def _audio_receiver(self):
    """
    æ¥æ”¶ ASR æœåŠ¡å™¨çš„å“åº”
    
    âš ï¸ è¿™æ˜¯å”¯ä¸€èƒ½æ­£ç¡®åˆ¤æ–­ ASR ä½•æ—¶å®Œæˆçš„åœ°æ–¹
    """
    try:
        async for msg in self.conn:
            if msg.type == aiohttp.WSMsgType.BINARY:
                response = ResponseParser.parse_response(msg.data)
                
                # å¤„ç†è¯†åˆ«ç»“æœ
                if response.payload_msg:
                    result = response.payload_msg.get('result', {})
                    if result.get('text'):
                        self._handle_recognition_result(result, response.is_last_package)
                
                # âœ… æ£€æµ‹åˆ°æœ€ååŒ…ï¼Œé€€å‡ºå¾ªç¯
                if response.is_last_package:
                    logger.info("[ASR-WS] æ”¶åˆ°æœ€ååŒ…ï¼Œå‡†å¤‡æ–­å¼€")
                    break
                    
    finally:
        # âœ… æ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œæ¸…ç†
        await self._disconnect()

async def _disconnect(self):
    """æ–­å¼€è¿æ¥å¹¶æ¸…ç†èµ„æº"""
    try:
        # å…³é—­è¿æ¥...
    finally:
        # âœ… æœ€åé‡ç½®çŠ¶æ€ï¼Œå…è®¸ä¸‹æ¬¡å¯åŠ¨
        self._streaming_active = False
```

---

### ğŸ“Š æ­£å¸¸æµç¨‹çš„æ—¶åºå›¾

```
æ—¶é—´è½´ â†’

Audio Thread      Voice Service       ASR Sender        ASR Receiver      ASR Server
    |                  |                  |                  |                |
    |  éŸ³é¢‘é‡‡é›†         |                  |                  |                |
    |----------------->|                  |                  |                |
    |                  |  å¯åŠ¨ASR          |                  |                |
    |                  |----------------->| Full Request     |                |
    |                  |                  |--------------------------------->|
    |                  |                  | seq=1            |                |
    |                  |                  |<---------------------------------|
    |                  |                  |                  | åˆå§‹å“åº”        |
    |                  |                  |                  |                |
    |  éŸ³é¢‘æ•°æ®         |                  |                  |                |
    |----------------->|  è½¬å‘éŸ³é¢‘         |                  |                |
    |                  |----------------->| seq=2, 3, 4...   |                |
    |                  |                  |--------------------------------->|
    |                  |                  |                  | ä¸­é—´ç»“æœ        |
    |                  |                  |                  |<---------------|
    |                  |                  |                  | text_update    |
    |                  |<------------------------------------|                |
    |                  | å›è°ƒæ˜¾ç¤º         |                  |                |
    |                  |                  |                  |                |
    | [VADæ£€æµ‹åˆ°é™éŸ³]   |                  |                  |                |
    |                  | _on_speech_end() |                  |                |
    |                  |----------------->| None             |                |
    |                  |                  |                  |                |
    |                  |                  | seq=-10          |                |
    |                  |                  | is_last=True     |                |
    |                  |                  |--------------------------------->|
    |                  |                  | [å‘é€å™¨é€€å‡º]     |                |
    |                  |                  | X                |                |
    |                  |                  |                  | [å¤„ç†ä¸­...]    |
    |                  |                  |                  | text_update    |
    |                  |<------------------------------------|                |
    |                  |                  |                  | text_final     |
    |                  |<------------------------------------|                |
    |                  |                  |                  | is_last_pkg    |
    |                  |                  |                  |<---------------|
    |                  |                  |                  | [æ¥æ”¶å™¨é€€å‡º]    |
    |                  |                  |                  | _disconnect()  |
    |                  |                  |                  | X              |
    |                  |                  |                  |                |
    | [VADæ£€æµ‹åˆ°æ–°è¯­éŸ³] |                  |                  |                |
    |                  | _on_speech_start()|                 |                |
    |                  |  âœ… æ£€æŸ¥é€šè¿‡      | [å¯åŠ¨æ–°ä¼šè¯]     |                |
    |                  |----------------->| Full Request     |                |
    |                  |                  | seq=1            |                |
    |                  |                  |--------------------------------->|
```

---

### ğŸš¨ å¸¸è§é™·é˜±å’Œè§£å†³æ–¹æ¡ˆ

#### é™·é˜± 1: è¿‡æ—©é‡ç½® `_streaming_active`

**é”™è¯¯åšæ³•**ï¼š
```python
def _on_speech_end(self):
    self._audio_queue.put_nowait(None)
    self._streaming_active = False  # âŒ å¤ªæ—©äº†ï¼
```

**é—®é¢˜**ï¼š
- ASR è¿˜åœ¨ç­‰å¾…æœåŠ¡å™¨çš„æœ€åå“åº”
- `_on_speech_start()` çš„æ£€æŸ¥ä¼šé€šè¿‡
- å¯åŠ¨æ–° ASRï¼Œå¯¼è‡´èµ„æºå†²çª
- æ—§ ASR çš„æœ€åç»“æœå¯èƒ½ä¸¢å¤±

**æ­£ç¡®åšæ³•**ï¼š
```python
def _on_speech_end(self):
    self._audio_queue.put_nowait(None)
    # âœ… ä¸è®¾ç½® _streaming_active
    # è®©æ¥æ”¶å™¨åœ¨ _disconnect() çš„ finally å—ä¸­é‡ç½®
```

---

#### é™·é˜± 2: æœªæ£€æŸ¥ ASR çŠ¶æ€å°±å¯åŠ¨

**é”™è¯¯åšæ³•**ï¼š
```python
def _on_speech_start(self):
    # âŒ ç›´æ¥å¯åŠ¨ï¼Œä¸æ£€æŸ¥
    await self.asr_provider.start_streaming_recognition(language)
```

**é—®é¢˜**ï¼š
- æ—§ ASR è¿˜åœ¨è¿è¡Œ
- åˆ›å»ºå¤šä¸ªå¹¶å‘ WebSocket è¿æ¥
- èµ„æºæ³„æ¼

**æ­£ç¡®åšæ³•**ï¼š
```python
def _on_speech_start(self):
    # âœ… åŒé‡æ£€æŸ¥
    if self._streaming_active or self.asr_provider._streaming_active:
        logger.debug("ASRè¿˜åœ¨è¿è¡Œï¼Œè·³è¿‡")
        return
    
    await self.asr_provider.start_streaming_recognition(language)
```

---

#### é™·é˜± 3: ä¸ç­‰å¾… `is_last_package`

**é”™è¯¯åšæ³•**ï¼š
```python
async def _audio_receiver(self):
    async for msg in self.conn:
        response = parse_response(msg.data)
        handle_result(response)
        
        # âŒ å‘é€å™¨é€€å‡ºå°±ç«‹å³æ–­å¼€
        if self._sender_task.done():
            break
```

**é—®é¢˜**ï¼š
- æœåŠ¡å™¨è¿˜åœ¨å¤„ç†æœ€åçš„éŸ³é¢‘
- æœ€åçš„è¯†åˆ«ç»“æœä¼šä¸¢å¤±
- å¯èƒ½ä¸¢å¤± definite=true çš„å‡†ç¡®ç»“æœ

**æ­£ç¡®åšæ³•**ï¼š
```python
async def _audio_receiver(self):
    async for msg in self.conn:
        response = parse_response(msg.data)
        handle_result(response)
        
        # âœ… åªæœ‰æ”¶åˆ°æœåŠ¡å™¨çš„æ˜ç¡®ä¿¡å·æ‰æ–­å¼€
        if response.is_last_package:
            logger.info("æ”¶åˆ°æœ€ååŒ…ï¼Œæ–­å¼€")
            break
```

---

### ğŸ“ è®¾è®¡æ£€æŸ¥æ¸…å•

åœ¨è®¾è®¡æ¶‰åŠ ASR çš„åŠŸèƒ½æ—¶ï¼Œè¯·æ£€æŸ¥ï¼š

- [ ] **æ˜¯å¦æ­£ç¡®å¤„ç†äº†å‘é€å™¨å’Œæ¥æ”¶å™¨çš„å¹¶å‘å…³ç³»**ï¼Ÿ
- [ ] **æ˜¯å¦åœ¨æ¥æ”¶åˆ° `is_last_package=True` ä¹‹å‰ä¿æŒè¿æ¥**ï¼Ÿ
- [ ] **æ˜¯å¦åœ¨ `_disconnect()` çš„ `finally` å—ä¸­é‡ç½®çŠ¶æ€**ï¼Ÿ
- [ ] **æ˜¯å¦åœ¨å¯åŠ¨æ–° ASR å‰æ£€æŸ¥æ—§ ASR çš„çŠ¶æ€**ï¼Ÿ
- [ ] **æ˜¯å¦é¿å…äº†åœ¨ `_on_speech_end()` ä¸­ç«‹å³é‡ç½®çŠ¶æ€**ï¼Ÿ
- [ ] **æ˜¯å¦æ­£ç¡®å¤„ç†äº†ä¸­é—´ç»“æœå’Œç¡®å®šç»“æœ**ï¼Ÿ
- [ ] **æ˜¯å¦è€ƒè™‘äº† VAD é¢‘ç¹è§¦å‘çš„åœºæ™¯**ï¼Ÿ
- [ ] **æ˜¯å¦æœ‰è¶³å¤Ÿçš„æ—¥å¿—æ¥è¿½è¸ª ASR çš„ç”Ÿå‘½å‘¨æœŸ**ï¼Ÿ

---

### ğŸ” è°ƒè¯•æŠ€å·§

å½“é‡åˆ°è¯†åˆ«ç»“æœä¸¢å¤±æˆ– ASR çŠ¶æ€å¼‚å¸¸æ—¶ï¼Œæ£€æŸ¥æ—¥å¿—ä¸­çš„å…³é”®æ—¶é—´ç‚¹ï¼š

1. **ASR å¯åŠ¨**: `âœ“ æµå¼è¯†åˆ«å·²å¯åŠ¨`
2. **å‘é€è´ŸåŒ…**: `â†’ æœ€åéŸ³é¢‘åŒ… (seq=-N)`
3. **æ¥æ”¶æœ€åç»“æœ**: `[ASR] æœ€ç»ˆç»“æœ` æˆ– `[ASR] ç¡®å®šç»“æœ`
4. **æ”¶åˆ°æœ€ååŒ…**: `æ”¶åˆ°æœ€ååŒ…ï¼Œå‡†å¤‡æ–­å¼€`
5. **è¿æ¥æ–­å¼€**: `âœ“ è¿æ¥å·²æ–­å¼€`
6. **çŠ¶æ€é‡ç½®**: `finally: _streaming_active = False`

**æ­£å¸¸æ—¶åº**ï¼š1 â†’ 2 â†’ 3 â†’ 4 â†’ 5 â†’ 6

**å¼‚å¸¸æ—¶åº**ï¼ˆå¦‚æœ 2 å’Œ 1 åŒæ—¶å‡ºç°ï¼‰ï¼šè¯´æ˜å¯åŠ¨äº†å¤šä¸ª ASR å®ä¾‹ï¼

---

### ğŸ“Š çŠ¶æ€æœºå›¾

#### VoiceService + ASR Provider çŠ¶æ€æœº

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å®Œæ•´çŠ¶æ€æœº                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

çŠ¶æ€å®šä¹‰ï¼š
- IDLE: ç©ºé—²çŠ¶æ€
- WAITING_FOR_SPEECH: ç­‰å¾…è¯­éŸ³ï¼ˆVADå·²å¯åŠ¨ï¼ŒAudioåœ¨é‡‡é›†ï¼‰
- ASR_STARTING: ASRæ­£åœ¨å¯åŠ¨
- ASR_ACTIVE: ASRæ­£åœ¨å·¥ä½œ
- ASR_STOPPING: ASRæ­£åœ¨åœæ­¢ï¼ˆå·²å‘é€è´ŸåŒ…ï¼Œç­‰å¾…æœ€åå“åº”ï¼‰
- ASR_DISCONNECTING: ASRæ­£åœ¨æ–­å¼€è¿æ¥

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  IDLE   â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚
     â”‚ ç”¨æˆ·ç‚¹å‡»å¼€å§‹å½•éŸ³
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Audio å¯åŠ¨         â”‚
â”‚ VAD åˆå§‹åŒ–         â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”œâ”€ VAD enabled â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                        â–¼
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚              â”‚ WAITING_FOR_SPEECH â”‚ â—„â”€â”
     â”‚              â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
     â”‚                    â”‚                  â”‚
     â”‚       VADæ£€æµ‹åˆ°è¯­éŸ³ â”‚                  â”‚
     â”‚                    â–¼                  â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
     â”‚              â”‚ASR_STARTING â”‚          â”‚
     â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜          â”‚
     â”‚                     â”‚                 â”‚
     â”‚         è¿æ¥æˆåŠŸã€å‘é€å™¨æ¥æ”¶å™¨å¯åŠ¨      â”‚
     â”‚                     â–¼                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
     â”‚                 â”‚ ASR_ACTIVE  â”‚      â”‚
     â”‚ VAD disabled    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜      â”‚
     â”‚                        â”‚             â”‚
     â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
     â”‚         â”‚              â”‚         â”‚   â”‚
     â”‚  éŸ³é¢‘æ•°æ®æµ         VADæ£€æµ‹      â”‚   â”‚
     â”‚  (æŒç»­å‘é€)         åˆ°é™éŸ³       â”‚   â”‚
     â”‚         â”‚              â”‚         â”‚   â”‚
     â”‚         â–¼              â–¼         â”‚   â”‚
     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚   â”‚
     â”‚  â”‚æ¥æ”¶text_   â”‚  â”‚ASR_STOPPING â”‚â”‚   â”‚
     â”‚  â”‚update/     â”‚  â”‚(å‘é€è´ŸåŒ…)   â”‚â”‚   â”‚
     â”‚  â”‚text_final  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜â”‚   â”‚
     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚       â”‚   â”‚
     â”‚         â–²               â”‚       â”‚   â”‚
     â”‚         â”‚     ç­‰å¾…is_last_package â”‚   â”‚
     â”‚         â”‚               â”‚       â”‚   â”‚
     â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚   â”‚
     â”‚                         â–¼       â”‚   â”‚
     â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
     â”‚              â”‚ASR_DISCONNECTINGâ”‚   â”‚
     â”‚              â”‚(æ¸…ç†èµ„æº)       â”‚   â”‚
     â”‚              â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
     â”‚                   â”‚                 â”‚
     â”‚        å›è°ƒ: _on_disconnected       â”‚
     â”‚                   â”‚                 â”‚
     â”‚                   â–¼                 â”‚
     â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
     â”‚        â”‚é‡ç½®_streaming_activeâ”‚       â”‚
     â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
     â”‚                  â”‚                  â”‚
     â”‚    VAD enabledä¸”å†æ¬¡æ£€æµ‹åˆ°è¯­éŸ³       â”‚
     â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â”‚ ç”¨æˆ·ç‚¹å‡»åœæ­¢å½•éŸ³
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Audio åœæ­¢    â”‚
â”‚ æ¸…ç†èµ„æº      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  IDLE   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

å…³é”®çŠ¶æ€è½¬æ¢è§„åˆ™ï¼š
1. WAITING_FOR_SPEECH â†’ ASR_STARTING: 
   - æ¡ä»¶: VAD æ£€æµ‹åˆ°è¯­éŸ³
   - æ£€æŸ¥: _streaming_active == False AND asr_provider._streaming_active == False
   
2. ASR_ACTIVE â†’ ASR_STOPPING:
   - æ¡ä»¶: VAD æ£€æµ‹åˆ°é™éŸ³ OR ç”¨æˆ·æ‰‹åŠ¨åœæ­¢
   - æ“ä½œ: å‘é€ None åˆ°é˜Ÿåˆ—ï¼Œä¸é‡ç½® _streaming_active
   
3. ASR_STOPPING â†’ ASR_DISCONNECTING:
   - æ¡ä»¶: æ¥æ”¶åˆ° is_last_package=True
   - æ“ä½œ: é€€å‡ºæ¥æ”¶å¾ªç¯ï¼Œè¿›å…¥ finally å—
   
4. ASR_DISCONNECTING â†’ WAITING_FOR_SPEECH (VAD enabled) OR IDLE:
   - æ¡ä»¶: _disconnect() å®Œæˆ
   - æ“ä½œ: é‡ç½®æ‰€æœ‰çŠ¶æ€ï¼Œè§¦å‘ _on_disconnected å›è°ƒ

```

---

### ğŸ”’ å…³é”®çŠ¶æ€å˜é‡åŒæ­¥æœºåˆ¶

ä¸ºäº†é¿å…ç«æ€æ¡ä»¶ï¼Œç³»ç»Ÿä½¿ç”¨**åŒå±‚çŠ¶æ€æ ‡è®° + å›è°ƒé€šçŸ¥**æœºåˆ¶ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              çŠ¶æ€åŒæ­¥æœºåˆ¶                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

VoiceService._streaming_active     ASR Provider._streaming_active
        â”‚                                    â”‚
        â”‚  1. _on_speech_start()             â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚
        â”‚  è®¾ç½®ä¸º True                        â”‚  è®¾ç½®ä¸º True
        â”‚                                    â”‚
        â”‚  2. éŸ³é¢‘æ•°æ®æµåŠ¨                    â”‚
        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
        â”‚                                    â”‚
        â”‚  3. _on_speech_end()               â”‚
        â”‚  ä¸ä¿®æ”¹çŠ¶æ€ï¼                       â”‚  ä¸ä¿®æ”¹çŠ¶æ€ï¼
        â”‚  åªå‘é€ None                        â”‚
        â”‚                                    â”‚
        â”‚  4. ASR æ¥æ”¶å™¨æ”¶åˆ° is_last_package  â”‚
        â”‚                                    â”‚  è¿›å…¥ _disconnect()
        â”‚                                    â”‚
        â”‚  5. _disconnect() finally å—       â”‚
        â”‚                                    â”‚  é‡ç½®ä¸º False
        â”‚                                    â”‚
        â”‚  6. _on_disconnected() å›è°ƒ        â”‚
        â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        â”‚  é‡ç½®ä¸º False                       â”‚
        â”‚                                    â”‚

âš ï¸ å…³é”®è®¾è®¡åŸåˆ™ï¼š
â€¢ VoiceService ä¸ä¸»åŠ¨é‡ç½®çŠ¶æ€ï¼ˆé™¤äº†å¼‚å¸¸æƒ…å†µï¼‰
â€¢ ASR Provider åœ¨çœŸæ­£æ–­å¼€åé‡ç½®è‡ªå·±çš„çŠ¶æ€
â€¢ ASR Provider é€šè¿‡å›è°ƒé€šçŸ¥ VoiceService é‡ç½®
â€¢ å¯åŠ¨å‰åŒé‡æ£€æŸ¥ä¸¤ä¸ªçŠ¶æ€æ ‡è®°
```

---

### âš ï¸ è¾¹ç•Œæ¡ä»¶å’Œå¼‚å¸¸åœºæ™¯

#### åœºæ™¯ 1: ç½‘ç»œæ•…éšœå¯¼è‡´è¿æ¥çªç„¶æ–­å¼€

**ç°è±¡**ï¼š
- WebSocket è¿æ¥å¼‚å¸¸å…³é—­
- æ¥æ”¶å™¨ä»»åŠ¡æŠ›å‡ºå¼‚å¸¸

**å¤„ç†**ï¼š
```python
async def _audio_receiver(self):
    try:
        async for msg in self.conn:
            # å¤„ç†æ¶ˆæ¯...
    except Exception as e:
        logger.error(f"æ¥æ”¶ä»»åŠ¡å¼‚å¸¸: {e}")
    finally:
        # âœ… æ— è®ºå¦‚ä½•éƒ½ä¼šæ¸…ç†èµ„æº
        await self._disconnect()
```

**ç»“æœ**ï¼š
- `_disconnect()` åœ¨ finally å—ä¸­å¿…ç„¶æ‰§è¡Œ
- çŠ¶æ€è¢«æ­£ç¡®é‡ç½®
- `_on_disconnected()` å›è°ƒé€šçŸ¥ä¸Šå±‚

---

#### åœºæ™¯ 2: ç”¨æˆ·å¿«é€Ÿç‚¹å‡»å¼€å§‹/åœæ­¢

**æ—¶åº**ï¼š
```
T0: ç”¨æˆ·ç‚¹å‡»å¼€å§‹ â†’ ASR å¯åŠ¨
T1: ç”¨æˆ·ç«‹å³ç‚¹å‡»åœæ­¢ â†’ å‘é€ None
T2: ç”¨æˆ·å†æ¬¡ç‚¹å‡»å¼€å§‹ â†’ å°è¯•å¯åŠ¨ ASR
```

**ä¿æŠ¤æœºåˆ¶**ï¼š
```python
def _on_speech_start(self):
    # åŒé‡æ£€æŸ¥
    if self._streaming_active or self.asr_provider._streaming_active:
        logger.debug("ASRè¿˜åœ¨è¿è¡Œï¼Œè·³è¿‡")
        return  # âœ… é˜²æ­¢é‡å¤å¯åŠ¨
```

**ç»“æœ**ï¼š
- T2 æ—¶åˆ»çš„å¯åŠ¨è¯·æ±‚è¢«æ‹’ç»
- å¿…é¡»ç­‰å¾… T1 è§¦å‘çš„åœæ­¢å®Œå…¨å®Œæˆ
- é€šè¿‡ `_on_disconnected()` å›è°ƒçŸ¥é“ä½•æ—¶å¯ä»¥é‡æ–°å¯åŠ¨

---

#### åœºæ™¯ 3: VAD é¢‘ç¹è¯¯è§¦å‘ï¼ˆå™ªéŸ³ç¯å¢ƒï¼‰

**ç°è±¡**ï¼š
- ç¯å¢ƒå™ªéŸ³è¢«è¯¯åˆ¤ä¸ºè¯­éŸ³
- VAD é¢‘ç¹è§¦å‘ `_on_speech_start()` å’Œ `_on_speech_end()`

**ä¿æŠ¤æœºåˆ¶ 1** - VAD å‚æ•°è°ƒæ•´ï¼š
```yaml
vad:
  mode: 3  # æœ€ä¸¥æ ¼æ¨¡å¼
  speech_start_threshold: 5  # éœ€è¦5å¸§è¿ç»­è¯­éŸ³
  speech_end_threshold: 15   # éœ€è¦15å¸§è¿ç»­é™éŸ³
  min_speech_duration_ms: 300  # æœ€çŸ­è¯­éŸ³300ms
```

**ä¿æŠ¤æœºåˆ¶ 2** - çŠ¶æ€æ£€æŸ¥ï¼š
```python
def _on_speech_start(self):
    if self._streaming_active or self.asr_provider._streaming_active:
        return  # âœ… å¦‚æœä¸Šæ¬¡è¿˜æ²¡ç»“æŸï¼Œæ‹’ç»æ–°å¯åŠ¨
```

**ç»“æœ**ï¼š
- VAD è¯¯è§¦å‘ä¸ä¼šå¯¼è‡´èµ„æºæ³„æ¼
- ASR ä¸ä¼šé¢‘ç¹é‡å¯ï¼ˆé™¤éä¸Šæ¬¡çœŸæ­£ç»“æŸï¼‰

---

#### åœºæ™¯ 4: ASR æœåŠ¡å™¨é•¿æ—¶é—´æ— å“åº”

**ç°è±¡**ï¼š
- å‘é€äº†è´ŸåŒ…ï¼Œä½†æœåŠ¡å™¨ä¸€ç›´ä¸è¿”å› `is_last_package`
- æ¥æ”¶å™¨ä¸€ç›´ç­‰å¾…

**ä¿æŠ¤æœºåˆ¶** - è¶…æ—¶å¤„ç†ï¼ˆå»ºè®®å®ç°ï¼‰ï¼š
```python
async def _audio_receiver(self):
    timeout = 10.0  # 10ç§’è¶…æ—¶
    start_time = None
    
    try:
        async for msg in self.conn:
            # ... å¤„ç†æ¶ˆæ¯
            
            # å¦‚æœå·²å‘é€ç»“æŸæ ‡è®°ï¼Œå¼€å§‹è®¡æ—¶
            if self._sender_task and self._sender_task.done():
                if start_time is None:
                    start_time = time.time()
                elif time.time() - start_time > timeout:
                    logger.warning("[ASR-WS] ç­‰å¾…æœ€ååŒ…è¶…æ—¶ï¼Œå¼ºåˆ¶æ–­å¼€")
                    break
```

**ç»“æœ**ï¼š
- å³ä½¿æœåŠ¡å™¨æ— å“åº”ï¼Œä¹Ÿä¼šåœ¨è¶…æ—¶åå¼ºåˆ¶æ–­å¼€
- é¿å…èµ„æºæ°¸ä¹…å ç”¨

---

#### åœºæ™¯ 5: ASR è¿”å›çš„æœ€åç»“æœå¾ˆé•¿ï¼ˆå¤šä¸ªåŒ…ï¼‰

**ç°è±¡**ï¼š
- å‘é€è´ŸåŒ…åï¼ŒæœåŠ¡å™¨è¿”å›å¤šä¸ªä¸­é—´ç»“æœ
- æœ€åæ‰è¿”å› `is_last_package=True`

**å¤„ç†**ï¼š
```python
async def _audio_receiver(self):
    async for msg in self.conn:
        if msg.type == aiohttp.WSMsgType.BINARY:
            response = ResponseParser.parse_response(msg.data)
            
            # âœ… æŒç»­å¤„ç†æ‰€æœ‰ç»“æœ
            if response.payload_msg:
                result = response.payload_msg.get('result', {})
                if result.get('text'):
                    self._handle_recognition_result(result, response.is_last_package)
            
            # âœ… åªæœ‰æ˜ç¡®çš„æœ€ååŒ…æ‰é€€å‡º
            if response.is_last_package:
                break
```

**ç»“æœ**ï¼š
- æ‰€æœ‰è¯†åˆ«ç»“æœéƒ½è¢«æ­£ç¡®å¤„ç†
- ä¸ä¼šå› ä¸ºæ”¶åˆ°å¤šä¸ªåŒ…è€Œæå‰é€€å‡º

---

#### åœºæ™¯ 6: ä¸¤ä¸ªåº”ç”¨åŒæ—¶å°è¯•ä½¿ç”¨ ASR

**ç°è±¡**ï¼š
- ç”¨æˆ·åœ¨ voice-note ä¸­å¼€å§‹å½•éŸ³
- åˆ‡æ¢åˆ° voice-chat ä¹Ÿå°è¯•å¼€å§‹å½•éŸ³

**ä¿æŠ¤æœºåˆ¶** - app_id éš”ç¦»ï¼š
```python
# VoiceService å­˜å‚¨å½“å‰ä½¿ç”¨ ASR çš„åº”ç”¨
self._current_app_id = app_id

# WebSocket æ¶ˆæ¯åŒ…å« app_id
message["app_id"] = self._current_app_id

# å‰ç«¯è¿‡æ»¤éå½“å‰åº”ç”¨çš„æ¶ˆæ¯
if (data.app_id && data.app_id !== activeView) {
  return;  // å¿½ç•¥
}
```

**ç»“æœ**ï¼š
- åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªåº”ç”¨èƒ½ä½¿ç”¨ ASR
- æ¶ˆæ¯ä¸ä¼šä¸²åˆ°å…¶ä»–åº”ç”¨

---

### ğŸ“ˆ æ€§èƒ½å’Œèµ„æºç®¡ç†

#### èµ„æºæ¸…ç†æ¸…å•

`_disconnect()` å¿…é¡»æ¸…ç†çš„èµ„æºï¼š

1. **ä»»åŠ¡å–æ¶ˆ**ï¼š
   ```python
   if self._sender_task:
       self._sender_task.cancel()
       await self._sender_task  # ç­‰å¾…å–æ¶ˆå®Œæˆ
   ```

2. **è¿æ¥å…³é—­**ï¼š
   ```python
   if self.conn and not self.conn.closed:
       await self.conn.close()
   ```

3. **Session æ¸…ç†**ï¼š
   ```python
   if self.session and not self.session.closed:
       await self.session.close()
   ```

4. **é˜Ÿåˆ—æ¸…ç©º**ï¼š
   ```python
   if self._audio_queue:
       while not self._audio_queue.empty():
           self._audio_queue.get_nowait()
   ```

5. **çŠ¶æ€é‡ç½®**ï¼š
   ```python
   self._streaming_active = False
   self._sender_task = None
   self._receiver_task = None
   self._audio_queue = None
   ```

6. **å›è°ƒé€šçŸ¥**ï¼š
   ```python
   if self._on_disconnected_callback:
       self._on_disconnected_callback()
   ```

---

### ğŸ¯ è®¾è®¡åŸåˆ™æ€»ç»“

1. **å•ä¸€èŒè´£**ï¼š
   - VoiceServiceï¼šç®¡ç†å½•éŸ³å’Œ ASR åè°ƒ
   - ASR Providerï¼šç®¡ç† ASR è¿æ¥å’Œé€šä¿¡
   - AudioASRGatewayï¼šç®¡ç† VAD å’ŒéŸ³é¢‘è¿‡æ»¤

2. **çŠ¶æ€ä¸€è‡´æ€§**ï¼š
   - ä½¿ç”¨åŒå±‚çŠ¶æ€æ ‡è®°é˜²æ­¢ç«æ€æ¡ä»¶
   - ASR Provider è´Ÿè´£é‡ç½®è‡ªå·±çš„çŠ¶æ€
   - é€šè¿‡å›è°ƒé€šçŸ¥ä¸Šå±‚çŠ¶æ€å˜åŒ–

3. **èµ„æºç¡®å®šæ€§é‡Šæ”¾**ï¼š
   - ä½¿ç”¨ finally å—ç¡®ä¿æ¸…ç†
   - æ˜¾å¼å–æ¶ˆæ‰€æœ‰ä»»åŠ¡
   - æ¸…ç©ºæ‰€æœ‰é˜Ÿåˆ—

4. **é˜²å¾¡æ€§ç¼–ç¨‹**ï¼š
   - å¯åŠ¨å‰æ£€æŸ¥çŠ¶æ€
   - æ•è·æ‰€æœ‰å¼‚å¸¸
   - æä¾›è¶…æ—¶ä¿æŠ¤

5. **å¯è§‚æµ‹æ€§**ï¼š
   - è¯¦ç»†çš„æ—¥å¿—è®°å½•
   - æ¸…æ™°çš„çŠ¶æ€è½¬æ¢æ—¥å¿—
   - ä¾¿äºè¿½è¸ªé—®é¢˜

---

## ğŸš€ VAD å¯¹å»¶è¿Ÿçš„å½±å“åˆ†æ

### å»¶è¿Ÿæ¦‚è¿°

**ç®€çŸ­å›ç­”**ï¼šâœ… **VAD å¼•å…¥çš„é¢å¤–å»¶è¿Ÿéå¸¸å°ï¼ˆ< 50msï¼‰ï¼Œå¯¹ç”¨æˆ·ä½“éªŒå½±å“å¯å¿½ç•¥**

**è¯¦ç»†åˆ†æ**ï¼š

---

### ğŸ“Š å»¶è¿Ÿç»„æˆå¯¹æ¯”

#### ä¸ä½¿ç”¨ VADï¼ˆç›´é€šæ¨¡å¼ï¼‰

```
ç”¨æˆ·è¯´è¯ â†’ Audioé‡‡é›† â†’ ç›´æ¥å‘é€ASR â†’ ASRå¤„ç† â†’ è¿”å›ç»“æœ
         |â†200mså—â†’| |â†ç½‘ç»œå»¶è¿Ÿâ†’| |â†è¯†åˆ«â†’| |â†ç½‘ç»œâ†’|
         
æ€»å»¶è¿Ÿ â‰ˆ 200ms (é‡‡é›†) + 50ms (ç½‘ç»œ) + 100-300ms (ASR) + 50ms (ç½‘ç»œ)
      â‰ˆ 400-600ms
```

#### ä½¿ç”¨ VADï¼ˆå½“å‰å®ç°ï¼‰

```
ç”¨æˆ·è¯´è¯ â†’ Audioé‡‡é›† â†’ VADæ£€æµ‹ â†’ ç­‰å¾…ç¡®è®¤ â†’ å¯åŠ¨ASR â†’ å‘é€éŸ³é¢‘ â†’ ASRå¤„ç† â†’ è¿”å›ç»“æœ
         |â†200msâ†’| |â†20msâ†’| |â†40msâ†’| |â†è¿æ¥â†’| |â†200msâ†’| |â†è¯†åˆ«â†’| |â†ç½‘ç»œâ†’|

VADæ£€æµ‹é˜¶æ®µï¼š
- å¸§æ‹†åˆ†: ~0.1msï¼ˆçº¯å†…å­˜æ“ä½œï¼‰
- VADæ£€æµ‹: 20ms/å¸§ Ã— 1å¸§ = 20ms
- çŠ¶æ€ç¡®è®¤: éœ€è¦è¿ç»­Nå¸§ï¼ˆé»˜è®¤5å¸§ï¼‰= 5Ã—20ms = 100ms
- å‰ç½®ç¼“å†²å›æ”¾: ~5msï¼ˆå·²åœ¨ç¼“å†²åŒºï¼‰

ASRå¯åŠ¨å»¶è¿Ÿï¼š
- WebSocketè¿æ¥ï¼ˆå¦‚å·²è¿æ¥ï¼‰: ~0ms
- WebSocketè¿æ¥ï¼ˆéœ€è¦æ–°å»ºï¼‰: ~200-500ms
- å‘é€Full Request: ~10ms

æ€»VADç›¸å…³å»¶è¿Ÿï¼š
- é¦–æ¬¡æ£€æµ‹åˆ°è¯­éŸ³: 20ms
- ç­‰å¾…çŠ¶æ€ç¡®è®¤: 100msï¼ˆ5å¸§ Ã— 20msï¼‰
- ASRå¯åŠ¨ï¼ˆå·²è¿æ¥ï¼‰: 10ms
- å‰ç½®ç¼“å†²å›æ”¾: 5ms
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
é¦–æ¬¡å»¶è¿Ÿ â‰ˆ 135ms
```

---

### âš¡ å…³é”®å‘ç°

#### 1. **é¦–æ¬¡è¯†åˆ«å»¶è¿Ÿå¢åŠ ** ğŸŸ¡

**å¢åŠ é‡**ï¼šçº¦ 135msï¼ˆVADæ£€æµ‹ + çŠ¶æ€ç¡®è®¤ï¼‰

**åŸå› **ï¼š
```
T0: ç”¨æˆ·å¼€å§‹è¯´è¯
T1: ç¬¬1ä¸ªéŸ³é¢‘å—åˆ°è¾¾ï¼ˆ200msåï¼‰
T2: VADæ£€æµ‹åˆ°è¯­éŸ³ï¼ˆ+20msï¼‰
T3: ç­‰å¾…çŠ¶æ€ç¡®è®¤ï¼ˆéœ€è¦5å¸§ï¼Œ+100msï¼‰
T4: è§¦å‘ASRå¯åŠ¨ï¼ˆ+10msï¼‰
T5: å¼€å§‹å‘é€éŸ³é¢‘æ•°æ®
```

**å®é™…ä½“éªŒ**ï¼š
- ç”¨æˆ·è¯´ï¼š"ä½ å¥½" â†’ å¼€å§‹è¯†åˆ«å»¶è¿Ÿï¼š~135ms
- ä½†ç”±äº**å‰ç½®ç¼“å†²**ï¼ˆ100msï¼‰ï¼Œå®é™…ä¸ä¼šä¸¢å¤±å¼€å¤´çš„éŸ³èŠ‚
- ç”¨æˆ·æ„ŸçŸ¥ï¼šåŸºæœ¬æ— å½±å“

---

#### 2. **åç»­è¯†åˆ«æ— å»¶è¿Ÿ** âœ…

ä¸€æ—¦ ASR è¿›å…¥ ACTIVE çŠ¶æ€ï¼š
```
ç”¨æˆ·ç»§ç»­è¯´è¯ â†’ Audioé‡‡é›† â†’ VADæ£€æµ‹ â†’ ç›´æ¥ä¼ é€’ â†’ ASRå¤„ç†
              |â†200msâ†’| |â†0.1msâ†’| |â†å³æ—¶â†’|

VADå¤„ç†æ—¶é—´ â‰ˆ 0.1msï¼ˆçº¯å†…å­˜æ“ä½œï¼ŒWebRTC VADéå¸¸å¿«ï¼‰
```

**åŸå› **ï¼š
- VAD æ£€æµ‹æ˜¯é€å¸§è¿›è¡Œçš„ï¼ˆ20ms/å¸§ï¼‰
- æ£€æµ‹å»¶è¿Ÿ < 1msï¼ˆWebRTC VAD æ˜¯é«˜åº¦ä¼˜åŒ–çš„ C ä»£ç ï¼‰
- ä¸éœ€è¦ç­‰å¾…çŠ¶æ€ç¡®è®¤ï¼ˆå·²ç»åœ¨ SPEECH çŠ¶æ€ï¼‰
- éŸ³é¢‘æ•°æ®ç«‹å³ä¼ é€’ç»™ ASR

---

#### 3. **VAD disabled æ—¶é›¶å»¶è¿Ÿ** âœ…

å¦‚æœ `vad.enabled = false`ï¼š
```python
def process(self, audio_data: bytes) -> Optional[bytes]:
    if not self.enabled:
        return audio_data  # ç›´æ¥è¿”å›ï¼Œ0å»¶è¿Ÿ
```

**å®Œå…¨ç­‰åŒäºä¸ä½¿ç”¨ VAD**

---

### ğŸ“ˆ å»¶è¿Ÿæµ‹é‡æ•°æ®

åŸºäºä»£ç åˆ†æçš„ç†è®ºå€¼ï¼š

| åœºæ™¯ | VADå»¶è¿Ÿ | ASRå¯åŠ¨å»¶è¿Ÿ | æ€»é¢å¤–å»¶è¿Ÿ | ç”¨æˆ·æ„ŸçŸ¥ |
|------|---------|------------|-----------|---------|
| **é¦–æ¬¡è¯­éŸ³ï¼ˆVAD enabledï¼‰** | 120ms | 10-200ms | **130-320ms** | ğŸŸ¡ ç•¥æœ‰å»¶è¿Ÿ |
| **æŒç»­è¯­éŸ³ï¼ˆVAD enabledï¼‰** | 0.1ms | 0ms | **~0ms** | âœ… æ— æ„ŸçŸ¥ |
| **VAD disabled** | 0ms | 0ms | **0ms** | âœ… æ— æ„ŸçŸ¥ |
| **VADè¯¯è§¦å‘åé‡å¯** | 120ms | 10ms | **130ms** | ğŸŸ¡ ç•¥æœ‰å»¶è¿Ÿ |

---

### ğŸ¯ ä¼˜åŒ–ç­–ç•¥

#### å½“å‰é…ç½®ï¼ˆé»˜è®¤ï¼‰

```yaml
vad:
  enabled: true
  mode: 3  # æœ€ä¸¥æ ¼ï¼ˆå‡†ç¡®åº¦æœ€é«˜ï¼Œä½†å¯èƒ½å¢åŠ å»¶è¿Ÿï¼‰
  speech_start_threshold: 5  # éœ€è¦5å¸§ç¡®è®¤ï¼ˆ100msï¼‰
  speech_end_threshold: 15   # éœ€è¦15å¸§ç¡®è®¤ï¼ˆ300msï¼‰
```

**é€‚ç”¨åœºæ™¯**ï¼šæˆæœ¬æ•æ„Ÿï¼Œå¯æ¥å—è½»å¾®å»¶è¿Ÿ

---

#### ä½å»¶è¿Ÿé…ç½®ï¼ˆæ¨èï¼‰

```yaml
vad:
  enabled: true
  mode: 1  # è¾ƒå®½æ¾ï¼ˆé™ä½è¯¯è§¦å‘ï¼Œå‡å°‘å»¶è¿Ÿï¼‰
  speech_start_threshold: 2  # ä»…éœ€2å¸§ç¡®è®¤ï¼ˆ40msï¼‰âœ…
  speech_end_threshold: 10   # 10å¸§ç¡®è®¤ï¼ˆ200msï¼‰
  pre_speech_padding_ms: 150  # å¢åŠ å‰ç½®ç¼“å†²ï¼Œé˜²æ­¢ä¸¢å¤±å¼€å¤´
```

**ä¼˜ç‚¹**ï¼š
- å¯åŠ¨å»¶è¿Ÿé™è‡³ **60ms**ï¼ˆ2å¸§ Ã— 20ms + æ£€æµ‹ + å¯åŠ¨ï¼‰
- å‡ ä¹æ— æ„ŸçŸ¥
- ä»èƒ½èŠ‚çº¦ 30-40% æˆæœ¬

---

#### é›¶å»¶è¿Ÿé…ç½®ï¼ˆæ€§èƒ½ä¼˜å…ˆï¼‰

```yaml
vad:
  enabled: false  # å®Œå…¨ç¦ç”¨ VAD âœ…
```

**é€‚ç”¨åœºæ™¯**ï¼š
- å¯¹å»¶è¿Ÿæåº¦æ•æ„Ÿçš„åº”ç”¨
- ä¸åœ¨æ„ ASR æˆæœ¬
- éœ€è¦å¤„ç†è¿ç»­å¯¹è¯

---

### ğŸ”¬ æ·±å…¥åˆ†æï¼šä¸ºä»€ä¹ˆ VAD å»¶è¿Ÿå¾ˆå°ï¼Ÿ

#### 1. **WebRTC VAD çš„æ•ˆç‡**

```python
# VADæ£€æµ‹æ˜¯é«˜åº¦ä¼˜åŒ–çš„
is_speech = self.vad.is_speech(frame, 16000)  # ~0.05ms
```

**WebRTC VAD ç‰¹æ€§**ï¼š
- çº¯ C å®ç°ï¼Œç¼–è¯‘ä¸ºæœ¬åœ°ä»£ç 
- å•å¸§æ£€æµ‹å»¶è¿Ÿ < 0.1ms
- æ—  I/O æ“ä½œï¼Œçº¯å†…å­˜è®¡ç®—
- ç®—æ³•å¤æ‚åº¦ï¼šO(n)ï¼Œn = å¸§å¤§å°ï¼ˆ640å­—èŠ‚ï¼‰

---

#### 2. **å‰ç½®ç¼“å†²æœºåˆ¶**

```python
self.pre_buffer = deque(maxlen=self.pre_buffer_frames)  # é»˜è®¤5å¸§ï¼ˆ100msï¼‰

# æ£€æµ‹åˆ°è¯­éŸ³æ—¶ï¼Œç«‹å³å›æ”¾å‰ç½®ç¼“å†²
if self.state == VADState.SILENCE and self.speech_frame_count >= self.speech_start_threshold:
    result.extend(b''.join(self.pre_buffer))  # å›æ”¾100mså‰çš„éŸ³é¢‘
    result.extend(frame)
```

**æ•ˆæœ**ï¼š
- å³ä½¿ VAD å»¶è¿Ÿ 100ms æ‰ç¡®è®¤æ˜¯è¯­éŸ³
- ç”±äºå‰ç½®ç¼“å†²ï¼ŒASR å®é™…æ”¶åˆ°çš„æ˜¯ä»**è¯­éŸ³å¼€å§‹å‰100ms**çš„æ•°æ®
- ç”¨æˆ·è¯´"ä½ å¥½"ï¼Œå³ä½¿ VAD å»¶è¿Ÿï¼Œ"ä½ "å­—ä¹Ÿä¸ä¼šä¸¢å¤±

---

#### 3. **å¹¶è¡Œå¤„ç†æ¶æ„**

```
Audio Thread (é‡‡é›†)
     â†“ (200mså—)
AudioASRGateway (VADæ£€æµ‹ï¼Œ20ms/å¸§)
     â†“ (è¯­éŸ³æ•°æ®)
ASR Thread (å‘é€å™¨ï¼Œå®æ—¶å‘é€)
     â†“ (WebSocket)
ASR Server (è¯†åˆ«)
     â†“ (ç»“æœ)
ASR Thread (æ¥æ”¶å™¨ï¼Œå®æ—¶æ¥æ”¶)
```

**å…³é”®**ï¼š
- VAD æ£€æµ‹å’Œ ASR å¤„ç†æ˜¯**å¹¶è¡Œ**çš„
- VAD ä¸ä¼šé˜»å¡éŸ³é¢‘é‡‡é›†
- VAD ä¸ä¼šé˜»å¡ ASR è¯†åˆ«
- åªæœ‰é¦–æ¬¡å¯åŠ¨æ—¶æœ‰"ç­‰å¾…ç¡®è®¤"çš„å»¶è¿Ÿ

---

### ğŸ“‰ å»¶è¿Ÿå¯¹æ¯”å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           ç”¨æˆ·è¯´è¯åˆ°æ”¶åˆ°é¦–ä¸ªè¯†åˆ«ç»“æœçš„å»¶è¿Ÿ                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ä¸ä½¿ç”¨VADï¼ˆç›´é€šï¼‰:
ç”¨æˆ·: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      |â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 500ms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’|
                                       â†“ é¦–ä¸ªç»“æœ

ä½¿ç”¨VADï¼ˆmode=3, threshold=5ï¼‰:
ç”¨æˆ·: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      |â†â”€â”€â”€â”€â”€â”€ 635ms â”€â”€â”€â”€â”€â”€â†’|
      |         â†‘ +135ms     â†“ é¦–ä¸ªç»“æœ
      |         (VADæ£€æµ‹+ç¡®è®¤+å¯åŠ¨)
      |
      |â† 100ms â†’| â† ä½†å‰ç½®ç¼“å†²ä¿æŠ¤äº†å¼€å¤´

ä½¿ç”¨VADï¼ˆmode=1, threshold=2ï¼Œä¼˜åŒ–ï¼‰:
ç”¨æˆ·: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      |â†â”€â”€â”€â”€â”€â”€â”€â”€ 560ms â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’|
      |         â†‘ +60ms      â†“ é¦–ä¸ªç»“æœ
      
VAD disabled:
ç”¨æˆ·: â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
      |â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 500ms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’|
                                       â†“ é¦–ä¸ªç»“æœ
      (å®Œå…¨ç­‰åŒäºä¸ä½¿ç”¨VAD)
```

---

### âœ… ç»“è®ºå’Œå»ºè®®

#### æ€»ç»“

1. **VAD å¼•å…¥çš„å»¶è¿Ÿéå¸¸å°**ï¼ˆ< 50ms in ä¼˜åŒ–é…ç½®ï¼‰
2. **å‰ç½®ç¼“å†²æœºåˆ¶ä¿æŠ¤è¯­éŸ³å¼€å¤´**ï¼ˆä¸ä¼šä¸¢å¤±éŸ³èŠ‚ï¼‰
3. **æŒç»­è¯­éŸ³æœŸé—´å‡ ä¹é›¶å»¶è¿Ÿ**ï¼ˆ< 0.1msï¼‰
4. **å¯é€šè¿‡é…ç½®åœ¨æˆæœ¬å’Œå»¶è¿Ÿé—´å¹³è¡¡**

---

#### æ¨èé…ç½®

**åœºæ™¯ 1ï¼šæˆæœ¬ä¼˜å…ˆ**ï¼ˆå½“å‰é…ç½®ï¼‰
```yaml
vad:
  enabled: true
  speech_start_threshold: 5  # å»¶è¿Ÿ130msï¼Œä½†æˆæœ¬èŠ‚çº¦60%
```

**åœºæ™¯ 2ï¼šä½“éªŒä¼˜å…ˆ**ï¼ˆæ¨èï¼‰
```yaml
vad:
  enabled: true
  speech_start_threshold: 2  # å»¶è¿Ÿ60msï¼Œæˆæœ¬èŠ‚çº¦40%
  mode: 1  # æ›´çµæ•
```

**åœºæ™¯ 3ï¼šé›¶å»¶è¿Ÿ**
```yaml
vad:
  enabled: false  # æ— å»¶è¿Ÿï¼Œä½†ä¸èŠ‚çº¦æˆæœ¬
```

---

#### å®é™…æµ‹è¯•å»ºè®®

å»ºè®®è¿›è¡Œç”¨æˆ·ä½“éªŒæµ‹è¯•ï¼š

1. **ä¸»è§‚æµ‹è¯•**ï¼š
   - è®©æµ‹è¯•è€…è¯´è¯ï¼š"ä½ å¥½ï¼Œè¯·å¸®æˆ‘..."
   - æµ‹é‡ä»è¯´è¯åˆ°é¦–ä¸ªå­—ç¬¦æ˜¾ç¤ºçš„æ—¶é—´
   - å¯¹æ¯” VAD enabled/disabled çš„å·®å¼‚

2. **å®¢è§‚æµ‹è¯•**ï¼š
   - ä½¿ç”¨ `time.time()` è®°å½•æ—¶é—´æˆ³
   - è®°å½•ï¼šç”¨æˆ·è¯´è¯å¼€å§‹ â†’ VADæ£€æµ‹ â†’ ASRå¯åŠ¨ â†’ é¦–ä¸ªç»“æœ
   - åˆ†æå„é˜¶æ®µå»¶è¿Ÿå æ¯”

3. **æˆæœ¬åˆ†æ**ï¼š
   - è®°å½• VAD è¿‡æ»¤çš„éŸ³é¢‘å¸§æ•°
   - è®¡ç®—èŠ‚çº¦çš„ ASR æˆæœ¬
   - è¯„ä¼°å»¶è¿Ÿ vs. æˆæœ¬çš„æƒè¡¡

---

### ğŸ¯ æœ€ä½³å®è·µ

å¯¹äºå¤§å¤šæ•°åº”ç”¨ï¼Œ**æ¨èä½¿ç”¨ VAD çš„ä½å»¶è¿Ÿé…ç½®**ï¼š

```yaml
vad:
  enabled: true
  mode: 1  # å¹³è¡¡å‡†ç¡®åº¦å’Œçµæ•åº¦
  speech_start_threshold: 2  # å¿«é€Ÿå¯åŠ¨ï¼ˆ40msï¼‰
  speech_end_threshold: 8    # åˆç†çš„ç»“æŸåˆ¤æ–­ï¼ˆ160msï¼‰
  pre_speech_padding_ms: 150  # å……è¶³çš„å‰ç½®ä¿æŠ¤
  post_speech_padding_ms: 200  # åˆç†çš„åç½®ä¿æŠ¤
```

**ä¼˜ç‚¹**ï¼š
- âœ… é¦–æ¬¡å»¶è¿Ÿ < 60msï¼ˆç”¨æˆ·å‡ ä¹æ— æ„ŸçŸ¥ï¼‰
- âœ… æŒç»­è¯­éŸ³é›¶å»¶è¿Ÿ
- âœ… èŠ‚çº¦ 30-40% ASR æˆæœ¬
- âœ… ä¿æŠ¤è¯­éŸ³å®Œæ•´æ€§ï¼ˆå‰åç¼“å†²ï¼‰
- âœ… å‡å°‘è¯¯è§¦å‘ï¼ˆmode=1ï¼‰

---

## è¯¦ç»†æµç¨‹

### 1. å‰ç«¯è§¦å‘å½•éŸ³

**ä½ç½®**: `electron-app/src/App.tsx`

å‰ç«¯é€šè¿‡ REST API è°ƒç”¨å¯åŠ¨å½•éŸ³ï¼š

```typescript
const startAsr = () => callAsrApi('/api/recording/start');
```

**å…³é”®ä»£ç **:
```typescript
const callAsrApi = async (endpoint: string) => {
  const response = await fetch(`${API_BASE_URL}${endpoint}`, { 
    method: 'POST' 
  });
  const data = await response.json();
  return data.success;
};
```

---

### 2. åç«¯APIæ¥æ”¶è¯·æ±‚

**ä½ç½®**: `src/api/server.py`

FastAPI æ¥æ”¶ POST è¯·æ±‚å¹¶è°ƒç”¨è¯­éŸ³æœåŠ¡ï¼š

```python
@app.post("/api/recording/start", response_model=StartRecordingResponse)
async def start_recording():
    if not voice_service:
        raise HTTPException(status_code=503, detail="è¯­éŸ³æœåŠ¡æœªåˆå§‹åŒ–")
    
    try:
        success = voice_service.start_recording()
        if success:
            return StartRecordingResponse(success=True, message="å½•éŸ³å·²å¼€å§‹")
        else:
            return StartRecordingResponse(success=False, message="å¯åŠ¨å½•éŸ³å¤±è´¥")
    except Exception as e:
        # é”™è¯¯å¤„ç†...
```

---

### 3. VoiceService å¯åŠ¨å½•éŸ³å’ŒASR

**ä½ç½®**: `src/services/voice_service.py`

`VoiceService.start_recording()` æ–¹æ³•æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼ˆæ–°æ¶æ„ï¼‰ï¼š

1. **è·å–äº‹ä»¶å¾ªç¯**
   - å°è¯•è·å–è¿è¡Œä¸­çš„äº‹ä»¶å¾ªç¯ï¼Œæˆ–åˆ›å»ºæ–°çš„äº‹ä»¶å¾ªç¯
   - å¤„ç†åŒæ­¥è°ƒç”¨å’Œå¼‚æ­¥è°ƒç”¨çš„å…¼å®¹æ€§

2. **è®¾ç½® AudioASRGateway å›è°ƒ**ï¼ˆæ§åˆ¶ASRå¯åœï¼‰
   ```python
   self.recorder.set_asr_gateway_callbacks(
       on_speech_start=self._on_speech_start,  # å¯åŠ¨ASR
       on_speech_end=self._on_speech_end        # åœæ­¢ASR
   )
   ```

3. **è®¾ç½®éŸ³é¢‘æ•°æ®å›è°ƒ**ï¼ˆå‘é€éŸ³é¢‘åˆ°ASRï¼‰
   ```python
   self.recorder.set_on_audio_chunk_callback(self._on_audio_chunk)
   ```

4. **å¯åŠ¨éŸ³é¢‘å½•åˆ¶å™¨**ï¼ˆAudioå…ˆè¡Œå¯åŠ¨ï¼Œä¿è¯ç¼“å†²ï¼‰
   ```python
   success = self.recorder.start_recording()
   ```
   è¿™ä¼šè§¦å‘ï¼š
   - Audio å¼€å§‹é‡‡é›†
   - AudioASRGateway.start() è¢«è°ƒç”¨
   - æ ¹æ® VAD é…ç½®ï¼š
     - `enabled=False`: ç«‹å³è§¦å‘ `on_speech_start()` â†’ å¯åŠ¨ASR
     - `enabled=True`: ç­‰å¾…æ£€æµ‹åˆ°è¯­éŸ³åè§¦å‘ `on_speech_start()` â†’ å¯åŠ¨ASR

**å…³é”®ä»£ç **:
```python
def start_recording(self) -> bool:
    # è·å–äº‹ä»¶å¾ªç¯
    try:
        self._loop = asyncio.get_running_loop()
        loop_running = True
    except RuntimeError:
        try:
            self._loop = asyncio.get_event_loop()
            loop_running = self._loop.is_running()
        except RuntimeError:
            self._loop = asyncio.new_event_loop()
            asyncio.set_event_loop(self._loop)
            loop_running = False
    
    # å¯åŠ¨æµå¼ ASR è¯†åˆ«
    if self.asr_provider:
        self.asr_provider.set_on_text_callback(self._on_asr_text_received)
        language = self.config.get('asr.language', 'zh-CN')
        
        if loop_running:
            async def start_async():
                result = await self.asr_provider.start_streaming_recognition(language)
                if result:
                    self._streaming_active = True
            
            asyncio.create_task(start_async())
            self._streaming_active = True
        else:
            if not self._loop.run_until_complete(
                self.asr_provider.start_streaming_recognition(language)
            ):
                return False
            self._streaming_active = True
        
        self.recorder.set_on_audio_chunk_callback(self._on_audio_chunk)
    
    # å¼€å§‹å½•éŸ³
    success = self.recorder.start_recording()
    if success:
        self._notify_state_change(RecordingState.RECORDING)
    return success
```

---

### 4. éŸ³é¢‘å½•åˆ¶å™¨åˆå§‹åŒ–

**ä½ç½®**: `src/utils/audio_recorder.py`

ä½¿ç”¨ `sounddevice` åº“åˆ›å»ºéŸ³é¢‘è¾“å…¥æµï¼š

**éŸ³é¢‘å‚æ•°**:
- **é‡‡æ ·ç‡**: 16000 Hz
- **å£°é“æ•°**: 1 (å•å£°é“)
- **æ ¼å¼**: PCM 16ä½ (`np.int16`)
- **å—å¤§å°**: 3200 å¸§/å—ï¼ˆæ¨èé…ç½®ï¼Œ200msï¼‰æˆ– 1024 å¸§/å—ï¼ˆé»˜è®¤å€¼ï¼Œ64msï¼‰

**å…³é”®ä»£ç **:
```python
def start_recording(self) -> bool:
    self.stream = sd.InputStream(
        samplerate=self.rate,        # 16000 Hz
        channels=self.channels,      # 1 (å•å£°é“)
        dtype=np.int16,              # PCM 16ä½
        blocksize=self.chunk,        # 1024 å¸§
        device=self.device,
        callback=self._audio_callback  # éŸ³é¢‘å›è°ƒå‡½æ•°
    )
    self.stream.start()
    
    # å¯åŠ¨éŸ³é¢‘æ¶ˆè´¹çº¿ç¨‹
    self.thread = threading.Thread(target=self._consume_audio, daemon=True)
    self.thread.start()
```

---

### 5. éŸ³é¢‘é‡‡é›†ï¼ˆå®æ—¶å¾ªç¯ï¼‰

**ä½ç½®**: `src/utils/audio_recorder.py`

`sounddevice` åº“ä¼šå®šæœŸè°ƒç”¨ `_audio_callback` å‡½æ•°ï¼š

**å›è°ƒé¢‘ç‡**: 
- æ¨èé…ç½®ï¼ˆ3200å¸§ï¼‰: çº¦æ¯ 200ms è°ƒç”¨ä¸€æ¬¡
- é»˜è®¤é…ç½®ï¼ˆ1024å¸§ï¼‰: çº¦æ¯ 64ms è°ƒç”¨ä¸€æ¬¡

**å…³é”®ä»£ç **:
```python
def _audio_callback(self, indata, frames, time, status):
    """éŸ³é¢‘å›è°ƒå‡½æ•° - ç”± sounddevice å®šæœŸè°ƒç”¨"""
    if self.running and not self.paused:
        audio_data = indata.tobytes()  # numpyæ•°ç»„è½¬bytes
        audio_size = len(audio_data)
        self.audio_queue.put(audio_data)  # æ”¾å…¥é˜Ÿåˆ—
        self._chunk_count += 1
        self._total_bytes += audio_size
```

**æ•°æ®æ ¼å¼**:
- `indata`: numpy æ•°ç»„ï¼Œå½¢çŠ¶ä¸º `(chunk, 1)`ï¼Œæ•°æ®ç±»å‹ä¸º `int16`
- è½¬æ¢ä¸º bytes: 
  - æ¨èé…ç½®ï¼ˆ3200å¸§ï¼‰: æ¯ä¸ªå—çº¦ 6400 å­—èŠ‚ï¼ˆ3200å¸§ Ã— 2å­—èŠ‚/æ ·æœ¬ï¼‰
  - é»˜è®¤é…ç½®ï¼ˆ1024å¸§ï¼‰: æ¯ä¸ªå—çº¦ 2048 å­—èŠ‚ï¼ˆ1024å¸§ Ã— 2å­—èŠ‚/æ ·æœ¬ï¼‰

---

### 6. éŸ³é¢‘æ¶ˆè´¹çº¿ç¨‹

**ä½ç½®**: `src/utils/audio_recorder.py`

ç‹¬ç«‹çš„çº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–å‡ºéŸ³é¢‘æ•°æ®å¹¶å¤„ç†ï¼š

**å…³é”®ä»£ç **:
```python
def _consume_audio(self):
    """æ¶ˆè´¹éŸ³é¢‘æ•°æ® - åœ¨ç‹¬ç«‹çº¿ç¨‹ä¸­è¿è¡Œ"""
    while self.running:
        try:
            data = self.audio_queue.get(timeout=0.1)
            if not self.paused:
                # ä¿å­˜åˆ°ç¼“å†²åŒºï¼ˆç”¨äºå®Œæ•´å½•éŸ³æ–‡ä»¶ï¼‰
                self.audio_buffer.extend(data)
                
                # ç¼“å†²åŒºå¤§å°ç®¡ç†ï¼šå¦‚æœè¶…è¿‡æœ€å¤§é™åˆ¶ï¼Œæ¸…ç†æ—§æ•°æ®
                buffer_size = len(self.audio_buffer)
                if buffer_size > self.max_buffer_size:
                    keep_size = self.max_buffer_size // 2
                    remove_size = buffer_size - keep_size
                    self.audio_buffer = self.audio_buffer[remove_size:]
                
                # å®æ—¶å‘é€éŸ³é¢‘æ•°æ®å—ï¼ˆç”¨äºæµå¼ ASRï¼‰
                if self.on_audio_chunk:
                    # é€šè¿‡AudioASRGatewayå¤„ç†éŸ³é¢‘æ•°æ®
                    if self.asr_gateway:
                        processed_data = self.asr_gateway.process(data)
                        # åªå‘é€éNoneçš„æ•°æ®ï¼ˆNoneè¡¨ç¤ºé™éŸ³ï¼Œä¸å‘é€ï¼‰
                        if processed_data is not None:
                            self.on_audio_chunk(processed_data)
                    else:
                        # AudioASRGatewayæœªåˆå§‹åŒ–ï¼Œç›´æ¥å‘é€åŸå§‹æ•°æ®
                        self.on_audio_chunk(data)
        except queue.Empty:
            continue
```

**ä½œç”¨**:
- ä»é˜Ÿåˆ—ä¸­å–å‡ºéŸ³é¢‘å—
- ä¿å­˜åˆ°ç¼“å†²åŒºï¼ˆç”¨äºå®Œæ•´å½•éŸ³ä¿å­˜ï¼‰
- **ç¼“å†²åŒºç®¡ç†**ï¼šè¶…è¿‡æœ€å¤§ç¼“å†²æ—¶é•¿ï¼ˆé»˜è®¤60ç§’ï¼‰æ—¶è‡ªåŠ¨æ¸…ç†æ—§æ•°æ®
- **VADè¿‡æ»¤**ï¼šå¦‚æœå¯ç”¨VADï¼Œå…ˆè¿‡æ»¤é™éŸ³åå†å‘é€
- è°ƒç”¨å›è°ƒå‡½æ•°ï¼Œå®æ—¶å‘é€ç»™ ASR

---

### 6.5 AudioASRGatewayï¼ˆAudioåˆ°ASRçš„ç½‘å…³ï¼‰

**ä½ç½®**: `src/utils/audio_asr_gateway.py`

AudioASRGateway ä½œä¸º Audio å’Œ ASR ä¹‹é—´çš„ç»Ÿä¸€ç½‘å…³æ§åˆ¶å™¨ï¼Œè´Ÿè´£ï¼š
1. **æ§åˆ¶ASRå¯åœ**ï¼šæ ¹æ®è¯­éŸ³æ´»åŠ¨æˆ–é…ç½®å†³å®šä½•æ—¶å¯åŠ¨/åœæ­¢ASR
2. **è¯­éŸ³æ´»åŠ¨æ£€æµ‹**ï¼ˆVADï¼Œå¯é€‰ï¼‰ï¼šå½“ `enabled=True` æ—¶æ£€æµ‹è¯­éŸ³
3. **éŸ³é¢‘æµè½¬å‘**ï¼šå°†å¤„ç†åçš„éŸ³é¢‘æ•°æ®ä¼ é€’ç»™ASR

**å·¥ä½œæ¨¡å¼**ï¼š

- **VAD enabled (`audio.vad.enabled: true`)**:
  - æ£€æµ‹è¯­éŸ³æ´»åŠ¨
  - æ£€æµ‹åˆ°è¯­éŸ³ â†’ è§¦å‘ `on_speech_start()` â†’ å¯åŠ¨ASR
  - æ£€æµ‹åˆ°é™éŸ³ â†’ è§¦å‘ `on_speech_end()` â†’ åœæ­¢ASRï¼ˆèŠ‚çº¦æˆæœ¬ï¼‰
  - åªä¼ é€’åŒ…å«è¯­éŸ³çš„éŸ³é¢‘æ•°æ®

- **VAD disabled (`audio.vad.enabled: false`)**:
  - æŒç»­è¾“å‡ºæœ‰æ•ˆä¿¡å·
  - åˆå§‹åŒ–æ—¶ç«‹å³è§¦å‘ `on_speech_start()` â†’ å¯åŠ¨ASR
  - æŒç»­ä¼ é€’æ‰€æœ‰éŸ³é¢‘æ•°æ®ï¼ˆä¸è¿‡æ»¤ï¼‰
  - ç›´åˆ° `stop()` è¢«è°ƒç”¨æ‰è§¦å‘ `on_speech_end()`

å¦‚æœé…ç½®ä¸­å¯ç”¨äº†VADï¼ˆ`audio.vad.enabled: true`ï¼‰ï¼ŒéŸ³é¢‘æ•°æ®ä¼šåœ¨éŸ³é¢‘æ¶ˆè´¹çº¿ç¨‹ä¸­é€šè¿‡AudioASRGatewayå¤„ç†ï¼Œç„¶åæ‰å‘é€åˆ°VoiceServiceï¼š

**å¤„ç†æµç¨‹**:
1. **å¸§æ‹†åˆ†**: å°†éŸ³é¢‘å—ï¼ˆå¦‚200mså—ï¼‰æ‹†åˆ†ä¸º20mså°å¸§ï¼ˆWebRTC VADè¦æ±‚ï¼‰
2. **VADæ£€æµ‹**: å¯¹æ¯ä¸ª20mså¸§è¿›è¡Œè¯­éŸ³æ´»åŠ¨æ£€æµ‹
3. **çŠ¶æ€æœºç®¡ç†**: ä½¿ç”¨çŠ¶æ€æœºç®¡ç†è¯­éŸ³/é™éŸ³è½¬æ¢ï¼Œé€šè¿‡å‰åç¼“å†²æœºåˆ¶é¿å…æˆªæ–­
4. **è¿‡æ»¤**: åªè¿”å›åŒ…å«è¯­éŸ³çš„éŸ³é¢‘æ•°æ®ï¼Œé™éŸ³éƒ¨åˆ†è¿”å›None

**å…³é”®ä»£ç **:
```python
def process(self, audio_data: bytes) -> Optional[bytes]:
    """å¤„ç†éŸ³é¢‘æ•°æ®ï¼Œè¿”å›è¿‡æ»¤åçš„æ•°æ®"""
    # å¦‚æœVADæœªå¯ç”¨ï¼Œç›´æ¥è¿”å›åŸå§‹æ•°æ®
    if not self.enabled:
        return audio_data
    
    # æ·»åŠ åˆ°è¾“å…¥ç¼“å†²åŒº
    self.input_buffer.extend(audio_data)
    
    # å¤„ç†å®Œæ•´çš„20mså¸§
    result = bytearray()
    while len(self.input_buffer) >= self.frame_bytes:
        # æå–ä¸€ä¸ªå®Œæ•´çš„å¸§
        frame = bytes(self.input_buffer[:self.frame_bytes])
        self.input_buffer = self.input_buffer[self.frame_bytes:]
        
        # VADæ£€æµ‹
        is_speech = self._detect_speech(frame)
        
        # çŠ¶æ€æœºå¤„ç†
        processed_frame = self._update_state(is_speech, frame)
        if processed_frame:
            result.extend(processed_frame)
    
    # è¿”å›å¤„ç†ç»“æœï¼ˆNoneè¡¨ç¤ºå…¨éƒ¨ä¸ºé™éŸ³ï¼‰
    return bytes(result) if result else None
```

**é›†æˆæ–¹å¼**:
AudioASRGatewayé›†æˆåœ¨ `audio_recorder.py` çš„ `_consume_audio` æ–¹æ³•ä¸­ï¼š
```python
# é€šè¿‡AudioASRGatewayå¤„ç†éŸ³é¢‘æ•°æ®
if self.asr_gateway:
    processed_data = self.asr_gateway.process(data)
    # åªå‘é€éNoneçš„æ•°æ®ï¼ˆNoneè¡¨ç¤ºé™éŸ³ï¼Œä¸å‘é€ï¼‰
    if processed_data is not None:
        self.on_audio_chunk(processed_data)
else:
    # AudioASRGatewayæœªåˆå§‹åŒ–ï¼Œç›´æ¥å‘é€åŸå§‹æ•°æ®
    self.on_audio_chunk(data)
```

**ä½œç”¨**:
- âœ… **ç»Ÿä¸€ç½‘å…³**ï¼šAudio å’Œ ASR ä¹‹é—´çš„ç»Ÿä¸€æ§åˆ¶å±‚
- âœ… **æ§åˆ¶ASRå¯åœ**ï¼šæ ¹æ®è¯­éŸ³æ´»åŠ¨æˆ–é…ç½®åŠ¨æ€æ§åˆ¶ASR
- âœ… **è¯­éŸ³æ´»åŠ¨æ£€æµ‹**ï¼ˆVAD enabledæ—¶ï¼‰ï¼šè¿‡æ»¤é™éŸ³å’Œéè¯­éŸ³éŸ³é¢‘
- âœ… **æˆæœ¬æ§åˆ¶**ï¼šVAD enabledæ—¶å‡å°‘ASRè°ƒç”¨ï¼ˆé¢„è®¡èŠ‚çº¦40-60%æˆæœ¬ï¼‰
- âœ… **çµæ´»é…ç½®**ï¼šæ”¯æŒVAD enabledï¼ˆåŠ¨æ€æ§åˆ¶ï¼‰å’Œdisabledï¼ˆæŒç»­è¿è¡Œï¼‰ä¸¤ç§æ¨¡å¼
- âœ… **é¿å…æˆªæ–­**ï¼šä½¿ç”¨çŠ¶æ€æœºå’Œå‰åç¼“å†²æœºåˆ¶

**æ³¨æ„**: VADé»˜è®¤å…³é—­ï¼Œéœ€è¦åœ¨ `config.yml` ä¸­é…ç½®å¯ç”¨ã€‚é…ç½®ç¤ºä¾‹ï¼š
```yaml
audio:
  vad:
    enabled: true  # å¯ç”¨VADï¼ˆåŠ¨æ€æ§åˆ¶ASRï¼‰
    mode: 2        # æ•æ„Ÿåº¦ï¼ˆ0-3ï¼‰
```

å½“ `enabled: false` æ—¶ï¼ŒAudioASRGatewayä»¥ç›´é€šæ¨¡å¼è¿è¡Œï¼ŒASRæŒç»­è¿è¡Œã€‚

---

### 7. VoiceService æ¥æ”¶éŸ³é¢‘æ•°æ®å—

**ä½ç½®**: `src/services/voice_service.py`

`_on_audio_chunk` æ–¹æ³•æ¥æ”¶éŸ³é¢‘æ•°æ®å¹¶å‘é€ç»™ ASR æä¾›è€…ï¼š

**å…³é”®ä»£ç **:
```python
def _on_audio_chunk(self, audio_data: bytes):
    """éŸ³é¢‘æ•°æ®å—å›è°ƒ"""
    # å¦‚æœå½•éŸ³å™¨å¤„äºæš‚åœçŠ¶æ€ï¼Œä¸å‘é€éŸ³é¢‘æ•°æ®
    if self.recorder and self.recorder.get_state() == RecordingState.PAUSED:
        return
    
    if self._streaming_active and self.asr_provider and self._loop:
        try:
            if not self._loop.is_closed():
                if self._loop.is_running():
                    # äº‹ä»¶å¾ªç¯æ­£åœ¨è¿è¡Œï¼Œä½¿ç”¨çº¿ç¨‹å®‰å…¨çš„æ–¹å¼
                    asyncio.run_coroutine_threadsafe(
                        self.asr_provider.send_audio_chunk(audio_data),
                        self._loop
                    )
                else:
                    self._loop.run_until_complete(
                        self.asr_provider.send_audio_chunk(audio_data)
                    )
        except Exception as e:
            logger.error(f"å‘é€éŸ³é¢‘æ•°æ®å—å¤±è´¥: {str(e)}")
```

**å…³é”®ç‚¹**:
- æ£€æŸ¥å½•éŸ³çŠ¶æ€ï¼ˆæš‚åœæ—¶ä¸å‘é€ï¼‰
- ä½¿ç”¨ `asyncio.run_coroutine_threadsafe` ç¡®ä¿çº¿ç¨‹å®‰å…¨
- å°†åŒæ­¥çš„éŸ³é¢‘å›è°ƒè½¬æ¢ä¸ºå¼‚æ­¥è°ƒç”¨

---

### 8. ASR æä¾›è€…æ¥æ”¶éŸ³é¢‘æ•°æ®

**ä½ç½®**: `src/providers/asr/volcano.py`

`send_audio_chunk` æ–¹æ³•å°†éŸ³é¢‘æ•°æ®æ”¾å…¥å¼‚æ­¥é˜Ÿåˆ—ï¼š

**å…³é”®ä»£ç **:
```python
async def send_audio_chunk(self, audio_data: bytes):
    """å‘é€éŸ³é¢‘æ•°æ®å—"""
    if not self._streaming_active or not self._audio_queue:
        return
    
    try:
        await self._audio_queue.put(audio_data)
    except Exception as e:
        logger.error(f"éŸ³é¢‘æ•°æ®å…¥é˜Ÿå¤±è´¥: {e}")
```

**é˜Ÿåˆ—ä½œç”¨**:
- è§£è€¦éŸ³é¢‘é‡‡é›†å’Œ WebSocket å‘é€
- å…è®¸å‘é€ä»»åŠ¡ä»¥ä¸åŒé€Ÿç‡å¤„ç†æ•°æ®
- ç¼“å†²éŸ³é¢‘æ•°æ®ï¼Œé¿å…é˜»å¡

---

### 9. éŸ³é¢‘å‘é€ä»»åŠ¡ï¼ˆWebSocketï¼‰

**ä½ç½®**: `src/providers/asr/volcano.py`

å¼‚æ­¥ä»»åŠ¡ä»é˜Ÿåˆ—ä¸­å–å‡ºéŸ³é¢‘æ•°æ®å¹¶é€šè¿‡ WebSocket å‘é€ï¼š

**å…³é”®ä»£ç **:
```python
async def _audio_sender(self):
    """éŸ³é¢‘å‘é€ä»»åŠ¡ - å¼‚æ­¥è¿è¡Œ"""
    last_audio = None
    
    while True:
        audio_data = await self._audio_queue.get()
        
        if not self._is_conn_available():
            break
        
        if audio_data is None:  # ç»“æŸæ ‡è®°
            # å‘é€æœ€åä¸€åŒ…
            if last_audio is not None:
                request = RequestBuilder.new_audio_only_request(
                    self.seq, last_audio, is_last=True
                )
                await self.conn.send_bytes(request)
            break
        
        # å‘é€ä¸Šä¸€åŒ…æ•°æ®ï¼ˆå»¶è¿Ÿä¸€åŒ…ï¼Œç¡®ä¿æœ€åä¸€åŒ…èƒ½æ­£ç¡®æ ‡è®°ï¼‰
        if last_audio is not None:
            request = RequestBuilder.new_audio_only_request(
                self.seq, last_audio, is_last=False
            )
            await self.conn.send_bytes(request)
            self.seq += 1
        
        last_audio = audio_data
```

**åè®®æ ¼å¼**:
- ä½¿ç”¨ç«å±±å¼•æ“è‡ªå®šä¹‰äºŒè¿›åˆ¶åè®®
- éŸ³é¢‘æ•°æ®ç»è¿‡ GZIP å‹ç¼©
- åŒ…å«åºåˆ—å·å’Œç»“æŸæ ‡è®°

---

### 10. ç«å±±å¼•æ“ ASR æœåŠ¡

**æœåŠ¡åœ°å€**: `wss://openspeech.bytedance.com/api/v3/sauc/bigmodel`

**å¤„ç†æµç¨‹**:
1. æ¥æ”¶ WebSocket éŸ³é¢‘æµ
2. å®æ—¶è¿›è¡Œè¯­éŸ³è¯†åˆ«
3. è¿”å›è¯†åˆ«ç»“æœï¼ˆä¸­é—´ç»“æœå’Œæœ€ç»ˆç»“æœï¼‰

**è¯†åˆ«æ¨¡å¼**:
- **æµå¼è¯†åˆ«**: å®æ—¶è¿”å›ä¸­é—´ç»“æœï¼ˆé»˜è®¤æ¨¡å¼ï¼‰
- **éæµå¼è¯†åˆ«** (å¯é€‰): é€šè¿‡é…ç½® `enable_nonstream=True` å¯ç”¨ï¼Œè¿”å›æ›´å‡†ç¡®çš„æœ€ç»ˆç»“æœ
  - éæµå¼æ¨¡å‹ä¼šå¯¹è¯­éŸ³ç‰‡æ®µé‡æ–°è¯†åˆ«ï¼Œå‡†ç¡®ç‡æ›´é«˜
  - ç»“æœé€šè¿‡ `utterances` ä¸­çš„ `definite=true` æ ‡è®°
  - é€‚ç”¨äºå¯¹å‡†ç¡®ç‡è¦æ±‚è¾ƒé«˜çš„åœºæ™¯

---

### 11. ASR æ¥æ”¶ä»»åŠ¡

**ä½ç½®**: `src/providers/asr/volcano.py`

å¼‚æ­¥ä»»åŠ¡æ¥æ”¶ WebSocket æ¶ˆæ¯å¹¶è§£æè¯†åˆ«ç»“æœï¼š

**å…³é”®ä»£ç **:
```python
async def _audio_receiver(self):
    """éŸ³é¢‘æ¥æ”¶ä»»åŠ¡ - å¼‚æ­¥è¿è¡Œ"""
    try:
        async for msg in self.conn:
            if msg.type == aiohttp.WSMsgType.BINARY:
                # è§£æå“åº”
                response = ResponseParser.parse_response(msg.data)
                
                if response.payload_msg:
                    result = response.payload_msg.get('result', {})
                    if isinstance(result, dict):
                        text = result.get('text', '')
                        if text:
                            # å¤„ç†è¯†åˆ«ç»“æœ
                            self._handle_recognition_result(result, response.is_last_package)
                
                # é”™è¯¯å¤„ç†
                if response.code != 0:
                    if response.code != 45000081:  # å¿½ç•¥è¿æ¥è¶…æ—¶é”™è¯¯ç 
                        logger.error(f"[ASR-WS] âœ— é”™è¯¯ç  {response.code}")
                    break
                
                # æœ€åä¸€åŒ…ï¼Œç»“æŸæ¥æ”¶
                if response.is_last_package:
                    break
                    
            elif msg.type in (aiohttp.WSMsgType.ERROR, aiohttp.WSMsgType.CLOSED):
                logger.warning("[ASR-WS] âš  WebSocketè¿æ¥å·²å…³é—­æˆ–å‡ºé”™")
                break
    except asyncio.CancelledError:
        pass
    except Exception as e:
        logger.error(f"[ASR-WS] âœ— æ¥æ”¶ä»»åŠ¡å¼‚å¸¸: {e}")
    finally:
        await self._disconnect()
```

**å“åº”æ ¼å¼**:
- äºŒè¿›åˆ¶æ¶ˆæ¯ï¼ŒåŒ…å«åè®®å¤´å’Œå‹ç¼©çš„ JSON æ•°æ®
- éœ€è¦è§£å‹ï¼ˆGZIPï¼‰å’Œè§£æ JSON
- åŒ…å«æ–‡æœ¬ã€æ—¶é—´ä¿¡æ¯ã€ç¡®å®šæ ‡è®°ï¼ˆ`definite`ï¼‰ã€é”™è¯¯ç ç­‰
- `is_last_package`: æ ‡è¯†æ˜¯å¦ä¸ºæœ€åä¸€åŒ…
- `code`: é”™è¯¯ç ï¼ˆ0è¡¨ç¤ºæˆåŠŸï¼‰

---

### 12. è¯†åˆ«ç»“æœå¤„ç†

**ä½ç½®**: `src/providers/asr/volcano.py`

`_handle_recognition_result` æ–¹æ³•å¤„ç†è¯†åˆ«ç»“æœï¼š

**å…³é”®ä»£ç **:
```python
def _handle_recognition_result(self, result: dict, is_last_package: bool):
    """å¤„ç†è¯†åˆ«ç»“æœ"""
    text = result.get('text', '')
    if not text:
        return
    
    # æ£€æµ‹æ˜¯å¦ä¸ºç¡®å®šçš„utteranceï¼ˆåŸºäºutterancesä¸­çš„definiteå­—æ®µï¼‰
    is_definite_utterance, time_info = self._detect_definite_utterance(result, text)
    
    # æ›´æ–°å†…éƒ¨çŠ¶æ€
    self._last_text = text
    self._current_text = text
    
    # æ—¥å¿—è®°å½•
    if is_definite_utterance:
        logger.info(f"[ASR] ç¡®å®šç»“æœ: '{text}'")
    elif is_last_package:
        logger.info(f"[ASR] æœ€ç»ˆç»“æœ: '{text}'")
    
    # è°ƒç”¨å›è°ƒå‡½æ•°
    if self._on_text_callback:
        self._on_text_callback(text, is_definite_utterance, time_info)
```

**ç»“æœç±»å‹**:
- **ä¸­é—´ç»“æœ** (`is_definite_utterance=False`): å®æ—¶æ›´æ–°çš„æ–‡æœ¬ï¼ŒASRæœåŠ¡å®æ—¶è¿”å›
- **ç¡®å®šç»“æœ** (`is_definite_utterance=True`): å®Œæ•´çš„ã€ç¡®å®šçš„è¯­éŸ³è¯†åˆ«å•å…ƒï¼ŒåŸºäº `utterances` ä¸­çš„ `definite` å­—æ®µåˆ¤æ–­
  - å½“ `enable_nonstream=True` æ—¶ï¼Œ`definite=true` è¡¨ç¤ºéæµå¼æ¨¡å‹é‡æ–°è¯†åˆ«çš„å‡†ç¡®ç»“æœï¼ˆå‡†ç¡®ç‡æ›´é«˜ï¼‰
  - åŒ…å«æ—¶é—´ä¿¡æ¯ï¼ˆ`start_time` å’Œ `end_time`ï¼Œå•ä½ä¸ºæ¯«ç§’ï¼‰

---

### 13. VoiceService æ¥æ”¶è¯†åˆ«ç»“æœ

**ä½ç½®**: `src/services/voice_service.py`

`_on_asr_text_received` æ–¹æ³•æ¥æ”¶è¯†åˆ«ç»“æœå¹¶è°ƒç”¨å›è°ƒï¼š

**å…³é”®ä»£ç **:
```python
def _on_asr_text_received(self, text: str, is_definite_utterance: bool, time_info: dict):
    """ASRæ–‡æœ¬æ¥æ”¶å›è°ƒ"""
    if is_definite_utterance:
        time_info_str = ""
        if time_info:
            time_info_str = f", start_time={time_info.get('start_time', 0)}ms, end_time={time_info.get('end_time', 0)}ms"
        logger.info(f"[è¯­éŸ³æœåŠ¡] æ”¶åˆ°ç¡®å®šutterance: '{text}'{time_info_str}")
    
    # æ›´æ–°å½“å‰æ–‡æœ¬ï¼ˆç”¨äºæœ€ç»ˆç»“æœè·å–ï¼‰
    self._current_text = text
    
    # è°ƒç”¨ä¸Šå±‚å›è°ƒï¼ˆAPIæœåŠ¡å™¨çš„å›è°ƒï¼‰
    if self._on_text_callback:
        self._on_text_callback(text, is_definite_utterance, time_info)
```

---

### 14. API æœåŠ¡å™¨å¹¿æ’­

**ä½ç½®**: `src/api/server.py`

åœ¨ `setup_voice_service()` ä¸­è®¾ç½®çš„å›è°ƒå‡½æ•°ï¼š

**å…³é”®ä»£ç **:
```python
def on_text_callback(text: str, is_definite: bool, time_info: dict):
    """æ–‡æœ¬å›è°ƒå‡½æ•°"""
    message = {
        "type": "text_final" if is_definite else "text_update",
        "text": text
    }
    if is_definite and time_info:
        message["start_time"] = time_info.get('start_time', 0)
        message["end_time"] = time_info.get('end_time', 0)
    
    # å¹¿æ’­ç»™æ‰€æœ‰ WebSocket è¿æ¥
    broadcast(message)

voice_service.set_on_text_callback(on_text_callback)
```

**æ¶ˆæ¯ç±»å‹**:
- `text_update`: ä¸­é—´è¯†åˆ«ç»“æœï¼ˆå®æ—¶æ›´æ–°ï¼‰
- `text_final`: ç¡®å®šçš„å®Œæ•´utteranceï¼ˆåŒ…å«æ—¶é—´ä¿¡æ¯ï¼‰

---

### 15. å‰ç«¯æ¥æ”¶å¹¶æ˜¾ç¤º

**ä½ç½®**: `electron-app/src/App.tsx`

å‰ç«¯é€šè¿‡ WebSocket æ¥æ”¶æ¶ˆæ¯å¹¶æ›´æ–° UIï¼š

**å…³é”®ä»£ç **:
```typescript
ws.onmessage = (event) => {
  try {
    const data = JSON.parse(event.data);
    
    switch (data.type) {
      case 'initial_state':
        // è¿æ¥å»ºç«‹æ—¶æ¥æ”¶åˆå§‹çŠ¶æ€
        setAsrState(data.state);
        if (data.text) setText(data.text);
        break;
      
      case 'text_update':
        // ä¸­é—´ç»“æœï¼ˆå®æ—¶æ›´æ–°ï¼‰
        blockEditorRef.current?.appendAsrText(
          data.text || '',
          false  // isFinal = false
        );
        break;
      
      case 'text_final':
        // ç¡®å®šçš„ç»“æœï¼ˆå®Œæ•´utteranceï¼‰- åŒ…å«æ—¶é—´ä¿¡æ¯
        blockEditorRef.current?.appendAsrText(
          data.text || '',
          true,  // isFinal = true
          {
            startTime: data.start_time,
            endTime: data.end_time
          }
        );
        break;
      
      case 'state_change':
        setAsrState(data.state);
        break;
      
      case 'error':
        // é”™è¯¯å¤„ç†
        setSystemError(data.error || {
          message: data.message,
          error_type: data.error_type
        });
        break;
    }
  } catch (e) {
    console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', e);
  }
};
```

**å…³é”®ç‚¹**:
- `initial_state`: è¿æ¥å»ºç«‹æ—¶å‘é€ï¼Œç”¨äºåŒæ­¥å½“å‰çŠ¶æ€
- `text_update`: ä¸­é—´è¯†åˆ«ç»“æœï¼Œå®æ—¶æ›´æ–°åˆ°ç¼–è¾‘å™¨
- `text_final`: ç¡®å®šçš„å®Œæ•´utteranceï¼ŒåŒ…å«æ—¶é—´ä¿¡æ¯
- ä½¿ç”¨ `blockEditorRef.current?.appendAsrText` æ›´æ–°ç¼–è¾‘å™¨å†…å®¹ï¼ˆæ”¯æŒå—ç¼–è¾‘å™¨æ ¼å¼ï¼‰

---

## å…³é”®æŠ€æœ¯ç‚¹

### 1. éŸ³é¢‘æ ¼å¼è§„èŒƒ

| å‚æ•° | å€¼ | è¯´æ˜ |
|------|-----|------|
| é‡‡æ ·ç‡ | 16000 Hz | æ ‡å‡†è¯­éŸ³è¯†åˆ«é‡‡æ ·ç‡ |
| å£°é“æ•° | 1 | å•å£°é“ |
| ä½æ·±åº¦ | 16ä½ | PCMæ ¼å¼ |
| å—å¤§å° | 3200å¸§ï¼ˆæ¨èï¼‰ | çº¦200msçš„éŸ³é¢‘æ•°æ®ï¼ˆ6400å­—èŠ‚ï¼‰ |
| å—å¤§å° | 1024å¸§ï¼ˆé»˜è®¤ï¼‰ | çº¦64msçš„éŸ³é¢‘æ•°æ®ï¼ˆ2048å­—èŠ‚ï¼‰ |
| ç¼“å†²åŒºé™åˆ¶ | 60ç§’ï¼ˆé»˜è®¤ï¼‰ | è¶…è¿‡åè‡ªåŠ¨æ¸…ç†æ—§æ•°æ®ï¼Œé˜²æ­¢å†…å­˜æº¢å‡º |

**ç¼“å†²åŒºç®¡ç†**:
- é»˜è®¤æœ€å¤§ç¼“å†²æ—¶é•¿ï¼š60ç§’ï¼ˆçº¦1.92MBï¼‰
- è¶…è¿‡é™åˆ¶æ—¶ï¼šä¿ç•™æœ€æ–°çš„ä¸€åŠæ•°æ®ï¼Œåˆ é™¤æ—§çš„ä¸€åŠ
- é¿å…é•¿æ—¶é—´å½•éŸ³å¯¼è‡´å†…å­˜å ç”¨è¿‡é«˜

### 2. æµå¼å¤„ç†æ¶æ„

```
éŸ³é¢‘é‡‡é›† (åŒæ­¥å›è°ƒï¼ŒAudioå…ˆè¡Œå¯åŠ¨)
    â†“
é˜Ÿåˆ—ç¼“å†² (è§£è€¦)
    â†“
æ¶ˆè´¹çº¿ç¨‹ (åŒæ­¥å¤„ç†)
    â†“
AudioASRGateway (ç»Ÿä¸€ç½‘å…³)
    â”œâ”€ enabled=True: VADæ£€æµ‹ â†’ åŠ¨æ€æ§åˆ¶ASRå¯åœ
    â””â”€ enabled=False: ç›´é€šæ¨¡å¼ â†’ ASRæŒç»­è¿è¡Œ
    â†“
ç¼“å†²åŒºç®¡ç† (è‡ªåŠ¨æ¸…ç†è¶…è¿‡60ç§’çš„æ—§æ•°æ®)
    â†“
å›è°ƒå‡½æ•° (åŒæ­¥â†’å¼‚æ­¥è½¬æ¢)
    â†“
å¼‚æ­¥é˜Ÿåˆ— (è§£è€¦)
    â†“
WebSocketå‘é€ (å¼‚æ­¥)
    â†“
ASRæœåŠ¡è¯†åˆ«
    â†“
WebSocketæ¥æ”¶ (å¼‚æ­¥)
    â†“
ç»“æœå¤„ç†ä¸å¹¿æ’­
```

### 3. å¼‚æ­¥å¹¶å‘è®¾è®¡

- **å‘é€ä»»åŠ¡** (`_audio_sender`): ç‹¬ç«‹å¼‚æ­¥ä»»åŠ¡ï¼Œè´Ÿè´£å‘é€éŸ³é¢‘æ•°æ®
- **æ¥æ”¶ä»»åŠ¡** (`_audio_receiver`): ç‹¬ç«‹å¼‚æ­¥ä»»åŠ¡ï¼Œè´Ÿè´£æ¥æ”¶è¯†åˆ«ç»“æœ
- **å®Œå…¨å¹¶å‘**: å‘é€å’Œæ¥æ”¶äº’ä¸é˜»å¡

### 4. çº¿ç¨‹å®‰å…¨å¤„ç†

- éŸ³é¢‘å›è°ƒåœ¨ç³»ç»Ÿçº¿ç¨‹ä¸­è¿è¡Œï¼ˆåŒæ­¥ï¼‰
- ä½¿ç”¨ `asyncio.run_coroutine_threadsafe` è½¬æ¢ä¸ºå¼‚æ­¥è°ƒç”¨
- ç¡®ä¿äº‹ä»¶å¾ªç¯å®‰å…¨

### 5. çŠ¶æ€ç®¡ç†

**å½•éŸ³çŠ¶æ€æµè½¬**:
```
idle â†’ recording â†’ stopping â†’ idle
         â†‘    â†“
         â””â”€ paused
```

**çŠ¶æ€æ£€æŸ¥ç‚¹**:
- æš‚åœæ—¶ä¸å‘é€éŸ³é¢‘æ•°æ®
- åœæ­¢æ—¶å‘é€ç»“æŸæ ‡è®°
- çŠ¶æ€å˜åŒ–é€šè¿‡ WebSocket åŒæ­¥

---

## æ•°æ®æµå›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯ (Electron)                                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  App.tsx                                                  â”‚  â”‚
â”‚  â”‚  POST /api/recording/start                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚ HTTP
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  åç«¯ API (FastAPI)                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  server.py                                                â”‚  â”‚
â”‚  â”‚  voice_service.start_recording()                         â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VoiceService                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  1. è®¾ç½® AudioASRGateway å›è°ƒ                             â”‚  â”‚
â”‚  â”‚  2. è®¾ç½®éŸ³é¢‘æ•°æ®å›è°ƒ                                       â”‚  â”‚
â”‚  â”‚  3. å¯åŠ¨å½•éŸ³å™¨ï¼ˆAudioå…ˆè¡Œï¼‰                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  éŸ³é¢‘å½•åˆ¶å™¨ (Audioå…ˆè¡Œå¯åŠ¨)                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  sounddevice InputStream                                 â”‚  â”‚
â”‚  â”‚  éŸ³é¢‘é‡‡é›† â†’ é˜Ÿåˆ— â†’ æ¶ˆè´¹çº¿ç¨‹                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
                        â”‚ éŸ³é¢‘æ•°æ®å— (200ms)
                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AudioASRGatewayï¼ˆç»Ÿä¸€ç½‘å…³ï¼Œæ§åˆ¶ASRå¯åœï¼‰                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  enabled=True (VADæ¨¡å¼):                                  â”‚  â”‚
â”‚  â”‚  - æ£€æµ‹è¯­éŸ³ â†’ on_speech_start() â†’ å¯åŠ¨ASR                â”‚  â”‚
â”‚  â”‚  - æ£€æµ‹é™éŸ³ â†’ on_speech_end() â†’ åœæ­¢ASR                  â”‚  â”‚
â”‚  â”‚  - åªä¼ é€’è¯­éŸ³éŸ³é¢‘                                         â”‚  â”‚
â”‚  â”‚                                                           â”‚  â”‚
â”‚  â”‚  enabled=False (ç›´é€šæ¨¡å¼):                                â”‚  â”‚
â”‚  â”‚  - ç«‹å³ on_speech_start() â†’ å¯åŠ¨ASR                      â”‚  â”‚
â”‚  â”‚  - ä¼ é€’æ‰€æœ‰éŸ³é¢‘                                           â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                               â”‚
        â”‚ è¿‡æ»¤åçš„éŸ³é¢‘                   â”‚ ASRæ§åˆ¶å›è°ƒ
        â”‚ (æˆ–Noneï¼Œè¡¨ç¤ºå…¨éƒ¨é™éŸ³)         â”‚ (on_speech_start/end)
        â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VoiceService      â”‚         â”‚  VoiceService      â”‚
â”‚  _on_audio_chunk() â”‚         â”‚  _on_speech_start â”‚
â”‚                    â”‚         â”‚  _on_speech_end   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                             â”‚
          â”‚                             â”‚ å¯åŠ¨/åœæ­¢ASR
          â”‚                             â–¼
          â”‚                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                   â”‚  ASR æä¾›è€…       â”‚
          â”‚                   â”‚  (Volcano)        â”‚
          â”‚                   â”‚  WebSocketè¿æ¥    â”‚
          â”‚                   â”‚  å‘é€/æ¥æ”¶ä»»åŠ¡    â”‚
          â”‚                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                             â”‚
          â”‚ éŸ³é¢‘æ•°æ®                     â”‚ WebSocket
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                                        â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  ç«å±±å¼•æ“ ASR      â”‚
                          â”‚  æœåŠ¡              â”‚
                          â”‚  å®æ—¶è¯†åˆ«          â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â”‚ è¯†åˆ«ç»“æœ
                                    â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  VoiceService      â”‚
                          â”‚  _on_asr_text_    â”‚
                          â”‚    received()      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                                    â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  API æœåŠ¡å™¨       â”‚
                          â”‚  broadcast()      â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ WebSocket
                                    â–¼
                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                          â”‚  å‰ç«¯æ˜¾ç¤º          â”‚
                          â”‚  æ›´æ–° UI           â”‚
                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ä»£ç ä½ç½®

### æ ¸å¿ƒæ–‡ä»¶

| æ–‡ä»¶è·¯å¾„ | è¯´æ˜ |
|---------|------|
| `src/utils/audio_recorder.py` | éŸ³é¢‘å½•åˆ¶å™¨å®ç°ï¼ˆsounddeviceï¼‰ |
| `src/utils/audio_asr_gateway.py` | Audioåˆ°ASRçš„ç½‘å…³æ§åˆ¶å™¨ï¼ˆç»Ÿä¸€æ§åˆ¶å±‚ï¼‰ |
| `src/services/voice_service.py` | è¯­éŸ³æœåŠ¡ä¸»ç±»ï¼ˆæ•´åˆå½•éŸ³å’ŒASRï¼‰ |
| `src/providers/asr/volcano.py` | ç«å±±å¼•æ“ ASR æä¾›è€… |
| `src/api/server.py` | FastAPI æœåŠ¡å™¨å’Œ WebSocket å¤„ç† |
| `electron-app/src/App.tsx` | å‰ç«¯ä¸»åº”ç”¨ |

### å…³é”®æ–¹æ³•

| æ–¹æ³• | æ–‡ä»¶ | è¯´æ˜ |
|------|------|------|
| `start_recording()` | `voice_service.py` | å¯åŠ¨å½•éŸ³ï¼ˆAudioå…ˆè¡Œï¼ŒASRç”±Gatewayæ§åˆ¶ï¼‰ |
| `_on_speech_start()` | `voice_service.py` | ASRå¯åŠ¨å›è°ƒï¼ˆç”±AudioASRGatewayè§¦å‘ï¼‰ |
| `_on_speech_end()` | `voice_service.py` | ASRåœæ­¢å›è°ƒï¼ˆç”±AudioASRGatewayè§¦å‘ï¼‰ |
| `_audio_callback()` | `audio_recorder.py` | éŸ³é¢‘é‡‡é›†å›è°ƒ |
| `_consume_audio()` | `audio_recorder.py` | éŸ³é¢‘æ¶ˆè´¹çº¿ç¨‹ |
| `process()` | `audio_asr_gateway.py` | å¤„ç†éŸ³é¢‘æ•°æ®ï¼ˆVADæ£€æµ‹/ç›´é€šï¼‰ |
| `start()` / `stop()` | `audio_asr_gateway.py` | Gatewayç”Ÿå‘½å‘¨æœŸç®¡ç† |
| `_on_audio_chunk()` | `voice_service.py` | éŸ³é¢‘æ•°æ®å—å¤„ç† |
| `send_audio_chunk()` | `volcano.py` | å‘é€éŸ³é¢‘åˆ°ASR |
| `_audio_sender()` | `volcano.py` | WebSocketå‘é€ä»»åŠ¡ |
| `_audio_receiver()` | `volcano.py` | WebSocketæ¥æ”¶ä»»åŠ¡ |
| `_handle_recognition_result()` | `volcano.py` | è¯†åˆ«ç»“æœå¤„ç† |

---

## æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

#### 1. éŸ³é¢‘è®¾å¤‡æ— æ³•æ‰“å¼€

**ç—‡çŠ¶**: å¯åŠ¨å½•éŸ³æ—¶æç¤º"éŸ³é¢‘è®¾å¤‡æ‰“å¼€å¤±è´¥"

**å¯èƒ½åŸå› **:
- éŸ³é¢‘è®¾å¤‡è¢«å…¶ä»–ç¨‹åºå ç”¨
- è®¾å¤‡ä¸æ”¯æŒå•å£°é“å½•éŸ³
- è®¾å¤‡IDé…ç½®é”™è¯¯

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥éŸ³é¢‘è®¾å¤‡è®¾ç½®
- å°è¯•æ›´æ¢éŸ³é¢‘è¾“å…¥è®¾å¤‡
- æ£€æŸ¥ç³»ç»ŸéŸ³é¢‘æƒé™

#### 2. WebSocket è¿æ¥å¤±è´¥

**ç—‡çŠ¶**: ASR æ— æ³•å¯åŠ¨ï¼Œæç¤º"è¿æ¥å¤±è´¥"

**å¯èƒ½åŸå› **:
- ç½‘ç»œè¿æ¥é—®é¢˜
- ASR é…ç½®é”™è¯¯ï¼ˆaccess_key/app_keyï¼‰
- è®¤è¯å¤±è´¥

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥ `config.yml` ä¸­çš„ ASR é…ç½®
- éªŒè¯ access_key å’Œ app_key æ˜¯å¦æ­£ç¡®
- æ£€æŸ¥ç½‘ç»œè¿æ¥

#### 3. éŸ³é¢‘æ•°æ®æœªå‘é€

**ç—‡çŠ¶**: å½•éŸ³æ­£å¸¸ï¼Œä½†æ²¡æœ‰è¯†åˆ«ç»“æœ

**å¯èƒ½åŸå› **:
- éŸ³é¢‘å›è°ƒæœªè®¾ç½®
- é˜Ÿåˆ—é˜»å¡
- WebSocket è¿æ¥æ–­å¼€

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥æ—¥å¿—ä¸­çš„éŸ³é¢‘å›è°ƒè®¾ç½®
- æ£€æŸ¥ WebSocket è¿æ¥çŠ¶æ€
- æŸ¥çœ‹æ˜¯å¦æœ‰é”™è¯¯æ—¥å¿—

#### 4. è¯†åˆ«ç»“æœå»¶è¿Ÿ

**ç—‡çŠ¶**: è¯†åˆ«ç»“æœè¿”å›è¾ƒæ…¢

**å¯èƒ½åŸå› **:
- ç½‘ç»œå»¶è¿Ÿ
- é˜Ÿåˆ—ç§¯å‹
- ASR æœåŠ¡è´Ÿè½½é«˜
- VADè¿‡æ»¤å¯¼è‡´çš„å»¶è¿Ÿï¼ˆå¦‚æœå¯ç”¨ï¼‰

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥ç½‘ç»œè¿æ¥è´¨é‡
- æŸ¥çœ‹é˜Ÿåˆ—å¤§å°
- æ£€æŸ¥ ASR æœåŠ¡çŠ¶æ€
- å¦‚æœå¯ç”¨VADï¼Œæ£€æŸ¥VADè¿‡æ»¤ç‡æ˜¯å¦æ­£å¸¸ï¼ˆæ­£å¸¸æƒ…å†µåº”è¿‡æ»¤40-60%çš„é™éŸ³ï¼‰

#### 5. VADè¿‡æ»¤å™¨ç›¸å…³é—®é¢˜

**ç—‡çŠ¶**: VADå¯ç”¨åæ²¡æœ‰è¯†åˆ«ç»“æœæˆ–è¯†åˆ«ä¸å®Œæ•´

**å¯èƒ½åŸå› **:
- VADæ•æ„Ÿåº¦è®¾ç½®ä¸å½“ï¼ˆmodeå‚æ•°ï¼‰
- è¯­éŸ³è¢«è¯¯åˆ¤ä¸ºé™éŸ³
- VADç¼“å†²åŒºé…ç½®é—®é¢˜

**è§£å†³æ–¹æ³•**:
- è°ƒæ•´VADæ•æ„Ÿåº¦ï¼ˆmodeå‚æ•°ï¼Œ0-3ï¼Œæ•°å­—è¶Šå¤§è¶Šæ•æ„Ÿï¼‰
- æ£€æŸ¥æ—¥å¿—ä¸­çš„VADç»Ÿè®¡ä¿¡æ¯ï¼ˆè¿‡æ»¤ç‡ã€è¯­éŸ³å¸§æ•°ç­‰ï¼‰
- å°è¯•ç¦ç”¨VADéªŒè¯æ˜¯å¦ä¸ºVADé—®é¢˜
- æ£€æŸ¥VADé…ç½®å‚æ•°ï¼ˆspeech_start_thresholdã€speech_end_thresholdç­‰ï¼‰

#### 6. ç¼“å†²åŒºæº¢å‡ºé—®é¢˜

**ç—‡çŠ¶**: é•¿æ—¶é—´å½•éŸ³åå†…å­˜å ç”¨è¿‡é«˜

**å¯èƒ½åŸå› **:
- å½•éŸ³æ—¶é—´è¶…è¿‡ç¼“å†²åŒºé™åˆ¶ï¼ˆé»˜è®¤60ç§’ï¼‰
- ç¼“å†²åŒºè‡ªåŠ¨æ¸…ç†æœºåˆ¶æœªæ­£å¸¸å·¥ä½œ

**è§£å†³æ–¹æ³•**:
- æ£€æŸ¥æ—¥å¿—ä¸­çš„ç¼“å†²åŒºæ¸…ç†è®°å½•
- æ ¹æ®éœ€è¦è°ƒæ•´ `audio.max_buffer_seconds` é…ç½®
- é¿å…è¶…é•¿æ—¶é—´è¿ç»­å½•éŸ³ï¼ˆå»ºè®®åˆ†æ®µå½•éŸ³ï¼‰

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
   - æŸ¥çœ‹ `config.yml` ä¸­çš„æ—¥å¿—çº§åˆ«è®¾ç½®
   - å…³æ³¨ `[éŸ³é¢‘]`ã€`[ASR-WS]`ã€`[è¯­éŸ³æœåŠ¡]` æ ‡ç­¾çš„æ—¥å¿—

2. **æ£€æŸ¥éŸ³é¢‘æ•°æ®æµ**
   - æŸ¥çœ‹éŸ³é¢‘å›è°ƒæ˜¯å¦è¢«è°ƒç”¨
   - æ£€æŸ¥éŸ³é¢‘é˜Ÿåˆ—æ˜¯å¦æ­£å¸¸
   - éªŒè¯éŸ³é¢‘æ•°æ®å¤§å°

3. **ç›‘æ§ WebSocket è¿æ¥**
   - æ£€æŸ¥è¿æ¥çŠ¶æ€
   - æŸ¥çœ‹å‘é€/æ¥æ”¶çš„æ¶ˆæ¯
   - éªŒè¯åè®®æ ¼å¼

4. **æ€§èƒ½åˆ†æ**
   - æµ‹é‡éŸ³é¢‘é‡‡é›†å»¶è¿Ÿ
   - æ£€æŸ¥é˜Ÿåˆ—ç§¯å‹æƒ…å†µ
   - åˆ†æç½‘ç»œä¼ è¾“æ—¶é—´

---

## æ€»ç»“

éŸ³é¢‘åˆ°ASRçš„æµç¨‹æ˜¯ä¸€ä¸ªå¤æ‚çš„å®æ—¶æµå¼å¤„ç†ç³»ç»Ÿï¼Œæ¶‰åŠï¼š

- **å¤šçº¿ç¨‹å¤„ç†**: éŸ³é¢‘é‡‡é›†çº¿ç¨‹ã€æ¶ˆè´¹çº¿ç¨‹
- **å¼‚æ­¥å¹¶å‘**: WebSocket å‘é€/æ¥æ”¶ä»»åŠ¡
- **é˜Ÿåˆ—ç¼“å†²**: è§£è€¦ä¸åŒå¤„ç†é˜¶æ®µ
- **çŠ¶æ€ç®¡ç†**: å½•éŸ³çŠ¶æ€ã€è¿æ¥çŠ¶æ€
- **é”™è¯¯å¤„ç†**: å„ç¯èŠ‚çš„é”™è¯¯å¤„ç†å’Œæ¢å¤

æ•´ä¸ªæµç¨‹è®¾è®¡ä¿è¯äº†ï¼š
- âœ… å®æ—¶æ€§ï¼šéŸ³é¢‘é‡‡é›†åç«‹å³å¤„ç†
- âœ… å¯é æ€§ï¼šé”™è¯¯å¤„ç†å’ŒçŠ¶æ€åŒæ­¥
- âœ… å¯æ‰©å±•æ€§ï¼šæ’ä»¶åŒ–æ¶æ„ï¼Œæ˜“äºæ›¿æ¢ASRæä¾›è€…
- âœ… æ€§èƒ½ï¼šå¼‚æ­¥å¹¶å‘ï¼Œä¸é˜»å¡ä¸»æµç¨‹

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.1  
**æœ€åæ›´æ–°**: 2026-01-03  
**ç»´æŠ¤è€…**: MindVoice å¼€å‘å›¢é˜Ÿ

**æ›´æ–°å†…å®¹** (v1.1):
- ä¿®æ­£VADè¿‡æ»¤å™¨é›†æˆæ–¹å¼å’Œä»£ç ç¤ºä¾‹
- æ›´æ–°start_recordingæ–¹æ³•çš„å¼‚æ­¥å¤„ç†ç»†èŠ‚
- è¡¥å……éŸ³é¢‘ç¼“å†²åŒºç®¡ç†è¯´æ˜
- æ›´æ–°å‰ç«¯WebSocketæ¶ˆæ¯å¤„ç†ä»£ç 
- ä¿®æ­£æµç¨‹æ­¥éª¤ç¼–å·å’Œæµç¨‹æ¦‚è§ˆ
- è¡¥å……æ›´å¤šæŠ€æœ¯ç»†èŠ‚å’Œä»£ç ç¤ºä¾‹

