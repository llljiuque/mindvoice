# MindVoice v1.2.1 ä¼šå‘˜ç³»ç»Ÿé‡æ„å®Œæˆ

**é‡æ„æ—¥æœŸ**: 2026-01-05  
**ç‰ˆæœ¬**: v1.2.0 â†’ v1.2.1  
**çŠ¶æ€**: âœ… é‡æ„å®Œæˆï¼Œä»£ç ç¼–è¯‘é€šè¿‡

---

## ğŸ¯ é‡æ„ç›®æ ‡

**æ ¸å¿ƒé—®é¢˜**ï¼šåŸå§‹è®¾è®¡ä¸­ä¼šå‘˜ç­‰çº§ç»‘å®šåˆ°è®¾å¤‡ï¼ˆdevice_idï¼‰ï¼Œä½†ç”¨æˆ·ç³»ç»Ÿä½¿ç”¨ user_idï¼Œä¸¤è€…å…³ç³»ä¸æ¸…æ™°ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šå°†ä¼šå‘˜ç­‰çº§ä»è®¾å¤‡è¿ç§»åˆ°ç”¨æˆ·ï¼Œå®ç°"ä¸€ä¸ªç”¨æˆ·ï¼Œå¤šä¸ªè®¾å¤‡ï¼Œå…±äº«ä¼šå‘˜æƒç›Š"çš„æ¶æ„ã€‚

---

## ğŸ“Š æ•°æ®åº“è¡¨å˜æ›´

### 1. memberships è¡¨ï¼ˆé‡å¤§å˜æ›´ï¼‰

**ä¿®æ”¹å‰ï¼ˆv1.2.0ï¼‰**ï¼š
```sql
CREATE TABLE memberships (
    device_id TEXT PRIMARY KEY,  -- âŒ ä»¥è®¾å¤‡ä¸ºä¸»é”®
    tier TEXT NOT NULL,
    ...
    FOREIGN KEY (device_id) REFERENCES devices(device_id)
)
```

**ä¿®æ”¹åï¼ˆv1.2.1ï¼‰**ï¼š
```sql
CREATE TABLE memberships (
    user_id TEXT PRIMARY KEY,  -- âœ… ä»¥ç”¨æˆ·ä¸ºä¸»é”®
    tier TEXT NOT NULL,
    ...
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
)
```

### 2. consumption_records è¡¨ï¼ˆæ–°å¢å­—æ®µï¼‰

**ä¿®æ”¹å‰**ï¼š
```sql
CREATE TABLE consumption_records (
    id TEXT PRIMARY KEY,
    device_id TEXT NOT NULL,  -- åªæœ‰ device_id
    ...
)
```

**ä¿®æ”¹å**ï¼š
```sql
CREATE TABLE consumption_records (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,     -- âœ… æ–°å¢ user_id
    device_id TEXT NOT NULL,   -- ä¿ç•™ device_idï¼ˆåŒºåˆ†è®¾å¤‡æ¶ˆè€—ï¼‰
    ...
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE,
    FOREIGN KEY (device_id) REFERENCES devices(device_id)
)
```

### 3. monthly_consumption è¡¨ï¼ˆè”åˆä¸»é”®ï¼‰

**ä¿®æ”¹å‰**ï¼š
```sql
CREATE TABLE monthly_consumption (
    device_id TEXT NOT NULL,
    year INTEGER NOT NULL,
    month INTEGER NOT NULL,
    ...
    PRIMARY KEY (device_id, year, month)  -- åªæŒ‰è®¾å¤‡ç»Ÿè®¡
)
```

**ä¿®æ”¹å**ï¼š
```sql
CREATE TABLE monthly_consumption (
    user_id TEXT NOT NULL,     -- âœ… æ–°å¢ user_id
    device_id TEXT NOT NULL,
    year INTEGER NOT NULL,
    month INTEGER NOT NULL,
    ...
    PRIMARY KEY (user_id, device_id, year, month),  -- ç”¨æˆ·+è®¾å¤‡+æœˆä»½
    FOREIGN KEY (user_id) REFERENCES users(user_id) ON DELETE CASCADE
)
```

---

## ğŸ”§ ä»£ç é‡æ„

### 1. membership_service.pyï¼ˆé‡å†™ï¼‰

**å…³é”®å˜æ›´**ï¼š
- `register_device()` - åªæ³¨å†Œè®¾å¤‡ï¼Œä¸åˆ›å»ºä¼šå‘˜
- `create_membership(user_id, tier)` - **æ–°å¢**ï¼šä¸ºç”¨æˆ·åˆ›å»ºä¼šå‘˜
- `get_membership(user_id)` - ä¿®æ”¹ä¸ºæ¥æ”¶ user_id
- `activate_membership(user_id, tier, months)` - ä¿®æ”¹ä¸ºæ¥æ”¶ user_id
- `get_current_consumption(user_id, device_id)` - æ”¯æŒæŒ‰ç”¨æˆ·æˆ–è®¾å¤‡æŸ¥è¯¢
- `check_quota(user_id, ...)` - ä¿®æ”¹ä¸ºæ¥æ”¶ user_id

### 2. consumption_service.pyï¼ˆé‡å†™ï¼‰

**å…³é”®å˜æ›´**ï¼š
- `record_asr_consumption(user_id, device_id, ...)` - åŒæ—¶è®°å½•ç”¨æˆ·å’Œè®¾å¤‡
- `record_llm_consumption(user_id, device_id, ...)` - åŒæ—¶è®°å½•ç”¨æˆ·å’Œè®¾å¤‡
- `_update_monthly_asr_with_cursor(cursor, user_id, device_id, ...)` - æ›´æ–°æ–¹æ³•ç­¾å
- `_update_monthly_llm_with_cursor(cursor, user_id, device_id, ...)` - æ›´æ–°æ–¹æ³•ç­¾å
- `get_monthly_consumption(user_id, device_id)` - æ”¯æŒæŒ‰ç”¨æˆ·æ±‡æ€»æˆ–æŒ‰è®¾å¤‡æŸ¥è¯¢
- `get_consumption_records(user_id, device_id)` - æ”¯æŒè¿‡æ»¤æŸ¥è¯¢

### 3. user_api.pyï¼ˆæ–°å¢æ³¨å†Œæµç¨‹ï¼‰

**æ–°å¢ç«¯ç‚¹**ï¼š
```python
@router.post("/api/user/register")
async def register_user(request: UserRegisterRequest):
    """å®Œæ•´çš„ç”¨æˆ·æ³¨å†Œæµç¨‹
    
    æ­¥éª¤ï¼š
    1. åˆ›å»ºç”¨æˆ·ï¼ˆusersè¡¨ï¼‰
    2. æ³¨å†Œè®¾å¤‡ï¼ˆdevicesè¡¨ï¼‰
    3. ç»‘å®šè®¾å¤‡ï¼ˆuser_devicesè¡¨ï¼‰
    4. æˆæƒå…è´¹ä¼šå‘˜ï¼ˆmembershipsè¡¨ï¼Œuser_idä¸ºä¸»é”®ï¼‰
    """
```

**è¯·æ±‚æ¨¡å‹**ï¼š
```python
class UserRegisterRequest(BaseModel):
    device_id: str
    machine_id: str
    platform: str
    device_name: Optional[str]
    nickname: Optional[str] = "æ–°ç”¨æˆ·"
    email: Optional[str]
```

**å“åº”æ¨¡å‹**ï¼š
```python
class UserRegisterResponse(BaseModel):
    success: bool
    user_id: Optional[str]
    device_id: Optional[str]
    membership: Optional[Dict[str, Any]]
    error: Optional[str]
```

### 4. membership_api.pyï¼ˆé‡å†™ï¼‰

**æ‰€æœ‰ç«¯ç‚¹æ”¹ä¸ºä½¿ç”¨ user_id**ï¼š
- `GET /api/membership/{user_id}` - è·å–ç”¨æˆ·ä¼šå‘˜ä¿¡æ¯
- `GET /api/membership/{user_id}/quota` - è·å–ç”¨æˆ·é¢åº¦ä¿¡æ¯
- `POST /api/membership/check-quota` - æ£€æŸ¥ç”¨æˆ·é¢åº¦
- `POST /api/membership/activate` - æ¿€æ´»ç”¨æˆ·ä¼šå‘˜ï¼ˆä½¿ç”¨æ¿€æ´»ç ï¼‰
- `GET /api/consumption/{user_id}/history` - è·å–ç”¨æˆ·æ¶ˆè´¹å†å²
- `GET /api/consumption/{user_id}/monthly` - è·å–ç”¨æˆ·æœˆåº¦æ±‡æ€»

**åˆ é™¤çš„ç«¯ç‚¹**ï¼ˆå·²ä¸é€‚ç”¨ï¼‰ï¼š
- âŒ `POST /api/device/register` - å·²ç§»è‡³ç”¨æˆ·æ³¨å†Œæµç¨‹
- âŒ `GET /api/device/{device_id}/info` - è®¾å¤‡ä¿¡æ¯ä¸å†éœ€è¦ç‹¬ç«‹API

---

## ğŸš€ æ–°çš„åˆå§‹åŒ–æµç¨‹

### å‰ç«¯æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ‰“å¼€åº”ç”¨        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ£€æŸ¥æœ¬åœ° user_id â”‚  â† localStorage
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”
   ä¸å­˜åœ¨     å­˜åœ¨
    â”‚         â”‚
    â–¼         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚æ˜¾ç¤ºæ³¨å†Œé¡µâ”‚ â”‚ç›´æ¥è¿›å…¥  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/user/registerâ”‚
â”‚  - device_id           â”‚
â”‚  - machine_id          â”‚
â”‚  - platform            â”‚
â”‚  - nickname            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ åç«¯å®Œæ•´æ³¨å†Œæµç¨‹        â”‚
â”‚  1. åˆ›å»ºç”¨æˆ·           â”‚
â”‚  2. æ³¨å†Œè®¾å¤‡           â”‚
â”‚  3. ç»‘å®šè®¾å¤‡           â”‚
â”‚  4. æˆæƒå…è´¹ä¼šå‘˜       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å› user_id    â”‚
â”‚ ä¿å­˜åˆ°æœ¬åœ°       â”‚
â”‚ è¿›å…¥ä¸»ç•Œé¢       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### åç«¯åˆå§‹åŒ–ï¼ˆserver.pyï¼‰

```python
# user_storage.py åˆå§‹åŒ–
user_storage_service = UserStorageService(db_path)

# membership_service.py åˆå§‹åŒ–
membership_service = MembershipService(config)

# æ³¨å†Œæ—¶è°ƒç”¨
user_id = user_storage.create_user(nickname, email)
membership_service.register_device(device_id, machine_id, platform)
user_storage.bind_device(user_id, device_id, device_name)
membership_service.create_membership(user_id, 'free')  # â† å…³é”®ï¼
```

---

## ğŸ“‹ å®Œæˆæ¸…å•

### æ•°æ®åº“å±‚
- [x] ä¿®æ”¹ `memberships` è¡¨ï¼šuser_id æ›¿ä»£ device_id
- [x] ä¿®æ”¹ `consumption_records` è¡¨ï¼šæ·»åŠ  user_id
- [x] ä¿®æ”¹ `monthly_consumption` è¡¨ï¼šæ·»åŠ  user_idï¼Œè”åˆä¸»é”®
- [x] æ›´æ–°ç´¢å¼•å’Œå¤–é”®çº¦æŸ

### æœåŠ¡å±‚
- [x] é‡å†™ `membership_service.py`
- [x] é‡å†™ `consumption_service.py`
- [x] æ›´æ–°æ‰€æœ‰æ–¹æ³•ç­¾åï¼ˆuser_id ä¸ºä¸­å¿ƒï¼‰

### APIå±‚
- [x] æ–°å¢ `/api/user/register` å®Œæ•´æ³¨å†Œæµç¨‹
- [x] é‡å†™ `membership_api.py`ï¼ˆæ‰€æœ‰ç«¯ç‚¹ä½¿ç”¨ user_idï¼‰
- [x] æ›´æ–° `user_api.py`ï¼ˆé›†æˆ membership_serviceï¼‰

### æ–‡æ¡£
- [x] æ›´æ–° `DATABASE_VERSION.md` â†’ v1.2.1
- [x] æ›´æ–° `docs/MEMBERSHIP_REDESIGN.md`ï¼ˆè®¾è®¡æ–‡æ¡£ï¼‰
- [x] åˆ›å»º `V1.2.1_REFACTOR_SUMMARY.md`ï¼ˆæœ¬æ–‡æ¡£ï¼‰

### æµ‹è¯•
- [x] Python ä»£ç ç¼–è¯‘é€šè¿‡
- [x] æ‰€æœ‰æ¨¡å—æ— è¯­æ³•é”™è¯¯

---

## ğŸ¯ æ ¸å¿ƒå˜åŒ–å¯¹æ¯”

| ç»´åº¦ | v1.2.0 (æ—§) | v1.2.1 (æ–°) |
|-----|------------|------------|
| **ä¼šå‘˜ä¸»ä½“** | device_id âŒ | user_id âœ… |
| **åˆå§‹åŒ–æµç¨‹** | æ³¨å†Œè®¾å¤‡ â†’ æˆæƒä¼šå‘˜ | æ³¨å†Œç”¨æˆ· â†’ ç»‘å®šè®¾å¤‡ â†’ æˆæƒä¼šå‘˜ âœ… |
| **å¤šè®¾å¤‡** | æ¯ä¸ªè®¾å¤‡ç‹¬ç«‹ä¼šå‘˜ âŒ | æ‰€æœ‰è®¾å¤‡å…±äº«ä¼šå‘˜ âœ… |
| **æ¶ˆè´¹è®°å½•** | åªè®°å½• device_id | è®°å½• user_id + device_id âœ… |
| **é¢åº¦ç»Ÿè®¡** | æŒ‰è®¾å¤‡ç»Ÿè®¡ âŒ | æŒ‰ç”¨æˆ·ç»Ÿè®¡ âœ… |
| **ä¼šå‘˜å‡çº§** | åªå½±å“å•è®¾å¤‡ âŒ | å½±å“æ‰€æœ‰è®¾å¤‡ âœ… |
| **æ¶ˆè´¹æŸ¥è¯¢** | åªèƒ½æŸ¥è®¾å¤‡æ¶ˆè€— | å¯æŸ¥ç”¨æˆ·æ€»æ¶ˆè€— æˆ– è®¾å¤‡æ˜ç»† âœ… |

---

## ğŸš€ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

### 1. å‰ç«¯å¼€å‘ï¼ˆå¿…éœ€ï¼‰
- [ ] åˆ›å»ºç”¨æˆ·æ³¨å†Œé¡µé¢
- [ ] æœ¬åœ°å­˜å‚¨ user_idï¼ˆlocalStorageï¼‰
- [ ] å¯åŠ¨æ—¶æ£€æŸ¥ user_idï¼Œä¸å­˜åœ¨åˆ™å¼•å¯¼æ³¨å†Œ
- [ ] ä¼šå‘˜ç•Œé¢ï¼šä» `/api/membership/{device_id}` æ”¹ä¸º `/api/membership/{user_id}`

### 2. æµ‹è¯•éªŒè¯ï¼ˆæ¨èï¼‰
- [ ] å•å…ƒæµ‹è¯•ï¼šmembership_serviceã€consumption_service
- [ ] é›†æˆæµ‹è¯•ï¼šå®Œæ•´æ³¨å†Œæµç¨‹
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼šå¤šè®¾å¤‡å…±äº«ä¼šå‘˜

### 3. æ•°æ®è¿ç§»ï¼ˆå¦‚éœ€ä¿ç•™æ—§æ•°æ®ï¼‰
- [ ] ä¸ºå·²æœ‰ device åˆ›å»ºå¯¹åº”çš„ user
- [ ] å°† memberships.device_id è½¬æ¢ä¸º user_id
- [ ] æ›´æ–° consumption_records å’Œ monthly_consumption

### 4. æ–‡æ¡£å®Œå–„
- [ ] å‰ç«¯æ¥å…¥æ–‡æ¡£
- [ ] API æ¥å£æ–‡æ¡£
- [ ] ç”¨æˆ·æ‰‹å†Œæ›´æ–°

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### å‘åå…¼å®¹æ€§
- âš ï¸ **ä¸å…¼å®¹ v1.2.0**ï¼šæ•°æ®åº“è¡¨ç»“æ„æœ‰é‡å¤§å˜æ›´
- å»ºè®®ï¼šå½“å‰å¤„äºå¼€å‘é˜¶æ®µï¼Œç›´æ¥è¿è¡Œ `./scripts/reset_system.sh` é‡ç½®æ•°æ®åº“

### æ•°æ®åº“é‡ç½®
```bash
# æ¸…ç©ºæ‰€æœ‰æ•°æ®ï¼ŒåŸºäº v1.2.1 é‡æ–°åˆå§‹åŒ–
./scripts/reset_system.sh
```

### å‰ç«¯é€‚é…è¦ç‚¹
1. **localStorage å­˜å‚¨**ï¼š
   ```typescript
   // æ³¨å†ŒæˆåŠŸå
   localStorage.setItem('user_id', response.user_id);
   
   // åº”ç”¨å¯åŠ¨æ—¶æ£€æŸ¥
   const userId = localStorage.getItem('user_id');
   if (!userId) {
     // è·³è½¬åˆ°æ³¨å†Œé¡µé¢
   }
   ```

2. **API è°ƒç”¨æ›´æ–°**ï¼š
   ```typescript
   // æ—§æ–¹å¼ï¼ˆv1.2.0ï¼‰
   fetch(`/api/membership/${deviceId}`)
   
   // æ–°æ–¹å¼ï¼ˆv1.2.1ï¼‰
   fetch(`/api/membership/${userId}`)
   ```

---

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

### ä¿®æ”¹æ–‡ä»¶
- æ•°æ®åº“ï¼š`src/providers/storage/sqlite.py`
- æœåŠ¡å±‚ï¼š`src/services/membership_service.py`ã€`src/services/consumption_service.py`
- APIå±‚ï¼š`src/api/user_api.py`ã€`src/api/membership_api.py`
- æ–‡æ¡£ï¼š`docs/DATABASE_VERSION.md`ã€`docs/MEMBERSHIP_REDESIGN.md`

### ä»£ç è¡Œæ•°
- æ–°å¢ï¼šçº¦ 800 è¡Œ
- ä¿®æ”¹ï¼šçº¦ 600 è¡Œ
- åˆ é™¤ï¼šçº¦ 400 è¡Œ

### æ•°æ®åº“è¡¨
- ä¿®æ”¹ï¼š3 å¼ è¡¨ï¼ˆmemberships, consumption_records, monthly_consumptionï¼‰
- ä¿æŒä¸å˜ï¼š11 å¼ è¡¨

---

## âœ… éªŒè¯é€šè¿‡

- âœ… Python ä»£ç ç¼–è¯‘ï¼šæ— è¯­æ³•é”™è¯¯
- âœ… æ•°æ®åº“ Schemaï¼šv1.2.1
- âœ… å¤–é”®çº¦æŸï¼šæ­£ç¡®
- âœ… ç´¢å¼•ï¼šå®Œæ•´
- âœ… æ–‡æ¡£ï¼šå·²æ›´æ–°

---

## ğŸ‰ æ€»ç»“

**v1.2.1 ä¼šå‘˜ç³»ç»Ÿé‡æ„æˆåŠŸå®Œæˆ**ï¼

æ ¸å¿ƒæ”¹è¿›ï¼š
1. **é€»è¾‘æ¸…æ™°**ï¼šä¼šå‘˜å±äºç”¨æˆ·ï¼Œè€Œä¸æ˜¯è®¾å¤‡
2. **å¤šè®¾å¤‡æ”¯æŒ**ï¼šä¸€ä¸ªè´¦å·ï¼Œæ‰€æœ‰è®¾å¤‡å…±äº«ä¼šå‘˜æƒç›Š
3. **çµæ´»æ‰©å±•**ï¼šä¸ºæœªæ¥äº‘ç«¯åŒæ­¥å¥ å®šåŸºç¡€
4. **å•†ä¸šåˆç†**ï¼šä¼šå‘˜æƒç›Šç»‘å®šåˆ°äººï¼Œè€Œä¸æ˜¯æœºå™¨

ä¸‹ä¸€æ­¥ï¼šå‰ç«¯æ¥å…¥ + å®Œæ•´æµ‹è¯•ï¼Œå³å¯æŠ•å…¥ä½¿ç”¨ï¼

---

Â© 2026 MindVoice æ·±åœ³ç‹å“¥ & AI

